{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/Async/BatchFlushCoordinator.cs:3",
  "vector": [
    -0.012894369,
    -0.002920638,
    0.005230757,
    0.0683164,
    -0.060608864,
    -0.016552482,
    -0.015277719,
    -0.021607762,
    0.055135511,
    0.015007013,
    0.043253537,
    -0.001685438,
    0.051121276,
    -0.033800527,
    -0.058281217,
    -0.01965056,
    0.04239241,
    -0.006591351,
    -0.047000386,
    0.002473851,
    -0.014921825,
    -0.093622983,
    -0.068383358,
    0.058225304,
    -0.046719573,
    0.00597557,
    0.035952535,
    0.037754711,
    0.011934209,
    0.027468883,
    -0.018162943,
    -0.065122634,
    -0.000358239,
    0.020793924,
    0.009838669,
    0.028678885,
    -0.033815704,
    -0.016459517,
    0.012627032,
    0.013598341,
    0.016556498,
    -0.008672348,
    0.032216381,
    -0.050953344,
    0.026399853,
    -0.038302254,
    0.046461646,
    -0.017718764,
    0.011239098,
    -0.038531665,
    -0.000465921,
    -0.014813576,
    0.003200459,
    0.002972625,
    0.000632312,
    -0.051552217,
    0.099941395,
    0.015580424,
    -0.066401996,
    0.03987696,
    0.008724731,
    0.010438577,
    -0.000991349,
    0.055036921,
    -0.036358077,
    -0.023398595,
    -0.016460894,
    0.016677584,
    -0.005248344,
    -0.060872622,
    -0.000122531,
    0.036233556,
    -0.041498587,
    -0.020575417,
    0.041660644,
    0.025359219,
    0.05169221,
    0.00303617,
    0.029937316,
    0.002836905,
    -0.040447123,
    -0.037393462,
    -0.005217028,
    -0.002300895,
    0.033053089,
    -0.03803245,
    0.006196498,
    -0.04186317,
    0.001193443,
    0.014157378,
    -0.00997404,
    0.008394793,
    0.043466326,
    0.014086383,
    0.012188991,
    0.008652014,
    0.044391565,
    -0.021696484,
    -0.004445714,
    -0.005840482,
    0.008299788,
    0.023985082,
    -0.020920003,
    0.049619038,
    -0.056466643,
    -0.02365212,
    -0.015495761,
    -0.068905048,
    0.016339209,
    0.043804899,
    0.032755803,
    0.032027151,
    -0.002051062,
    0.001004994,
    0.019303117,
    0.014734473,
    -0.008294647,
    -0.010003065,
    0.002802519,
    0.023719493,
    -0.060866643,
    0.053089902,
    -0.031581029,
    0.036994044,
    -0.045098461,
    0.064383171,
    0.041638933,
    0.050227776,
    0.027925445,
    -0.016510444,
    0.018561551,
    -0.01027615,
    -0.031389106,
    0.012973989,
    -0.021490274,
    0.053943098,
    0.053409006,
    0.039056282,
    -0.006209149,
    -0.034286052,
    0.015523747,
    -0.000998044,
    -0.015204134,
    0.037813712,
    0.010667925,
    0.060042098,
    0.027172744,
    -0.014254347,
    0.011831013,
    -0.061464451,
    -0.003684876,
    0.05572623,
    -0.026302315,
    0.002726049,
    0.011187316,
    0.009850184,
    -0.030243825,
    -0.02612857,
    -0.013616136,
    0.037442178,
    -0.031984106,
    0.029281352,
    0.004618373,
    0.032023683,
    -0.018942524,
    0.045811918,
    0.001173543,
    -0.024422521,
    0.083514296,
    -0.049217362,
    -0.022687139,
    0.021223441,
    -0.058316045,
    0.000651637,
    -0.031742956,
    0.028535262,
    -0.011326395,
    0.019433212,
    -0.053454444,
    -0.03818386,
    0.01153386,
    -0.019164504,
    -0.009350357,
    0.004470872,
    0.00889072,
    -0.048653092,
    0.013994021,
    -0.002851152,
    -0.012911505,
    -0.017023159,
    0.003965997,
    0.015677653,
    -0.008037593,
    -0.014485951,
    0.018426191,
    -0.007217064,
    -0.009848322,
    -0.008016437,
    -0.011518634,
    0.045700833,
    -0.062324148,
    0.039197683,
    -0.068787098,
    -0.037118357,
    -0.012799356,
    0.015621615,
    0.007769434,
    0.015966231,
    0.010093387,
    -0.002725906,
    -0.011724639,
    0.019199016,
    0.012976386,
    -0.001085704,
    0.046884116,
    0.000200576,
    -0.04568214,
    -0.016267581,
    -0.008680385,
    -0.001309436,
    -0.023422249,
    -0.006016504,
    0.070265412,
    0.065766908,
    0.004628295,
    -0.059110917,
    -0.032016464,
    -0.055422422,
    -0.015388659,
    -0.009069287,
    0.058064025,
    -0.024484832,
    0.000867215,
    -0.026273441,
    -0.040423051,
    0.061954003,
    -0.045070343,
    -0.040952191,
    -0.005310904,
    -0.004855749,
    -0.025321689,
    0.06170135,
    0.014008481,
    -0.016864354,
    -0.033420075,
    0.005734785,
    0.070084304,
    -0.00977774,
    -0.003782752,
    -0.005265696,
    -0.011460156,
    0.005657477,
    -0.033675775,
    0.097716399,
    0.057537526,
    0.013980455,
    0.00182164,
    0.02945907,
    0.042596027,
    0.020383209,
    0.008187344,
    0.022360155,
    -0.009383449,
    0.006670149,
    0.018940514,
    0.014229415,
    -0.044667453,
    -0.011221164,
    0.000640568,
    0.029785734,
    0.031643771,
    0.015660847,
    0.011789096,
    -0.030910101,
    0.004719614,
    -0.038903184,
    0.05534476,
    0.019811643,
    0.036190208,
    0.016736886,
    -0.043015201,
    -0.027485551,
    -0.003821149,
    -0.011380312,
    -0.049052235,
    0.012370504,
    -0.017545022,
    -0.008413769,
    0.013386163,
    0.001779494,
    0.00080992,
    -0.010586482,
    -0.014556099,
    0.011635979,
    0.025355009,
    0.0249236,
    0.030350491,
    -0.013416518,
    0.044279173,
    -0.005861057,
    -0.034951165,
    0.004585717,
    0.057204679,
    0.051101163,
    -0.011284227,
    0.005487769,
    0.010902506,
    -0.020953953,
    0.010036197,
    0.021827862,
    -0.064958826,
    -0.008112003,
    0.017710445,
    0.010003285,
    0.03912643,
    -0.061189529,
    -0.054576106,
    -0.001802913,
    -0.020908406,
    0.012386047,
    0.018307123,
    -0.013158552,
    0.046589747,
    -0.049549617,
    -0.009321657,
    0.015179908,
    -0.059607763,
    -0.046815891,
    0.00495598,
    -0.053959392,
    0.013722152,
    0.022486992,
    -0.051223885,
    0.027086644,
    0.015147564,
    0.017756199,
    -0.008699588,
    0.008214907,
    -0.03592933,
    0.011335796,
    -0.000112828,
    -0.010345591,
    0.040735744,
    -0.034376524,
    0.076656401,
    -0.022844149,
    -0.021628497,
    -0.030711411,
    -0.01207487,
    0.057013936,
    -0.021258719,
    -0.093351007,
    -0.007249042,
    0.011261036,
    -0.022795845,
    0.037301153,
    -0.035489786,
    0.01948504,
    0.015666004,
    0.003282695,
    0.049362708,
    -0.006602079,
    -0.044991463,
    -0.007926484,
    -7.877e-05,
    -0.006622149,
    -0.0141451,
    0.056881435,
    -0.038415514,
    0.037311267,
    -0.03813174,
    -0.081494302,
    -0.011984789,
    0.026867686,
    0.005963285,
    0.014835624,
    0.05406278,
    -0.023329616,
    0.04484015,
    -0.036832966,
    -0.017508391,
    0.019233732,
    -0.016550146,
    0.009462354,
    -0.000164844,
    -0.012443426,
    0.005036423,
    -0.002109759,
    -0.004323191,
    0.039372828,
    0.01115815,
    0.021435954,
    0.00470439,
    0.002201292,
    0.013320035,
    -0.023241039,
    -0.016362211,
    0.009072603,
    0.016640117,
    0.001446492,
    -0.002087585,
    -0.014725993,
    0.046458237,
    -0.059971388,
    0.022260502,
    0.014173356,
    0.018886199,
    0.021311389,
    -0.021540208,
    0.033068117,
    0.009512512,
    0.034671631,
    -0.010737967,
    0.039539915,
    0.00758045,
    0.036355305,
    -0.021430692,
    0.025833476,
    0.029574964,
    -0.005233707,
    -0.002540853,
    -0.013574654,
    -0.011501,
    -0.028403152,
    -0.025796365,
    -0.025036447,
    0.015982376,
    -0.074922256,
    -0.012876735,
    -0.005764838,
    0.007346042,
    -0.01057048,
    -0.045429368,
    0.006964189,
    0.034903351,
    0.004873021,
    0.038266808,
    -0.035446189,
    -0.033806808,
    -0.001672938,
    -0.0016104,
    -0.044880368,
    0.032624748,
    -0.024578212,
    0.014108839,
    -0.01987022,
    -0.016139574,
    0.062946282,
    -0.048482664,
    -0.038372621,
    -0.008530238,
    0.003988933,
    -0.052225828,
    0.030323369,
    0.019551272,
    -0.03083232,
    -0.048703324,
    0.020740625,
    0.004866066,
    -0.016829371,
    -0.036287453,
    -0.009045487,
    -0.008816976,
    0.004152411,
    -0.012395729,
    -0.005475002,
    0.012244865,
    -0.039215006,
    -0.0113453,
    -0.003164874,
    0.052303903,
    -0.028859854,
    0.000297944,
    0.014217295,
    0.034633655,
    0.036437072,
    0.005780976,
    0.054757092,
    0.003617114,
    0.002992146,
    -0.020083519,
    -0.020253088,
    -0.038519457,
    -0.035366252,
    -0.032417383,
    0.022982137,
    -0.044181563,
    0.066136353,
    0.058624346,
    -0.038183976,
    0.006297031,
    0.007479355,
    0.003760526,
    -0.007671234,
    0.008000046,
    9.1743e-05,
    -0.024762673,
    0.02323889,
    -0.0235309,
    0.015348228,
    0.041359782,
    -0.051936459,
    0.018970709,
    0.006434336,
    -0.028303867,
    0.052144505,
    -0.005780062,
    -0.000829126,
    -0.106902756,
    0.028877333,
    -0.031269304,
    -0.001658789,
    -0.023689637,
    0.047374669,
    0.0126899,
    -0.019588046,
    -0.012749235,
    -0.000624203,
    0.018098716,
    -0.008762843,
    0.01703136,
    0.045612667,
    -0.016475284,
    -0.097575143,
    0.014201583,
    -0.018771224,
    0.043119464,
    0.007039153,
    -0.01057705,
    -0.034617957,
    -0.016183332,
    0.041834157,
    -0.043283433,
    -0.032080062,
    0.010621225,
    -0.003554532,
    0.036022723,
    -0.018763913,
    0.009625187,
    -0.009763843,
    -0.002971624,
    -0.011878364,
    -0.028352367,
    -0.034194484,
    -0.015026008,
    0.023321765,
    0.020222774,
    0.065173462,
    0.000538064,
    -0.019606384,
    -0.005766521,
    0.025788616,
    0.064461291,
    0.038443323,
    -0.013570259,
    0.051251791,
    0.020476837,
    -4.7236e-05,
    0.057195622,
    -0.019918211,
    0.0286867,
    0.021848353,
    0.017081531,
    0.027149905,
    -0.02320536,
    -0.011771494,
    0.022177851,
    -0.016482476,
    0.001151658,
    -0.046679512,
    0.011610261,
    -0.013477911,
    -0.013378433,
    0.007973571,
    0.028749514,
    0.017114937,
    0.05453926,
    -0.048307177,
    -0.022587163,
    0.000503447,
    0.017342055,
    0.024034865,
    0.028605064,
    0.01434982,
    -0.053769402,
    -0.06256061,
    0.025906619,
    0.009380505,
    -0.022817234,
    -0.010619394,
    0.034854367,
    -0.011281291,
    0.006728528,
    -0.067968577,
    0.085895069,
    0.017249396,
    -0.025710052,
    0.004283065,
    -0.023767414,
    -0.042604137,
    0.016222417,
    -0.003259171,
    0.048599344,
    0.023396201,
    -0.014765791,
    -0.022830734,
    0.032756709,
    0.020130385,
    0.075649664,
    0.012570791,
    -0.000619718,
    -0.010390962,
    0.051455226,
    0.011017507,
    0.032711938,
    0.043581773,
    0.030252321,
    -0.033940159,
    0.026186388,
    0.035356861,
    -0.004328404,
    -0.050561108,
    0.018741043,
    0.009805122,
    0.004436067,
    -0.039563123,
    0.030555956,
    -0.034027595,
    -0.016205845,
    -0.000217118,
    0.027298156,
    0.029278791,
    -0.069919996,
    0.007661704,
    0.03410757,
    -0.007632973,
    0.028844919,
    0.006910283,
    0.00166035,
    -0.008825206,
    -0.02298787,
    -0.009899139,
    0.02505747,
    0.033758432,
    0.013196791,
    0.027854446,
    0.037495494,
    -0.065613635,
    -0.022114161,
    0.041498013,
    0.056757484,
    0.033560134,
    0.099660248,
    0.046645138,
    0.045557179,
    0.028075332,
    0.002113604,
    -0.03013188,
    -0.017194705,
    -0.014518605,
    0.005936586,
    -0.03061376,
    -0.031417027,
    0.029857693,
    0.035423346,
    -0.006968589,
    -0.047954556,
    0.026944263,
    -0.047275912,
    -0.002490944,
    -0.0355215,
    0.0298324,
    0.00381088,
    -0.028990285,
    -0.011664144,
    -0.003024987,
    -0.003724796,
    0.035506465,
    -0.007292703,
    -0.028391825,
    0.041113198,
    0.070981465,
    0.011220282,
    -0.010687243,
    -0.035632048,
    -0.021885205,
    -0.042502027,
    0.033316839,
    0.023986008,
    0.01412384,
    -0.005474316,
    -0.005534189,
    0.059985485,
    -0.050915457,
    0.007647167,
    0.0189371,
    -0.011196553,
    -0.009184426,
    -0.026667943,
    -0.063843101,
    0.018603496,
    0.040445406,
    0.01789467,
    -0.015692513,
    0.037172828,
    -0.01994459,
    -0.009425007,
    0.014703576,
    0.038681444,
    0.02074801,
    -0.003558249,
    -0.059850316,
    -0.001902649,
    0.039018705,
    0.012755499,
    -0.033461738,
    -0.03850022,
    -0.04087209,
    -0.018980941,
    -0.020248808,
    -0.026368905,
    -0.012877501,
    -0.054327324,
    -0.014387602,
    -0.005988446,
    -0.032938261,
    -0.014847299,
    -0.013317813,
    0.068817765,
    -0.020052282,
    -0.025440175,
    0.00952874,
    0.001677858,
    -0.001007389,
    -0.070472933,
    0.015251946,
    -0.047336649,
    0.00593431,
    -0.038353935,
    0.00389948,
    0.031063769,
    0.020719221,
    -0.019802779,
    0.006155848,
    -0.017450104,
    0.00336864,
    -0.007982387,
    0.048414823,
    0.007716185,
    -0.069007322,
    -0.007480567,
    -0.020671776,
    0.00860013,
    -0.027422141,
    0.04983126,
    -0.004749689,
    -0.009707729,
    0.064547211,
    -0.017609075,
    0.032506458,
    0.002025781,
    0.018323906,
    0.024693608,
    -0.024433495,
    -0.026983844,
    -0.035617206,
    0.020669527,
    0.007744664,
    -0.075747773,
    0.00124498,
    -0.0115065,
    -0.014465425,
    -0.013245611,
    0.00243028,
    -0.020849679,
    -0.049716208,
    0.016412318,
    0.022457177,
    -0.025090123,
    -0.010928607,
    0.006573133,
    0.012717683,
    0.022258641,
    -0.013329322,
    -0.013372601,
    0.031970181,
    -0.002108299,
    0.033511203,
    -0.040258918,
    -0.066880047,
    0.052909348,
    0.015991846,
    -0.011530873,
    0.012362938,
    -0.013435824,
    0.023960717,
    -0.077063829,
    -0.019224165,
    0.00850806,
    -0.028287698,
    -0.047324713,
    0.074057318,
    0.048399966,
    0.030693984,
    -0.036697462,
    -0.022883095,
    0.047488727,
    -0.033041533,
    0.020813206,
    0.006181282,
    0.037384447,
    -0.01735712,
    -0.033797286,
    -0.016833704,
    0.037578531,
    -0.030451063,
    -0.069037631,
    0.035810784,
    0.015659222,
    -0.012867586,
    0.004235266,
    -0.004702295,
    -0.014183532,
    -0.017376024,
    -0.033351608,
    0.0120187,
    -0.001059624,
    0.016806427,
    -0.022753039,
    -0.014744569,
    -0.019345889,
    0.039475579,
    0.003868747,
    -0.042933337,
    0.028650463,
    0.007773851,
    0.044479642,
    0.036297023,
    0.021287153,
    -0.050561603,
    -0.005339471,
    0.018694641,
    0.018334363,
    0.021467084,
    -0.042518456,
    -0.037829973,
    0.01930362,
    0.024112066,
    0.004748252,
    0.035261177,
    0.037495118,
    -0.00180297,
    -0.004690946,
    -0.012184097,
    -0.024112519,
    0.085462898,
    -0.02659996,
    0.027767662,
    -0.067893811,
    -0.026508026,
    0.068168774,
    0.027136747,
    -0.019056171,
    -0.015206215,
    -0.006335679,
    -0.029496845,
    0.011291479,
    -0.026619954,
    -0.045475025,
    -0.034440998,
    -0.00667446,
    0.019232677,
    -0.030098179,
    -0.032497879,
    0.032037187,
    -0.013401908,
    0.016149877,
    -0.021078922,
    -0.025240019,
    -0.01352977,
    -0.015499607,
    0.015726807,
    0.008058215,
    0.01686259,
    0.001867153,
    2.052e-06,
    -0.034165058,
    -0.056736954,
    -0.020866495,
    0.035183262,
    -0.035165228,
    -0.022507373,
    -0.022798322,
    0.021057475,
    0.019198777,
    0.011331297,
    0.011355177,
    -0.018380033,
    -0.008812195,
    0.030595457,
    -0.000519819,
    0.010096051,
    -0.043411363,
    0.017393248,
    0.039966505,
    -8.5324e-05,
    0.018811082,
    -0.015493885,
    0.033528574,
    0.027005326,
    0.010408148,
    -0.034242425,
    -0.002018539,
    -0.044322487,
    0.001072364,
    0.022096535,
    0.012350057,
    0.037625354,
    -0.009910831,
    -0.068319127,
    -0.008551567,
    -0.004661155,
    -0.01607432,
    0.012883014,
    0.004104196,
    -0.020097869,
    -0.077982083,
    -0.007211319,
    -0.000434573,
    0.031378634,
    -0.024988811,
    -0.009939368,
    -0.039136749,
    -0.020159073,
    0.003661775,
    -0.02765456,
    0.020835584,
    0.002101071,
    0.030067468,
    -0.01531542,
    0.009601301,
    -0.023887396,
    -0.022579607,
    -0.033359751,
    -0.065528274,
    0.033178017,
    -0.001997367,
    0.00583099,
    -0.006982463,
    -0.011200964,
    0.012884474,
    0.004534495,
    0.009847254,
    0.038871691,
    -0.001007935,
    0.03829575,
    0.017933888,
    -0.003981123,
    -0.025733534,
    -0.01050446,
    0.010434303,
    0.003430874,
    0.029949924,
    0.038385328,
    0.039295666,
    -0.029684907,
    0.038491633,
    0.002832962,
    -0.019165041,
    0.021668384,
    -0.001911219,
    -0.011794541,
    -0.051489204,
    -0.025329839,
    -0.026378265,
    0.001307306,
    0.01971294,
    0.00120141,
    -0.047722235,
    -0.00636302,
    0.008357601,
    0.017376104,
    0.037013158,
    -0.031371862,
    0.008883435,
    -0.066640422,
    -0.027497364,
    0.020735789,
    -0.058421534,
    -0.017866785,
    -0.038935553,
    0.031088218,
    0.015762974,
    0.008176223,
    -0.000219119,
    -0.00310204,
    -0.055068202,
    -0.024808394,
    -0.006580475,
    -0.01015567,
    0.033140365,
    0.026569411,
    0.025860816,
    0.004604531,
    -0.011430951,
    -0.02484205,
    0.038614132,
    -0.008585053,
    0.023417277,
    0.036916502,
    0.004857339,
    0.032500729,
    0.016963711,
    0.019165009,
    0.013757301,
    -0.023915363,
    0.042056184,
    -0.035681635,
    0.007338815,
    -0.013504419,
    -0.007402093,
    -0.060368754,
    0.017924275,
    -0.058105137
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/Async/BatchFlushCoordinator.cs",
    "chunk_index": 3,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "tern for continuous failure handling\n     /// </summary>\n     private async Task PerformFlushOperationAsync(List<FlushRequest> requests, CancellationToken cancellationToken)\n     {\n+        // CRITICAL FIX: Check circuit breaker before attempting flush operations\n+        if (ShouldBypassCircuitBreaker())\n+        {\n+            throw new InvalidOperationException($\"Circuit breaker is open due to {_consecutiveFailures} consecutive failures. \" +\n+                $\"Operations are temporarily disabled until {_lastFailureTime.Add(CircuitBreakerTimeout)}\");\n+        }\n+\n         foreach (var request in requests)\n         {\n             // Verify file exists before attempting flush\n             if (!File.Exists(request.FilePath))\n             {\n+                RecordFlushFailure();\n                 throw new FileNotFoundException($\"File not found: {request.FilePath}\");\n             }\n \n+            // CRITICAL FIX: Add timeout and retry logic for flush operations\n+            await PerformFlushWithTimeoutAndRetryAsync(request, cancellationToken).ConfigureAwait(false);\n+        }\n+    }\n+\n+    /// <summary>\n+    /// Performs flush operation with timeout and retry logic for resilience\n+    /// </summary>\n+    private async Task PerformFlushWithTimeoutAndRetryAsync(FlushRequest request, CancellationToken cancellationToken)\n+    {\n+        var attempts = 0;\n+        var maxAttempts = _config.MaxRetryAttempts + 1; // Include initial attempt\n+        Exception? lastException = null;\n+\n+        while (attempts < maxAttempts)\n+        {\n+            attempts++;\n+            \n             try\n             {\n-                // Perform the actual flush operation\n-                // This replaces the individual WriteTextWithFlushAsync calls\n+                // Create timeout cancellation token for this operation\n+                using var timeoutCts = CancellationTokenSource.CreateLinkedTokenSource(cancellationToken);\n+                timeoutCts.CancelAfter(_config.FlushTimeoutMs);\n+\n+                // CRITICAL FIX: Proper resource management for FileStream operations with timeout\n                 using var fileStream = new FileStream(request.FilePath, FileMode.Open, FileAccess.ReadWrite, FileShare.Read);\n-                await fileStream.FlushAsync(cancellationToken).ConfigureAwait(false);\n                 \n-                // Force OS buffer flush for durability\n+                try\n+                {\n+                    // Attempt async flush first with timeout\n+                    await fileStream.FlushAsync(timeoutCts.Token).ConfigureAwait(false);\n+                }\n+                catch (Exception flushAsyncEx) when (!(flushAsyncEx is OperationCanceledException))\n+                {\n+                    // If async flush fails, still attempt synchronous flush for durability\n+                    try\n+                    {\n+                        fileStream.Flush(flushToDisk: true);\n+                    }\n+                    catch (Exception flushSyncEx)\n+                    {\n+                        // Both flush methods failed - this is a critical error\n+                        throw new AggregateException($\"Both FlushAsync and Flush failed for {request.FilePath}\", \n+                            flushAsyncEx, flushSyncEx);\n+                    }\n+                    \n+                    // Async failed but sync succeeded - still throw to indicate partial failure\n+                    throw new IOException($\"FlushAsync failed but synchronous flush succeeded for {request.FilePath}: {flushAsyncEx.Message}\", flushAsyncEx);\n+                }\n+                \n+                // Both flushes succeeded - force OS buffer flush for guaranteed durability\n                 fileStream.Flush(flushToDisk: true);\n+                \n+                // Success! Record for circuit breaker and return\n+                RecordFlushSuccess();\n+                return;\n+            }\n+            catch (OperationCanceledException) when (cancellationToken.IsCancellationRequested)\n+            {\n+                // Main cancellation token was cancelled"
}