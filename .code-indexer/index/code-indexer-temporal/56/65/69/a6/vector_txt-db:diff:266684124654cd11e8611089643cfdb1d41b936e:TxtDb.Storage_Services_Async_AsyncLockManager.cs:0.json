{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/Async/AsyncLockManager.cs:0",
  "vector": [
    0.025153462,
    0.020628119,
    -0.0290084,
    0.027173599,
    -0.02123821,
    -0.018795293,
    -0.017868413,
    -0.025927994,
    0.020469485,
    0.00641523,
    -0.010993306,
    -0.002212981,
    0.074050859,
    -0.019658493,
    -0.024731265,
    -0.061232764,
    0.048860375,
    0.032329265,
    -0.051757805,
    0.005393033,
    -0.049909659,
    -0.029821457,
    -0.04785534,
    0.021468999,
    -0.042489968,
    -0.005953945,
    0.023229584,
    0.045908909,
    -0.002154849,
    0.065941893,
    -0.024709156,
    -0.027389888,
    0.006274947,
    0.02604256,
    0.035449807,
    -0.018761791,
    -0.036802474,
    -0.000642906,
    -0.00726313,
    -0.004160177,
    0.046496321,
    -0.018889897,
    0.058774371,
    -0.03724964,
    0.038318083,
    -0.068229154,
    0.052913502,
    0.01435605,
    0.017929135,
    0.005073317,
    0.008402468,
    -0.02530585,
    0.019275628,
    0.035332538,
    0.00759652,
    -0.021238135,
    0.04906508,
    0.016779991,
    -0.079353429,
    0.046863455,
    -0.00238141,
    -0.002833209,
    0.026029302,
    -0.004287275,
    -0.037687182,
    -0.044545423,
    -0.051844969,
    0.046739183,
    -0.023411958,
    -0.056402769,
    0.014775852,
    0.048498053,
    0.007326804,
    0.036657616,
    0.001392761,
    0.044612311,
    0.046383224,
    0.007523569,
    0.02262322,
    -0.000940962,
    -0.034351647,
    -0.04924218,
    -0.008961878,
    0.002897506,
    0.057687763,
    0.010817518,
    0.041789308,
    -0.042448252,
    0.008203537,
    0.001715726,
    -0.012509428,
    -0.006742392,
    0.025798574,
    0.045886427,
    0.01645698,
    0.006230503,
    0.052934613,
    0.038814809,
    0.007903688,
    -0.021673059,
    0.007939208,
    0.008607594,
    -0.055579282,
    0.038047753,
    -0.057585008,
    0.033168122,
    -0.000952198,
    -0.008986153,
    0.009894285,
    0.01452148,
    0.050314873,
    0.022893367,
    0.001194111,
    0.019903407,
    0.022451576,
    0.010304802,
    -0.017482823,
    -0.007508519,
    -0.001099027,
    0.036673635,
    -0.010587838,
    0.05301325,
    -0.053011671,
    0.049761012,
    -0.021095727,
    0.069914378,
    0.007036564,
    0.028535251,
    -0.004061392,
    -0.023211671,
    0.019105997,
    -0.006008483,
    -0.001261245,
    -0.004339532,
    0.02402327,
    0.04508673,
    0.023325555,
    0.033059388,
    -0.003257593,
    -0.033449292,
    0.027505646,
    -0.014136564,
    -0.015751269,
    0.015186212,
    0.014795747,
    0.004970755,
    0.033658031,
    -0.009900567,
    0.003273871,
    -0.060636673,
    0.006529338,
    0.051243104,
    -0.024760148,
    0.028935716,
    0.000251097,
    0.028900586,
    -0.026812596,
    -0.06281434,
    -0.019061411,
    0.009631536,
    -0.037070367,
    0.050667897,
    0.017039431,
    0.027295383,
    -0.003099314,
    0.080213718,
    0.002465462,
    0.01232106,
    0.021001751,
    -0.015351309,
    -0.02561884,
    0.017906571,
    -0.029769782,
    -0.016726362,
    0.015500942,
    0.036242899,
    -0.002883022,
    0.008155028,
    -0.059025276,
    -0.011088078,
    0.036888368,
    -0.002449156,
    -0.009432812,
    -0.018240375,
    0.01028326,
    -0.009283721,
    0.031395335,
    0.008299867,
    -0.024859183,
    -0.000418881,
    -0.016834136,
    -0.023182021,
    -0.041543521,
    -0.025226725,
    -0.014110728,
    -0.02775754,
    -0.025584161,
    0.001586545,
    0.023122376,
    -0.003156907,
    -0.037411232,
    0.004471996,
    -0.02675337,
    -0.023771511,
    0.013148729,
    0.034972172,
    -0.030907888,
    -0.018447567,
    0.010871371,
    0.010192535,
    -0.000145088,
    -0.00404103,
    0.028675046,
    0.009680566,
    -0.002258407,
    -0.017206948,
    -0.011358742,
    0.003250319,
    0.038094923,
    0.016562715,
    0.002653197,
    -0.010347784,
    0.090840198,
    0.016687745,
    -0.063375756,
    -0.0596903,
    -0.034396779,
    -0.056651209,
    0.001681031,
    0.003412388,
    -0.007966367,
    -0.07530117,
    0.035386186,
    -0.043629628,
    -0.074724615,
    0.021668119,
    -0.001554814,
    -0.008805688,
    0.027937587,
    -0.026655447,
    -0.023877725,
    0.02345393,
    0.0165092,
    0.007367216,
    -0.040359613,
    -0.012718952,
    0.035315167,
    0.011327069,
    0.037278332,
    0.0001481,
    -0.017508583,
    0.021007307,
    -0.025430631,
    0.064215027,
    0.024799105,
    -0.007800126,
    0.011096889,
    -0.000202141,
    0.021651596,
    0.004410613,
    -0.005623164,
    0.031908128,
    -0.046330817,
    -0.018250722,
    -0.034579288,
    0.036492776,
    -0.045399874,
    -0.002560106,
    -0.004891401,
    0.053429015,
    0.058942489,
    0.004172455,
    0.038136609,
    0.003152589,
    0.030716937,
    -0.025695527,
    0.018069783,
    -0.002163172,
    0.015650721,
    0.011803066,
    -0.063963138,
    -0.04570033,
    0.006521522,
    -0.047541894,
    -0.05775233,
    -0.032922085,
    -0.025468435,
    -0.014954209,
    0.033992946,
    0.04957743,
    0.035712406,
    -0.024903648,
    -0.042696241,
    -0.019132167,
    0.040260591,
    0.02568878,
    0.033121265,
    0.008371113,
    0.010337397,
    -0.0534858,
    0.001420016,
    0.004018829,
    0.052854523,
    0.044060927,
    -0.00494592,
    -0.020196244,
    0.023105191,
    -0.020989366,
    0.016726963,
    -0.010158912,
    -0.068601556,
    0.006302904,
    0.009223104,
    -0.001240084,
    0.032944646,
    -0.074696019,
    -0.027110988,
    0.013697471,
    -0.018699931,
    0.010119302,
    0.023243656,
    -0.021044826,
    0.027542751,
    -0.049437497,
    0.021137755,
    -0.010249757,
    -0.069158234,
    -0.044874743,
    0.057745311,
    -0.056550868,
    -0.012557246,
    0.002127468,
    -0.000454925,
    0.018215828,
    -0.016872508,
    -0.001428358,
    -0.030980648,
    0.018597312,
    -0.041761599,
    0.032544415,
    -0.000270251,
    -0.027919453,
    0.035509106,
    -0.011167866,
    0.053974438,
    -0.017966732,
    0.027813496,
    0.00028191,
    -0.026317526,
    0.053599067,
    -0.011070929,
    -0.052716482,
    -0.035702307,
    0.00978838,
    -0.049300458,
    0.051605497,
    -0.030633174,
    0.001946396,
    0.000903949,
    0.046372037,
    0.001042583,
    0.01356546,
    -0.013533276,
    -0.023004912,
    -0.015702767,
    -0.00441055,
    -0.027380059,
    0.077440076,
    -0.041430496,
    -0.005787351,
    -0.038448934,
    -0.048305295,
    -0.056996588,
    0.033026773,
    -0.007416575,
    0.010495817,
    0.035404161,
    -0.014598357,
    -0.007993456,
    -0.026357388,
    -0.01439369,
    0.002996637,
    0.016292721,
    -0.004134687,
    -0.015089091,
    0.014575754,
    -0.000865164,
    -0.009716337,
    -0.026791507,
    0.043563377,
    0.029492589,
    -0.006221729,
    -0.030381035,
    0.011912385,
    -0.04899805,
    -0.023921501,
    0.028200625,
    0.020839071,
    0.034499083,
    -0.012972339,
    0.010927729,
    -0.026551584,
    0.042060126,
    -0.062759548,
    0.031197529,
    0.024781419,
    -0.003550145,
    0.010996998,
    -0.024749961,
    -0.004237324,
    -0.015419501,
    0.083848454,
    0.015359174,
    0.032991886,
    -0.03746447,
    0.064646944,
    -0.017536495,
    -0.006389588,
    0.012496059,
    -0.015154838,
    -0.020607265,
    -0.016304815,
    -0.009532575,
    -0.028039992,
    -0.011682261,
    0.01345992,
    0.016839128,
    -0.075049751,
    -0.00101845,
    0.00561967,
    -0.023649348,
    -0.019892927,
    -0.069094181,
    0.034885839,
    0.025133571,
    -0.028476302,
    0.000939209,
    0.009624906,
    -0.031501494,
    0.005924089,
    -0.02762953,
    -0.030010782,
    0.061734602,
    -0.043507818,
    0.004635656,
    -0.02260837,
    0.030608604,
    0.023740144,
    -0.028450018,
    -0.017293401,
    -0.050503351,
    0.032566387,
    -0.042486928,
    -0.017068904,
    0.06394469,
    -0.025898561,
    -0.012359566,
    0.019974608,
    -0.022926835,
    -0.010632381,
    -0.020120407,
    -0.014349913,
    0.047706228,
    0.013454774,
    -0.015400392,
    0.023640992,
    0.018838419,
    -0.043048017,
    -0.043509249,
    0.00799075,
    0.043956306,
    -0.022274051,
    -0.020346969,
    -0.000247851,
    0.037693322,
    0.019599026,
    0.000610982,
    0.088063627,
    -0.026489638,
    -0.048265968,
    -0.028124981,
    -0.026056252,
    -0.020089962,
    -0.041392498,
    -0.042313106,
    0.059621934,
    0.002214536,
    -0.001565724,
    0.054457653,
    -0.043473694,
    -0.037864935,
    -0.00629578,
    -0.00366163,
    -0.037615392,
    0.027135838,
    0.036449682,
    0.016828407,
    0.006214738,
    -0.01571683,
    0.020200742,
    0.063276269,
    -0.078200199,
    0.016702089,
    -0.012608868,
    -0.03638095,
    0.02161878,
    -0.005299684,
    -0.022725439,
    -0.10893818,
    0.042876348,
    -0.024771277,
    -0.03733502,
    -0.017720891,
    0.019914387,
    0.017639767,
    -0.051209021,
    -0.054416738,
    0.01598038,
    -0.008711259,
    -0.001048838,
    0.003011073,
    0.004262569,
    -0.001282304,
    -0.052932046,
    0.033825342,
    0.004806768,
    0.015526639,
    0.003671534,
    -0.005480077,
    -0.043332245,
    -0.005270178,
    0.028147273,
    -0.017510965,
    -0.064733252,
    0.001448852,
    -0.024005361,
    0.016319105,
    0.004417469,
    0.013245978,
    0.014845594,
    -0.022258006,
    0.023374481,
    -0.003464497,
    -0.071160652,
    0.01507661,
    0.022645174,
    0.01556801,
    0.026092766,
    0.001197442,
    -0.027611177,
    -0.019560585,
    0.042078562,
    0.043480221,
    0.071161091,
    -0.022538461,
    0.047935765,
    0.02678117,
    -0.002439675,
    0.061766844,
    -0.014848202,
    -0.007168392,
    0.018718585,
    0.014718872,
    0.016095018,
    -0.023609329,
    0.021714836,
    0.031088876,
    0.011423036,
    -0.046673894,
    -0.011476438,
    0.00367004,
    -0.016609946,
    0.008148773,
    0.018526033,
    0.008264527,
    0.043101612,
    0.041146811,
    -0.052815624,
    -0.014130021,
    -0.004151374,
    0.007235107,
    -0.001301626,
    0.035729438,
    0.006340528,
    -0.022043638,
    -0.037165176,
    0.015766999,
    0.000339315,
    -0.015636979,
    0.000362999,
    0.033842631,
    -0.010498379,
    0.002239534,
    -0.042545572,
    0.075982139,
    0.007701969,
    0.006305412,
    0.022469811,
    0.013684965,
    -0.018317925,
    -0.001949401,
    0.028952448,
    0.076373518,
    0.001009809,
    0.022445884,
    -0.012663832,
    0.040324569,
    -0.006283592,
    0.05681055,
    0.052479386,
    0.005203657,
    0.026773008,
    0.059282139,
    -0.024615366,
    0.008343523,
    0.006259452,
    0.058132343,
    -0.070404314,
    -0.02876935,
    0.047485419,
    0.020038622,
    -0.048071314,
    -0.025483632,
    -0.033410918,
    0.001166388,
    -0.032940079,
    0.02068018,
    -0.03780758,
    0.008906771,
    0.015244663,
    -0.005847354,
    0.021201614,
    -0.058823045,
    0.018812206,
    0.015840078,
    0.000885107,
    0.014084117,
    -0.016957173,
    0.021359837,
    0.003681616,
    -0.005593772,
    -0.013357468,
    -0.011138543,
    0.023918724,
    0.041690271,
    -0.000588497,
    0.059144136,
    -0.018178392,
    -0.007003983,
    0.046909392,
    0.032409981,
    0.038320716,
    0.097743034,
    0.038435578,
    0.054522857,
    0.019726725,
    0.01388806,
    0.017817371,
    -0.020994164,
    0.008770984,
    -0.002623867,
    -0.032924343,
    -0.029088361,
    0.004713329,
    0.036384992,
    0.001959344,
    -0.02205951,
    0.036776341,
    -0.022825457,
    -0.027850477,
    -0.012752974,
    0.003900599,
    -0.037636943,
    -0.041787006,
    -0.024881758,
    0.004316524,
    0.022340262,
    0.010180078,
    -0.010534016,
    -0.006134354,
    0.01657835,
    0.0658907,
    -0.009755385,
    0.021761457,
    -0.058164943,
    -0.00785163,
    -0.042541198,
    0.000468352,
    -0.009622069,
    -0.003061661,
    0.003545422,
    -0.00584534,
    0.093575753,
    -0.078091934,
    -0.009221484,
    0.009011986,
    -0.002588538,
    -0.010039466,
    -0.000359436,
    -0.052189033,
    0.021112939,
    -0.003346686,
    -0.004792186,
    0.032664627,
    0.027061349,
    -0.03536652,
    0.002936898,
    -0.003982647,
    0.033485357,
    0.018623034,
    -0.024473542,
    -0.026292367,
    0.016739314,
    0.034792975,
    -0.004787884,
    0.008382773,
    -0.055747475,
    -0.021435177,
    -0.005613671,
    0.001762104,
    -0.022915596,
    -0.009216484,
    -0.036452688,
    -0.009928988,
    0.013520665,
    0.003101179,
    -0.006452494,
    0.008323762,
    0.062953651,
    -0.00285359,
    -0.052199982,
    0.013750517,
    0.042709447,
    0.009203928,
    -0.030400217,
    0.039521154,
    -0.032236896,
    -0.014507517,
    -0.019164233,
    0.020014584,
    0.028722141,
    0.031955153,
    -0.008421088,
    0.031907033,
    -0.001913815,
    0.001627068,
    -0.008799132,
    0.027152745,
    -0.021989394,
    -0.050669633,
    0.01585822,
    -0.005321871,
    -0.031789791,
    -0.061195895,
    0.038945183,
    -0.036459886,
    -0.059782572,
    0.050565314,
    0.01126792,
    0.068763025,
    -0.013977583,
    0.014408684,
    -0.003147004,
    -0.011175469,
    -0.035858303,
    -0.02866327,
    -0.015873918,
    0.002307625,
    -0.078688323,
    0.014811854,
    0.001163559,
    -0.033412982,
    -0.03060006,
    0.036335148,
    -0.019917818,
    0.012492218,
    0.045482382,
    0.029780978,
    0.012092755,
    0.006133635,
    -0.003646865,
    0.018833069,
    0.013640477,
    -0.038928706,
    -0.059643079,
    0.014340056,
    -0.002694202,
    0.006816495,
    -0.024885071,
    -0.054758094,
    0.054497376,
    -0.002147245,
    -0.024036344,
    0.036882162,
    0.020118343,
    0.024290459,
    -0.04489167,
    -0.037967049,
    0.015965672,
    0.016471142,
    -0.050808996,
    0.029252529,
    0.015742322,
    0.04291084,
    -0.004076559,
    -0.000377516,
    0.034299374,
    -0.021970551,
    0.036864065,
    0.007331462,
    0.025179604,
    -0.000192338,
    -0.05099206,
    -0.033179224,
    0.025783714,
    -0.055574477,
    -0.061074894,
    0.018216586,
    0.00853499,
    -0.012101193,
    -0.003093572,
    -0.00923795,
    0.039796423,
    0.021697531,
    -0.024562618,
    0.008667667,
    0.00139523,
    -0.003768549,
    0.005886708,
    -0.032931611,
    -0.021441469,
    0.029633746,
    0.003551396,
    -0.016684249,
    0.033555407,
    0.011112428,
    -0.007816064,
    0.052420571,
    0.031081935,
    -0.033635747,
    0.002977435,
    0.023854038,
    -0.012723344,
    0.02704075,
    -0.05217436,
    -0.040380403,
    -0.007484984,
    0.004622627,
    -0.029607886,
    0.045609575,
    -0.012056554,
    0.003530529,
    0.005076476,
    -0.026485365,
    -0.014085611,
    0.06978447,
    -0.004384025,
    0.058087751,
    -0.072369158,
    -0.011222012,
    0.042793579,
    0.02870496,
    -0.004814415,
    -0.007336424,
    -0.014931156,
    -0.016754292,
    0.024726989,
    -0.011273062,
    -0.058826789,
    -0.010406254,
    -0.053426448,
    0.016219117,
    -0.028641401,
    -0.004003392,
    -0.000858878,
    -0.013370878,
    0.05882585,
    -0.018115146,
    -0.036162067,
    0.005386228,
    -0.024865147,
    0.009908441,
    0.018811198,
    0.006040636,
    0.027086472,
    -0.007069533,
    0.00764379,
    -0.045910157,
    -0.013606926,
    0.040086567,
    -0.045013387,
    -0.006499524,
    -0.01125733,
    0.029367397,
    0.052644487,
    0.014581766,
    -0.012889894,
    0.002942298,
    -0.009877309,
    0.009559285,
    -0.021890722,
    -0.005690188,
    -0.039417792,
    0.01259951,
    0.036123987,
    0.004764869,
    0.006853478,
    0.032671776,
    0.053565685,
    0.043892607,
    0.008748546,
    0.002639643,
    -0.005292584,
    -0.06064814,
    -0.00899627,
    0.003263039,
    0.025980435,
    0.016725535,
    0.009298546,
    -0.04726785,
    -0.038925137,
    -0.025932021,
    -0.002374913,
    0.045426358,
    0.014552106,
    -0.005319867,
    -0.067857303,
    0.008936021,
    -0.031204073,
    0.008282479,
    -0.012745852,
    -0.002853699,
    -0.031689391,
    0.010633147,
    0.011319683,
    -0.019483162,
    -0.00107242,
    0.036755566,
    0.045661028,
    -0.034451582,
    0.02603869,
    -0.054885451,
    -0.051546641,
    -0.024232656,
    -0.032802757,
    0.012653229,
    0.000643479,
    -0.012872053,
    -0.025415346,
    -0.01791599,
    0.022579504,
    -0.068203188,
    0.015103364,
    0.0289934,
    0.042391784,
    -0.012637543,
    -0.045166362,
    -0.055931117,
    -0.044501565,
    0.005976318,
    0.018418919,
    -0.004140266,
    0.01259816,
    -0.010300594,
    0.024532311,
    -0.009323431,
    0.037654534,
    0.020026134,
    0.010011055,
    0.040109508,
    -0.014488854,
    0.015766084,
    -0.015682526,
    0.030049223,
    -0.056904905,
    -0.008766533,
    0.011533248,
    -0.01042444,
    -0.038980711,
    0.034110732,
    0.047702502,
    -0.001427539,
    0.056049969,
    0.008463085,
    0.011576887,
    -0.076526284,
    -0.063333802,
    0.007127146,
    -0.052258953,
    -0.022381678,
    -0.017952383,
    0.046121627,
    0.055013712,
    0.016404036,
    -0.00327264,
    0.008311177,
    -0.015453299,
    0.017153155,
    0.021721397,
    0.00780825,
    0.031210262,
    0.022204796,
    0.036445495,
    -0.018497311,
    -0.032478482,
    -0.029165395,
    0.029772589,
    0.015329305,
    0.04302346,
    0.016502498,
    0.010672889,
    0.026971914,
    0.027529912,
    0.039586004,
    0.002744599,
    -0.002308116,
    0.024059815,
    -0.040296674,
    -0.008831709,
    0.023039175,
    0.002098531,
    -0.032061011,
    0.039111666,
    -0.031425964
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/Async/AsyncLockManager.cs",
    "chunk_index": 0,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "@@ -1,21 +1,37 @@\n using System.Collections.Concurrent;\n \n namespace TxtDb.Storage.Services.Async;\n \n+/// <summary>\n+/// Thread-safe reference counting structure for lock management\n+/// CRITICAL FIX: Supports atomic operations to prevent race conditions\n+/// </summary>\n+internal class LockReferenceInfo\n+{\n+    public int Count;\n+\n+    public LockReferenceInfo(int initialCount)\n+    {\n+        Count = initialCount;\n+    }\n+}\n+\n /// <summary>\n /// Async Lock Manager for Performance Optimization\n /// Phase 1: Foundation - Replaces object locks with SemaphoreSlim for async-friendly locking\n /// CRITICAL: Prevents deadlocks while supporting async/await patterns\n /// </summary>\n public class AsyncLockManager : IDisposable\n {\n     private readonly ConcurrentDictionary<string, SemaphoreSlim> _locks = new();\n-    private readonly ConcurrentDictionary<string, int> _lockReferenceCounts = new();\n+    private readonly ConcurrentDictionary<string, LockReferenceInfo> _lockReferenceCounts = new();\n     private readonly object _lockCreationLock = new object();\n     private readonly ConcurrentBag<AsyncLockHandle> _activeLockHandles = new();\n-    private bool _disposed = false;\n+    private readonly TaskCompletionSource<bool> _disposalCompletionSource = new();\n+    private volatile bool _disposed = false;\n+    private volatile bool _disposing = false;\n \n     /// <summary>\n     /// Acquires an async lock for the specified key\n     /// </summary>\n     /// <param name=\"lockKey\">Unique identifier for the lock</param>\n@@ -24,11 +40,11 @@ public class AsyncLockManager : IDisposable\n     /// <returns>Disposable lock handle</returns>\n     /// <exception cref=\"TimeoutException\">Thrown when lock cannot be acquired within timeout</exception>\n     /// <exception cref=\"OperationCanceledException\">Thrown when operation is cancelled</exception>\n     public async Task<AsyncLockHandle> AcquireLockAsync(string lockKey, TimeSpan? timeout = null, CancellationToken cancellationToken = default)\n     {\n-        if (_disposed)\n+        if (_disposed || _disposing)\n             throw new ObjectDisposedException(nameof(AsyncLockManager));\n \n         var actualTimeout = timeout ?? Timeout.InfiniteTimeSpan;\n         var semaphore = GetOrCreateSemaphore(lockKey);\n \n@@ -65,11 +81,11 @@ public class AsyncLockManager : IDisposable\n                     throw new ObjectDisposedException(nameof(AsyncLockManager));\n                 }\n             }\n \n             // Double-check we weren't disposed while acquiring the lock\n-            if (_disposed)\n+            if (_disposed || _disposing)\n             {\n                 // Clean up - release the lock we just acquired\n                 try { semaphore.Release(); } catch { }\n                 throw new ObjectDisposedException(nameof(AsyncLockManager));\n             }\n@@ -92,72 +108,85 @@ public class AsyncLockManager : IDisposable\n     /// <summary>\n     /// Gets or creates a semaphore for the specified lock key\n     /// </summary>\n     private SemaphoreSlim GetOrCreateSemaphore(string lockKey)\n     {\n-        if (_disposed)\n+        if (_disposed || _disposing)\n             throw new ObjectDisposedException(nameof(AsyncLockManager));\n \n         // Double-checked locking pattern for thread-safe semaphore creation\n         if (_locks.TryGetValue(lockKey, out var existingSemaphore))\n         {\n             // CRITICAL FIX: Check if the semaphore was disposed during concurrent disposal\n-            if (_disposed)\n+            if (_disposed || _disposing)\n                 throw new ObjectDisposedException(nameof(AsyncLockManager));\n                 \n             IncrementLockReference(lockKey);\n             return existingSemaphore;\n         }\n \n         lock (_lockCreationLock)\n         {\n             // Double-check disposal status inside the lock\n-            if (_disposed)\n+            if (_disposed || _disposing)\n                 throw new ObjectDisposedException(nameof(AsyncLockManager));\n                 \n             if (_locks.TryGetValue(lockKey, out existingSemaphore))\n             {\n                 IncrementLockRefe"
}