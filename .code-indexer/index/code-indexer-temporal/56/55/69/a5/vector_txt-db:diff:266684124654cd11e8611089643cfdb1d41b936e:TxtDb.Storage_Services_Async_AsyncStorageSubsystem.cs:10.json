{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs:10",
  "vector": [
    0.004959574,
    -0.008800816,
    0.007076041,
    0.017078614,
    0.005346105,
    0.009821474,
    -0.023296202,
    -0.039505444,
    0.06289392,
    -0.005280814,
    0.021735219,
    -0.006289381,
    0.067713842,
    0.0037076,
    -0.074031711,
    -0.035208907,
    -0.000773929,
    -0.016799279,
    -0.038697794,
    0.013191235,
    0.003525001,
    -0.077776581,
    -0.065781817,
    0.048423044,
    -0.057800226,
    0.012508486,
    0.01458287,
    0.044185173,
    0.032131415,
    0.017443433,
    -0.021779543,
    -0.07616058,
    0.009249683,
    0.018161191,
    0.042788759,
    -0.017247489,
    -0.042031851,
    -0.012613351,
    -0.006200318,
    0.028031114,
    0.006811428,
    -0.033238441,
    0.045044202,
    -0.016468067,
    0.007179901,
    -0.014405997,
    0.013575603,
    0.006761423,
    -0.008688072,
    -0.002870058,
    -0.010073461,
    -0.004859144,
    -0.014812022,
    0.035977352,
    0.010089043,
    -0.084414378,
    0.096439525,
    0.005274121,
    -0.044739813,
    0.051592451,
    -0.031105809,
    0.007868714,
    -0.002537882,
    0.042674817,
    -0.042294063,
    -0.04382043,
    -0.052388359,
    0.061167579,
    0.026332485,
    -0.07337331,
    0.001761291,
    0.005899648,
    -0.01087544,
    0.030883411,
    0.022415578,
    0.028137639,
    0.045878112,
    0.008135128,
    0.046209164,
    0.018441318,
    -0.045493558,
    -0.039456315,
    0.015560891,
    -0.032777861,
    0.032031454,
    -0.027606396,
    0.018373791,
    -0.05925091,
    0.00722926,
    -0.016469117,
    -0.015011032,
    0.038805041,
    0.034784686,
    -0.011030248,
    0.011679458,
    0.020314664,
    0.019831007,
    0.011332491,
    0.016017564,
    -0.02558337,
    -0.011087036,
    0.007583565,
    -0.020304838,
    0.052508429,
    -0.05790966,
    -0.015492567,
    0.017357465,
    -0.044685286,
    -0.002348864,
    0.03843024,
    0.048351269,
    0.01703169,
    0.024769109,
    -0.01499793,
    -0.014973921,
    0.001025669,
    0.024459587,
    -0.01253668,
    0.013544693,
    0.039462909,
    -0.063014828,
    0.015796479,
    -0.064412653,
    0.073244892,
    -0.027321933,
    0.052240521,
    0.037593435,
    0.050342489,
    -0.001095938,
    -0.044247054,
    -0.007357985,
    -0.039255884,
    -0.004084924,
    0.009015332,
    -0.00279413,
    0.035138573,
    0.026273917,
    0.021981202,
    -0.010659194,
    -0.043602344,
    0.003304203,
    -0.006420327,
    -0.006557469,
    0.030604644,
    -0.011735552,
    0.011352256,
    0.02951997,
    -0.004403852,
    -0.013492243,
    -0.07047119,
    0.002179968,
    0.048444003,
    -0.023709234,
    -0.006439612,
    0.012157708,
    0.023843203,
    -0.03533547,
    -0.016240017,
    0.009969492,
    -0.025806956,
    -0.031829387,
    0.024756433,
    -0.008198312,
    0.010295433,
    -0.048174348,
    0.03413827,
    0.001435641,
    -0.00026996,
    0.039234344,
    -0.031692035,
    -0.059962578,
    0.023001082,
    -0.073014408,
    -0.007256017,
    -0.069741376,
    0.008410003,
    0.0387653,
    0.030345256,
    -0.082428984,
    -0.04573676,
    0.011943717,
    -0.001467373,
    -0.020467285,
    0.016058993,
    0.002748966,
    -0.020577786,
    0.046312366,
    0.015881555,
    0.021424359,
    -0.009943239,
    -0.041073348,
    0.000413504,
    -0.027878772,
    -0.01122114,
    0.010553507,
    -0.019495538,
    -0.01432187,
    0.001941466,
    0.021981999,
    0.050163403,
    -0.069878832,
    0.015773578,
    -0.081214048,
    0.013281796,
    -0.007415473,
    -0.004601825,
    -0.015265394,
    -0.043405797,
    -0.000845178,
    0.033127736,
    -0.011693501,
    0.012600494,
    0.003109576,
    -0.014496714,
    0.020297743,
    -0.001120555,
    -0.035115335,
    -0.006664332,
    0.052868798,
    -0.019215785,
    -0.01142581,
    -0.046388209,
    0.053160235,
    0.031045344,
    -0.017243197,
    -0.020062683,
    -0.060164418,
    -0.045630466,
    -0.031693459,
    -0.025150932,
    0.015560744,
    -0.043975826,
    0.01124334,
    -0.033705838,
    -0.064535327,
    0.060892954,
    -0.02383722,
    -0.007001874,
    -0.002712033,
    -0.006540854,
    -0.013020439,
    0.043967918,
    -0.009687612,
    -0.007232773,
    -0.022309951,
    0.005040715,
    0.054116629,
    0.027673556,
    -0.027137224,
    -0.00599391,
    -0.037742369,
    0.02609041,
    -0.043154601,
    0.122760892,
    0.060696404,
    0.000586127,
    -0.02836509,
    0.022580393,
    0.013718541,
    -0.00123652,
    0.009517713,
    0.005123531,
    -0.008078592,
    0.05888094,
    -0.00429493,
    0.015683876,
    -0.058194611,
    -0.05547427,
    0.003984129,
    0.032792572,
    0.014080469,
    0.018390175,
    0.028154947,
    0.028665548,
    -0.022751991,
    -0.032166667,
    0.023848383,
    0.029158399,
    0.019694552,
    0.02705737,
    -0.025203673,
    -0.014669939,
    0.009013442,
    -0.026895316,
    -0.030524176,
    -0.043019049,
    0.020069595,
    -0.019372648,
    0.034977466,
    0.010212577,
    0.003642067,
    -0.014842018,
    -0.005847339,
    -0.022980511,
    0.056647684,
    0.028908266,
    0.027947484,
    -0.022490568,
    0.028080683,
    -0.025528468,
    -0.028107602,
    -0.020360071,
    0.050487664,
    0.039203379,
    0.018028907,
    0.034745529,
    0.016936146,
    -0.020988354,
    0.016921915,
    -0.009723875,
    -0.063292533,
    -0.023245424,
    0.027604591,
    0.002878282,
    0.03893698,
    -0.073632553,
    -0.040928099,
    0.01570092,
    -0.021436624,
    -0.004357891,
    0.0069379,
    -0.014315085,
    0.031177582,
    -0.067366935,
    0.00744251,
    0.015361163,
    -0.06232607,
    -0.025680337,
    0.03822751,
    -0.021448757,
    -0.026919214,
    0.031825297,
    -0.018525744,
    0.049790654,
    -0.019097505,
    0.016062612,
    -0.036946326,
    0.001967386,
    -0.047430586,
    0.005051566,
    0.003981933,
    -0.029471144,
    0.032108188,
    -0.034110859,
    0.064171419,
    -0.010676263,
    0.010594383,
    -0.02562066,
    -0.015037331,
    0.060915548,
    0.003619554,
    -0.056715738,
    -0.015825616,
    0.006307384,
    -0.041419901,
    0.047518272,
    -0.022709407,
    0.002337371,
    0.001722245,
    0.013758915,
    0.022706117,
    0.048595846,
    -0.051344648,
    -0.023728549,
    -0.004209477,
    0.005894843,
    -0.02394598,
    0.064829603,
    -0.019513769,
    0.021888996,
    -0.075940914,
    -0.068686642,
    -0.049780518,
    0.018910941,
    0.001810434,
    0.037362929,
    0.035450261,
    -0.00116178,
    -0.012960379,
    -0.014514784,
    -0.000213705,
    0.020463055,
    -0.006736556,
    0.008529919,
    -0.028453263,
    -0.031526096,
    0.041521307,
    0.029236685,
    -0.019378467,
    0.022555312,
    -4.0004e-05,
    0.005270844,
    0.023819346,
    0.011096157,
    -0.007946619,
    -0.022555722,
    -0.01682907,
    0.034859825,
    0.00508684,
    -0.03187656,
    0.010812402,
    -0.022383822,
    0.036625408,
    -0.055457328,
    0.026744781,
    0.014173604,
    0.021123011,
    0.04029404,
    -0.01036065,
    0.036655191,
    0.002588905,
    0.01581908,
    -0.023335567,
    0.003521075,
    -0.035125911,
    0.037401207,
    -0.037164107,
    -0.024723949,
    0.02470679,
    -0.009704381,
    -0.02403345,
    -0.034249261,
    -0.021958647,
    -0.014278827,
    -0.029224172,
    0.009031528,
    -0.004423371,
    -0.064876683,
    -0.022935044,
    0.008303829,
    -0.002005513,
    -0.013217766,
    -0.033194184,
    0.009671165,
    0.03663215,
    -0.04491023,
    0.037548054,
    -0.006584429,
    -0.040456079,
    -0.050827172,
    0.009349846,
    -0.037695955,
    0.020426359,
    -0.011012357,
    -0.008083515,
    -0.043351412,
    -0.012166619,
    0.061660577,
    -0.052719131,
    -0.017427204,
    -0.040399447,
    -0.023441887,
    -0.038097117,
    0.006076673,
    0.053817637,
    -0.048008524,
    -0.022620898,
    0.039520942,
    0.004604776,
    -0.043302648,
    -0.06043563,
    -0.000602354,
    -0.019141637,
    0.003881355,
    -0.009941278,
    0.016119072,
    0.009546033,
    -0.047251858,
    0.010911144,
    0.003063856,
    0.03518451,
    -0.055424299,
    0.012036558,
    0.018168868,
    0.02653221,
    0.01732919,
    0.022469614,
    0.056527186,
    -0.03134298,
    -0.02302628,
    -0.0213753,
    -0.02444363,
    0.003493366,
    -0.05173878,
    0.007267438,
    0.008775396,
    -0.033317424,
    0.031595092,
    0.017252747,
    -0.030151691,
    -0.003904775,
    -0.012768243,
    -0.016164454,
    -0.003033702,
    0.004006914,
    -0.030798215,
    -0.029931694,
    -0.033271503,
    -0.034368206,
    0.027116945,
    0.021763898,
    -0.066157356,
    0.019069755,
    -0.033179026,
    -0.013328405,
    0.035532195,
    0.003761407,
    -0.033627488,
    -0.076263964,
    0.039947595,
    -0.015257468,
    -0.019316578,
    -0.014410402,
    0.022395853,
    0.020424889,
    -0.017142512,
    -0.015280979,
    0.044016432,
    0.020654088,
    -0.016383702,
    0.033953387,
    0.009800302,
    -0.013282276,
    -0.029976392,
    0.009401077,
    4.3625e-05,
    0.026300354,
    0.012548117,
    0.028373567,
    -0.033422217,
    -0.002749369,
    -0.001090032,
    -0.024139807,
    -0.035751309,
    0.042161454,
    -0.016502324,
    0.01492589,
    0.010388362,
    0.001838026,
    -0.019694002,
    -0.03881488,
    -0.003559251,
    -0.025173197,
    -0.05102637,
    0.038735557,
    -0.008316759,
    -0.001319683,
    0.021373194,
    -0.004520734,
    0.003939169,
    -0.003145524,
    0.053900313,
    0.019520732,
    0.064661682,
    -0.048097182,
    0.061516393,
    0.025781073,
    -0.026027167,
    0.055338502,
    -0.006206499,
    0.080378823,
    0.004973141,
    0.029636739,
    0.019588472,
    -0.048713602,
    0.018865695,
    0.037800476,
    0.004058454,
    -0.016696095,
    -0.035657868,
    0.011032669,
    -0.022223832,
    0.009947669,
    0.005001999,
    -0.020114547,
    0.047859278,
    0.056239899,
    -0.067076921,
    -0.017922591,
    -0.008988969,
    -0.007645671,
    -0.001253424,
    0.002965506,
    0.029816803,
    0.00851423,
    -0.072868392,
    0.040243126,
    -0.00930728,
    -0.034819257,
    -0.020742005,
    0.027456118,
    -0.008617685,
    0.019431928,
    -0.054536313,
    0.038918715,
    -0.001881999,
    -0.015353138,
    0.003128749,
    0.005972184,
    -0.04648675,
    -0.01960044,
    0.011876808,
    0.022798384,
    0.023110019,
    0.027189404,
    -0.043469518,
    0.029977042,
    -0.011365725,
    0.049617432,
    0.041995868,
    0.007792165,
    0.002607994,
    0.077287391,
    -0.01552576,
    0.037748545,
    0.012390958,
    0.010473724,
    -0.094795436,
    0.025657322,
    -0.002125275,
    0.038028646,
    -0.04024034,
    -0.005017062,
    0.010094049,
    0.003712907,
    -0.020201979,
    0.013608254,
    0.000764814,
    -0.009019879,
    0.01543495,
    -0.006942508,
    0.05811052,
    -0.049781512,
    0.022771731,
    0.016230645,
    0.000303133,
    0.016454,
    0.003458218,
    -0.017001444,
    0.005874548,
    0.004652261,
    0.00993877,
    0.022244116,
    0.027408881,
    0.058406945,
    0.041422907,
    0.057064369,
    -0.053076636,
    -0.027803982,
    0.073291816,
    0.021171685,
    0.019287875,
    0.068494968,
    0.050443873,
    0.03671978,
    0.018383807,
    0.021684775,
    -0.01928268,
    -0.012209998,
    0.006671239,
    -0.003316099,
    -0.045575626,
    0.002075484,
    0.041889247,
    0.039340276,
    -0.029503793,
    -0.026166776,
    0.013208242,
    -0.054719392,
    -0.003248001,
    -0.008490289,
    0.015603737,
    -0.025580293,
    -0.019115586,
    0.000253537,
    -0.015066342,
    0.008341469,
    0.019076705,
    -0.008737343,
    -0.006371353,
    -0.002331264,
    0.063520953,
    -0.002392627,
    -0.021452904,
    -0.057994325,
    0.003602248,
    -0.026490752,
    0.031877138,
    0.007800464,
    -0.017448785,
    0.001693957,
    -0.010173534,
    0.084004074,
    -0.017678794,
    0.007702499,
    0.004318375,
    0.031606108,
    -0.003470392,
    -0.047611844,
    -0.023901878,
    -0.016443662,
    0.023430461,
    -0.013182304,
    0.021499235,
    0.006806236,
    -0.019651035,
    -0.032692287,
    -0.027675956,
    0.085144214,
    -0.000117131,
    0.002118613,
    0.001029843,
    0.000251467,
    0.017460851,
    0.023145113,
    0.005709836,
    -0.037799917,
    -0.031091245,
    -0.030994343,
    0.042132422,
    0.037452988,
    0.009909991,
    -0.037618499,
    0.002142868,
    -0.015985155,
    -0.00342214,
    -0.006616355,
    0.004739799,
    0.07560233,
    -0.000448916,
    -0.02131597,
    0.013772541,
    0.011202441,
    0.028871806,
    -0.064376839,
    0.001525658,
    -0.050049294,
    0.031871088,
    -0.032803632,
    -0.004263469,
    0.028677328,
    0.010757891,
    -0.056773391,
    0.014831766,
    0.014075905,
    -0.014177615,
    -0.002399463,
    0.046094161,
    0.002425692,
    -0.080663539,
    -0.028636049,
    0.006810373,
    0.00298767,
    0.005805402,
    0.039086536,
    -0.001987871,
    -0.045006946,
    0.035209052,
    -0.023974061,
    0.041736882,
    -0.025488324,
    0.003976373,
    -0.003296251,
    -0.036648367,
    -0.007307741,
    -0.0267056,
    0.020822996,
    0.001923664,
    -0.071604103,
    0.00681471,
    -0.052223109,
    -0.008665558,
    -0.053021267,
    0.006311323,
    -0.016771603,
    -0.061789088,
    0.01288153,
    0.009134141,
    -0.038212817,
    0.011490698,
    -0.003216161,
    0.024523491,
    0.022426154,
    -0.015415718,
    -0.031189941,
    0.01111437,
    0.018704366,
    0.018491818,
    -0.033355955,
    -0.069666974,
    0.018452585,
    0.004556708,
    -0.019643283,
    0.045481142,
    0.010976573,
    0.008130282,
    -0.060488325,
    0.006068919,
    0.019074569,
    -0.029846111,
    -0.038358971,
    0.050411746,
    0.038536727,
    0.048601691,
    -0.022681512,
    -0.00454136,
    0.052498754,
    0.008118329,
    0.035819817,
    0.005661085,
    0.010959389,
    -0.009340609,
    -0.051798895,
    0.017864402,
    0.032347582,
    -0.035108726,
    -0.073620915,
    0.029198818,
    0.01809475,
    -0.021922441,
    0.010017652,
    0.033509921,
    0.005205008,
    0.01684903,
    -0.02306547,
    -0.003163281,
    -0.009791868,
    0.000589283,
    -0.012202499,
    0.011384757,
    -0.059404753,
    0.024750365,
    0.010069042,
    -0.035788208,
    0.037388183,
    -0.004669993,
    -0.021472031,
    0.036690675,
    -0.013920649,
    -0.044009309,
    7.1138e-05,
    0.007040725,
    0.027925324,
    0.003915339,
    -0.017995417,
    -0.086182371,
    0.007258154,
    0.008127552,
    -0.022708504,
    0.027143946,
    -0.001211279,
    -0.000519285,
    -0.036926825,
    -0.002585785,
    -0.038906481,
    0.054640114,
    0.004417175,
    0.047001839,
    -0.060506538,
    -0.015703412,
    0.054860603,
    -0.009227084,
    -0.010844149,
    -0.003732843,
    -0.032822616,
    -0.03470806,
    0.007298417,
    0.01227906,
    -0.024957037,
    -0.001114852,
    -0.007194973,
    0.009602801,
    -0.040941771,
    -0.000845729,
    0.051483434,
    -0.001710832,
    0.016936623,
    0.00115008,
    -0.031101679,
    0.007911125,
    -0.006725949,
    -0.0025239,
    0.025545623,
    0.021681415,
    0.033594832,
    -0.037706945,
    -0.015950656,
    -0.0398896,
    -0.029016385,
    0.043233309,
    -0.04773267,
    -0.00927511,
    -0.014879845,
    0.047037859,
    0.024992384,
    0.058940403,
    -0.007130454,
    -0.019153014,
    -0.016048362,
    0.028757969,
    0.014661766,
    0.033565927,
    -0.032435533,
    0.069142312,
    0.047229245,
    0.035535377,
    -0.005842261,
    0.013830729,
    0.00346063,
    0.044260629,
    0.002028872,
    -0.038275983,
    0.004546698,
    -0.021227831,
    -0.013967919,
    -0.004323625,
    0.030559253,
    0.03031824,
    0.012069801,
    -0.036295753,
    0.023667922,
    -0.00756636,
    4.1923e-05,
    0.010305313,
    0.012269896,
    0.003052799,
    -0.061153769,
    -0.026106022,
    -0.040631231,
    0.026440898,
    -0.032229114,
    -0.005642717,
    -0.010096896,
    0.012584448,
    -0.000574687,
    -0.009850409,
    0.013350111,
    0.044602662,
    0.031501275,
    -0.017383276,
    0.016569534,
    -0.013786836,
    -0.056068603,
    0.013046587,
    -0.042851236,
    0.002998388,
    -0.005792798,
    0.02039914,
    -2.036e-05,
    -0.027479371,
    -0.02339109,
    0.021154491,
    -0.009905753,
    0.030383665,
    0.030063028,
    0.016546059,
    -0.010164171,
    -0.002457301,
    -0.043259576,
    -0.019033214,
    0.00215171,
    -0.017325159,
    0.043757059,
    0.016555367,
    0.032505736,
    0.009989873,
    0.048845381,
    0.042498797,
    0.025113584,
    0.022316521,
    0.00171254,
    -0.01986916,
    -0.03906725,
    -0.016707968,
    -0.013293124,
    -0.013826414,
    0.012152259,
    0.013229633,
    -0.019921126,
    0.009994184,
    0.034350961,
    -0.005964102,
    0.04564821,
    -0.000782426,
    0.000568412,
    -0.042882457,
    -0.035431799,
    0.034395024,
    -0.044374105,
    -0.007158832,
    -0.029804232,
    0.003761693,
    0.00687066,
    0.013075805,
    0.01354813,
    0.001990781,
    -0.03519395,
    -0.032747414,
    0.011505427,
    -0.03052358,
    0.021015214,
    -0.026311865,
    0.008658222,
    0.033738956,
    0.023118144,
    -0.031248264,
    0.012559365,
    0.015286936,
    0.031025277,
    0.065588355,
    0.023584427,
    0.033841789,
    0.025452588,
    0.014239918,
    -0.024666455,
    0.01963323,
    0.04965961,
    -0.006365586,
    0.015906798,
    -0.009094709,
    -0.003638136,
    -0.03564648,
    0.026395751,
    -0.03687695
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs",
    "chunk_index": 10,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "lled during page read\", ex, cancellationToken);\n+        }\n     }\n     \n     private async Task WritePageVersionAsync(long transactionId, string namespaceName, string pageId, object[] content, CancellationToken cancellationToken)\n     {\n-        await Task.Run(async () =>\n+        try\n         {\n-            cancellationToken.ThrowIfCancellationRequested();\n-            \n-            var namespacePath = GetNamespacePath(namespaceName);\n-            var versionFile = Path.Combine(namespacePath, $\"{pageId}{_formatAdapter.FileExtension}.v{transactionId}\");\n-            var fullPageId = $\"{namespaceName}:{pageId}\";\n-            \n-            var serializedContent = _formatAdapter.SerializeArray(content);\n-            await File.WriteAllTextAsync(versionFile, serializedContent, cancellationToken).ConfigureAwait(false);\n-            \n-            if (_config.EnableBatchFlushing && _batchFlushCoordinator != null)\n+            await Task.Run(async () =>\n             {\n-                await _batchFlushCoordinator.QueueFlushAsync(versionFile, FlushPriority.Normal).ConfigureAwait(false);\n-            }\n-            else\n-            {\n-                await FlushToDiskAsync(versionFile, cancellationToken).ConfigureAwait(false);\n-            }\n-            \n-            // Update metadata\n-            lock (_metadataLock)\n-            {\n-                if (!_metadata.PageVersions.TryGetValue(fullPageId, out var pageInfo))\n+                cancellationToken.ThrowIfCancellationRequested();\n+                \n+                var namespacePath = GetNamespacePath(namespaceName);\n+                var versionFile = Path.Combine(namespacePath, $\"{pageId}{_formatAdapter.FileExtension}.v{transactionId}\");\n+                var fullPageId = $\"{namespaceName}:{pageId}\";\n+                \n+                // Check cancellation before serialization (CPU-intensive for large data)\n+                cancellationToken.ThrowIfCancellationRequested();\n+                var serializedContent = _formatAdapter.SerializeArray(content);\n+                \n+                // Check cancellation before file I/O\n+                cancellationToken.ThrowIfCancellationRequested();\n+                await File.WriteAllTextAsync(versionFile, serializedContent, cancellationToken).ConfigureAwait(false);\n+                \n+                // CRITICAL SECURITY FIX: Track the file path in the transaction for isolation-safe critical flushing\n+                if (_activeTransactions.TryGetValue(transactionId, out var transaction))\n                 {\n-                    pageInfo = new PageVersionInfo();\n-                    _metadata.PageVersions[fullPageId] = pageInfo;\n+                    transaction.WrittenFilePaths.Add(versionFile);\n                 }\n                 \n-                pageInfo.AddVersion(transactionId);\n-                MarkMetadataDirty();\n-            }\n-        }, cancellationToken).ConfigureAwait(false);\n+                if (_config.EnableBatchFlushing && _batchFlushCoordinator != null)\n+                {\n+                    await _batchFlushCoordinator.QueueFlushAsync(versionFile, FlushPriority.Normal).ConfigureAwait(false);\n+                }\n+                else\n+                {\n+                    await FlushToDiskAsync(versionFile, cancellationToken).ConfigureAwait(false);\n+                }\n+                \n+                // Update metadata\n+                lock (_metadataLock)\n+                {\n+                    cancellationToken.ThrowIfCancellationRequested();\n+                    if (!_metadata.PageVersions.TryGetValue(fullPageId, out var pageInfo))\n+                    {\n+                        pageInfo = new PageVersionInfo();\n+                        _metadata.PageVersions[fullPageId] = pageInfo;\n+                    }\n+                    \n+                    pageInfo.AddVersion(transactionId);\n+                    MarkMetadataDirty();\n+                    \n+                    // VERSION TRACKING: Maintain proper version metadata for concurrency control\n+                }\n+            }, cancellationToken).ConfigureAwait("
}