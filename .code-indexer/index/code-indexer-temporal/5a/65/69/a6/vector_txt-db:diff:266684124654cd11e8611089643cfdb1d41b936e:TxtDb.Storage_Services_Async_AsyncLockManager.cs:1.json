{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/Async/AsyncLockManager.cs:1",
  "vector": [
    0.066037826,
    0.004296076,
    -0.036849726,
    0.022834593,
    -0.018584656,
    -0.002585676,
    -0.006969973,
    -0.008633697,
    0.039509777,
    0.005957823,
    -0.015129447,
    0.000339975,
    0.071584575,
    -0.02770495,
    -0.002877227,
    -0.065673269,
    0.053840358,
    0.040775888,
    -0.058867257,
    0.011912786,
    -0.064367183,
    -0.059074458,
    -0.054453991,
    0.038102973,
    -0.029095571,
    0.005781412,
    0.028638044,
    0.051885307,
    -0.028351789,
    0.072732478,
    -0.021420697,
    -0.017919008,
    0.008361955,
    0.027453423,
    0.027588995,
    0.000323997,
    -0.024713786,
    -0.000915074,
    -0.006971451,
    -0.024960833,
    0.044275094,
    -0.004331372,
    0.072536878,
    -0.020352403,
    0.049383108,
    -0.081238657,
    0.039195936,
    0.020379059,
    0.003188347,
    0.01808707,
    0.006511932,
    -0.038741436,
    0.009247618,
    0.027785057,
    -0.00290941,
    -0.007102934,
    0.059209518,
    0.017146179,
    -0.08294028,
    0.022149127,
    0.0003069,
    4.7795e-05,
    0.003995131,
    0.009781545,
    -0.035843905,
    -0.029551266,
    -0.060541831,
    0.046207238,
    -0.023995029,
    -0.062858716,
    0.02545532,
    0.040769707,
    -0.005540085,
    0.019825943,
    -0.012401413,
    0.062142726,
    0.058738235,
    0.020784611,
    0.034585603,
    0.013577602,
    -0.059028052,
    -0.035531349,
    0.025824098,
    0.028774228,
    0.067347445,
    -0.001925533,
    0.030325199,
    -0.021905107,
    0.023293186,
    -0.00372839,
    -0.026601134,
    -0.008524212,
    0.005253928,
    0.055649254,
    0.025702413,
    0.003207294,
    0.046007842,
    0.047620401,
    0.022769373,
    -0.040096965,
    0.019560104,
    0.025558932,
    -0.054941665,
    0.03209221,
    -0.055586211,
    0.010246017,
    0.009079725,
    -0.026826441,
    0.019970227,
    0.014105241,
    0.059543733,
    0.011847966,
    -0.007247247,
    0.00887019,
    0.019558316,
    0.02055102,
    0.004119606,
    -0.002899933,
    -0.014978514,
    0.012564609,
    -0.026514331,
    0.061594993,
    -0.035706032,
    0.036525212,
    -0.035719052,
    0.042792965,
    0.0060816,
    0.014393991,
    -0.001360978,
    -0.032952104,
    0.007557386,
    -0.00452094,
    0.000213456,
    -0.005911022,
    0.040457018,
    0.042152651,
    0.032893885,
    0.035876438,
    0.002854316,
    -0.036063395,
    0.01796045,
    -0.015870469,
    -0.02527014,
    0.005904735,
    0.020151462,
    0.015749421,
    0.031627767,
    -0.02841945,
    -0.003521204,
    -0.043902561,
    0.00538523,
    0.049244434,
    -0.017263168,
    0.031165136,
    0.01060271,
    0.027214214,
    -0.020373609,
    -0.053473026,
    -0.031621005,
    0.023707703,
    -0.008800536,
    0.053460583,
    0.016381716,
    0.01866542,
    -0.023593087,
    0.084009133,
    0.016412511,
    0.015460982,
    0.033921838,
    -0.025443895,
    -0.031466365,
    0.008304083,
    -0.033020131,
    -0.004564031,
    -0.005462494,
    0.032780673,
    -0.004499458,
    0.000756467,
    -0.057250373,
    -0.001534804,
    0.029846348,
    -0.017212059,
    0.000236076,
    -0.042304818,
    0.007985799,
    -0.01744421,
    0.038709443,
    0.021144683,
    -0.021242751,
    0.003748629,
    -0.022383057,
    -0.004004374,
    -0.047005769,
    -0.008054221,
    -0.011999158,
    -0.020033127,
    -0.034425568,
    0.008001099,
    -0.008153319,
    -0.003419502,
    -0.04068473,
    0.012035195,
    -0.015897052,
    -0.017926207,
    0.003426912,
    0.037356224,
    -0.032670483,
    -0.009395476,
    -0.011734901,
    -0.014036231,
    0.018256743,
    0.017108005,
    0.007573542,
    0.012368887,
    0.004734785,
    -0.011357601,
    -0.021204311,
    -0.01040023,
    0.038671233,
    0.021281768,
    0.026876312,
    -0.004962051,
    0.070947453,
    0.010475058,
    -0.057325821,
    -0.055505577,
    -0.023220267,
    -0.051135723,
    0.013375463,
    -0.003801246,
    0.000387443,
    -0.083547562,
    0.053154331,
    -0.062045932,
    -0.054495011,
    0.015275805,
    -0.011916382,
    -0.004725904,
    0.016482882,
    -0.001663659,
    -0.013876238,
    0.013594356,
    0.033652682,
    0.000855352,
    -0.03634588,
    0.002958157,
    0.037067596,
    0.000883397,
    0.038533926,
    -0.002440829,
    -0.014760502,
    -7.8922e-05,
    -0.014911218,
    0.058770008,
    0.021732409,
    -0.012178957,
    0.018341435,
    -0.026367687,
    0.019493653,
    0.026415702,
    0.005219725,
    0.035864078,
    -0.025886366,
    -0.004108672,
    -0.014786885,
    0.03649414,
    -0.045950808,
    -0.002164658,
    -0.009171061,
    0.033950996,
    0.057106622,
    0.020356009,
    0.026697334,
    0.001477784,
    0.011538835,
    -0.023882823,
    0.019381927,
    -0.023350274,
    0.013956612,
    -0.0118033,
    -0.056863755,
    -0.048854906,
    0.001961046,
    -0.037618931,
    -0.060343593,
    -0.013667068,
    -0.018136533,
    -0.025583839,
    0.023218673,
    0.039528631,
    0.046075914,
    -0.013559618,
    -0.033409379,
    -0.020705258,
    0.033241462,
    0.047269888,
    0.056523763,
    0.011676131,
    0.020434437,
    -0.061355893,
    -0.010569116,
    0.001360065,
    0.038960729,
    0.045095254,
    -0.015609638,
    -0.027507994,
    0.010457401,
    -0.033722948,
    0.020004625,
    0.003350898,
    -0.060455494,
    -0.012456183,
    0.007209563,
    0.001201003,
    0.02554452,
    -0.057126407,
    -0.025206279,
    0.020818632,
    -0.032634396,
    0.031196456,
    0.040117413,
    -0.020388275,
    0.0104845,
    -0.039762951,
    0.0017204,
    0.002305597,
    -0.067714848,
    -0.051337659,
    0.072557308,
    -0.044586275,
    -0.016774915,
    0.00571781,
    -0.012434641,
    0.009595471,
    -0.016995287,
    0.009911804,
    -0.02858384,
    0.033158723,
    -0.046861384,
    0.030721033,
    0.002100607,
    -0.033319887,
    0.029771332,
    0.006316274,
    0.062888429,
    -0.006631265,
    0.031059898,
    0.003244668,
    -0.012363058,
    0.058096327,
    -0.008709087,
    -0.045751125,
    -0.025091663,
    0.006469328,
    -0.017459547,
    0.048634633,
    -0.038699642,
    -0.006612409,
    -0.002528097,
    0.032772198,
    -0.005451601,
    0.007601133,
    -0.015995294,
    -0.020689873,
    -0.028575122,
    -0.010092087,
    -0.020500014,
    0.072428472,
    -0.038782392,
    0.012612705,
    -0.02593701,
    -0.057731312,
    -0.074422196,
    0.023327239,
    0.010975907,
    0.012737462,
    0.053390786,
    0.001931745,
    0.015432559,
    -0.030906294,
    -0.019438114,
    -0.000758084,
    0.010895277,
    0.008178473,
    -0.009502747,
    0.017965883,
    -0.012323271,
    -0.008397409,
    -0.029271476,
    0.031516451,
    0.038819518,
    0.002990097,
    -0.017093422,
    0.002379884,
    -0.050288849,
    -0.027106715,
    0.021363916,
    0.019338194,
    0.022859385,
    0.009514013,
    0.010449459,
    -0.016709292,
    0.040206846,
    -0.068983398,
    0.021702653,
    -0.012910317,
    0.00049534,
    0.017284084,
    -0.020712085,
    -0.00150287,
    -0.000713591,
    0.074997924,
    0.010481697,
    0.042583711,
    -0.042422846,
    0.067065939,
    -0.027012439,
    -0.009060223,
    -0.012198035,
    -0.018355336,
    -0.003444932,
    -0.004160057,
    -0.020461591,
    -0.027714722,
    -0.008611858,
    0.015248783,
    0.036711778,
    -0.074644014,
    -0.000409615,
    0.010210603,
    -0.012861251,
    -0.039049339,
    -0.069445394,
    0.015630322,
    0.021049045,
    -0.042920131,
    -0.00551962,
    0.02653414,
    -0.015629847,
    0.010877755,
    -0.026764909,
    -0.020658037,
    0.069772527,
    -0.041019902,
    -0.005402929,
    -0.006657099,
    0.032971628,
    0.035162568,
    -0.018728307,
    -0.036509801,
    -0.056805473,
    0.051900323,
    -0.052242178,
    -0.001234503,
    0.054845721,
    -0.029234366,
    -0.012741681,
    0.043247953,
    -0.022209121,
    -0.00856533,
    -0.019958423,
    -0.003598857,
    0.036927309,
    0.013499609,
    -0.013573016,
    0.014487745,
    0.022042053,
    -0.029979352,
    -0.030649394,
    0.005111923,
    0.049944621,
    -0.015445068,
    -0.020293755,
    -0.00362162,
    0.028446758,
    -7.883e-06,
    0.000380126,
    0.089468114,
    -0.013615938,
    -0.036086719,
    -0.025853759,
    -0.013905758,
    -0.023402596,
    -0.05363851,
    -0.007198743,
    0.047320802,
    0.002372722,
    0.008939043,
    0.073050737,
    -0.035801824,
    -0.012743748,
    -0.003522067,
    -0.006141888,
    -0.025840541,
    0.018668301,
    0.01689769,
    0.035863124,
    -0.012407235,
    -0.012653904,
    0.001103034,
    0.049505841,
    -0.068581149,
    0.01581209,
    -0.00743485,
    -0.049386274,
    0.007105748,
    -0.015914148,
    -0.014863261,
    -0.087521076,
    0.025364045,
    -0.023704106,
    -0.028968075,
    -0.024766009,
    0.01756922,
    0.034346696,
    -0.054609813,
    -0.039204646,
    0.010518705,
    0.002367875,
    0.006235142,
    0.011284436,
    0.015365441,
    0.0047169,
    -0.060957603,
    0.026145454,
    -0.008951375,
    0.014724912,
    -0.029372036,
    -0.003535064,
    -0.051719658,
    0.018659584,
    0.034743782,
    -0.035415038,
    -0.046772316,
    -0.012638863,
    -0.021522712,
    0.0138938,
    0.008834741,
    0.015823908,
    0.023017643,
    -0.015854347,
    0.019388657,
    0.006046648,
    -0.075465269,
    0.016064258,
    0.021897256,
    0.021489576,
    0.034221236,
    0.017158544,
    -0.034612618,
    -0.0002874,
    0.023320351,
    0.047567137,
    0.058126166,
    -0.043340772,
    0.070852801,
    0.02069849,
    0.022368491,
    0.053544398,
    -0.013153653,
    -0.013055122,
    0.028708503,
    0.004156277,
    0.008897942,
    -0.025893781,
    0.019965714,
    0.024558984,
    0.02051004,
    -0.050119396,
    -0.020008927,
    -0.003900676,
    -0.014409633,
    0.002063641,
    0.008691587,
    0.015754329,
    0.049824681,
    0.033440564,
    -0.04424464,
    0.001888068,
    0.005487217,
    -0.005063733,
    -0.005755669,
    0.021544039,
    -0.010827662,
    -0.000179522,
    -0.02719572,
    0.003909309,
    -0.017428227,
    -0.016341582,
    0.001438348,
    0.024432322,
    0.004475235,
    0.007246004,
    -0.056636624,
    0.049947403,
    0.015611368,
    0.008617147,
    0.026161175,
    0.01176961,
    -0.012766046,
    -0.006935444,
    0.014346193,
    0.059529118,
    0.010565863,
    0.040682893,
    -0.025277968,
    0.034744468,
    0.013829941,
    0.057738692,
    0.042699434,
    0.018472278,
    0.012733438,
    0.074331202,
    -0.024544537,
    0.020877926,
    -0.00648331,
    0.037342712,
    -0.048057672,
    -0.031748645,
    0.048814565,
    0.013962345,
    -0.05612408,
    -0.02109414,
    -0.029282294,
    0.015900154,
    -0.040408097,
    0.0216437,
    -0.030612068,
    0.02364916,
    -0.006900855,
    -0.022058645,
    0.019199025,
    -0.06133721,
    -0.004769648,
    0.008362511,
    -0.022744652,
    0.017193465,
    -0.027412672,
    0.007535148,
    0.000777677,
    -0.002948757,
    -0.007606063,
    -0.022371829,
    0.028603971,
    0.047308449,
    0.000675695,
    0.040156443,
    -0.026020836,
    0.006960104,
    0.028496977,
    0.023925612,
    0.035003625,
    0.084789731,
    0.039373714,
    0.056940135,
    -0.003644449,
    0.014693303,
    0.006088085,
    0.011834239,
    0.019815812,
    -0.014978947,
    -0.042610068,
    -0.035175983,
    0.014890285,
    0.040693838,
    -0.005163091,
    -0.045637984,
    0.019503957,
    -0.024764681,
    -0.021659628,
    -0.010541954,
    0.009492726,
    -0.005835563,
    -0.047576956,
    -0.019181024,
    0.005817948,
    0.016573425,
    0.009925885,
    -0.000210907,
    0.005494825,
    0.012371578,
    0.071660019,
    -0.000557165,
    0.017557211,
    -0.036809776,
    -0.002960193,
    -0.049055986,
    -0.009853869,
    -0.001969268,
    -0.032348838,
    -0.0126581,
    -0.018042173,
    0.094299383,
    -0.061845284,
    0.002892672,
    0.024760449,
    0.004239621,
    -0.036539055,
    -0.005894254,
    -0.038409151,
    0.005933495,
    -0.012767872,
    -0.004997072,
    -0.0069121,
    0.010915324,
    -0.030832279,
    0.011334785,
    0.020542432,
    0.066855252,
    0.012873827,
    -0.038409717,
    -0.027887728,
    0.022335988,
    0.039796494,
    -0.006009645,
    0.019479021,
    -0.057687614,
    -0.013482607,
    -0.007454785,
    0.023435647,
    -0.044925567,
    -0.001645411,
    -0.038841359,
    -0.002871397,
    0.016047789,
    0.021662101,
    -0.025682773,
    0.023672998,
    0.067168884,
    -0.001901085,
    -0.050107341,
    0.02399504,
    0.044790775,
    -0.01298525,
    -0.0253252,
    0.041894164,
    -0.034051847,
    -0.001190525,
    -0.028114773,
    0.003351069,
    0.016315024,
    0.034465075,
    -0.002235643,
    0.02644686,
    0.007566516,
    -0.002288588,
    -0.017196238,
    0.021392599,
    -0.019002071,
    -0.055606589,
    0.018579459,
    -0.0070115,
    -0.01564938,
    -0.044705998,
    0.029206648,
    -0.034457266,
    -0.038616363,
    0.053696983,
    0.007279689,
    0.074109152,
    0.002192738,
    0.007477033,
    -0.002071087,
    -0.011288078,
    -0.053929914,
    -0.04478826,
    -0.016543671,
    0.024830271,
    -0.081837527,
    0.005339346,
    -0.000849203,
    -0.009034184,
    -0.029204709,
    0.038457334,
    -0.012308687,
    0.03077016,
    0.046440169,
    0.005909477,
    0.008174294,
    0.024838161,
    0.006756714,
    0.036399756,
    -0.005697808,
    -0.024330791,
    -0.048099596,
    0.001021615,
    0.000298563,
    0.023267044,
    -0.032288536,
    -0.058985062,
    0.047629792,
    0.019678289,
    -0.020917306,
    0.027365856,
    0.019965576,
    0.034894325,
    -0.046860717,
    -0.023365362,
    0.013604194,
    0.004827161,
    -0.041443724,
    0.024478436,
    0.025912022,
    0.049787942,
    -0.019397447,
    0.004243727,
    0.027310535,
    -0.004454528,
    0.044947293,
    0.008605986,
    0.026774269,
    0.010781522,
    -0.089619525,
    -0.025451263,
    0.036009993,
    -0.041758209,
    -0.064006746,
    -0.001768828,
    -8.627e-05,
    -0.020237785,
    0.007589438,
    -0.015639048,
    0.045896433,
    0.010139322,
    -0.021701066,
    0.012885029,
    0.015626505,
    -0.008081511,
    0.012353952,
    -0.048374243,
    -0.018876884,
    0.024184741,
    -0.00898696,
    -0.014886252,
    0.051167626,
    0.021981388,
    0.01209332,
    0.042374775,
    0.040899865,
    -0.045640737,
    -0.01121013,
    0.014406435,
    -0.010666939,
    0.043688253,
    -0.043952845,
    -0.027837051,
    0.00734648,
    0.002829127,
    -0.026933381,
    0.039091889,
    0.001614798,
    0.011366492,
    0.019903868,
    -0.015482171,
    0.002126625,
    0.06299407,
    -0.018836936,
    0.016241562,
    -0.086604603,
    -0.011941143,
    0.059630886,
    0.030895283,
    -0.010813394,
    -0.003780318,
    -0.000204159,
    -0.018534617,
    0.020736033,
    -0.036459312,
    -0.050533179,
    0.003559386,
    -0.048010975,
    -0.014907047,
    -0.020556599,
    -0.013904791,
    0.002304479,
    -0.015228189,
    0.064510323,
    -0.02395492,
    -0.020750483,
    0.010703871,
    -0.027386254,
    0.014896419,
    0.020497886,
    0.011478879,
    0.055411536,
    0.000563343,
    -0.025149237,
    -0.047243875,
    -0.018965151,
    0.023268763,
    -0.061604448,
    -0.011971056,
    0.011565676,
    0.03592965,
    0.062776119,
    0.017193265,
    0.001048058,
    -0.017284835,
    -0.025572769,
    0.01834047,
    -0.031906404,
    -0.006521142,
    -0.026875867,
    -0.007474877,
    0.031612698,
    0.010807417,
    -0.009828377,
    0.037469216,
    0.045587476,
    0.024849573,
    -0.019988019,
    0.000491948,
    -0.013267545,
    -0.044777039,
    -0.012231562,
    0.015265647,
    0.019146279,
    0.020302404,
    0.014065943,
    -0.032010183,
    -0.045610365,
    -0.02566885,
    0.022289224,
    0.06453418,
    0.015683264,
    0.014483642,
    -0.066929922,
    0.004720831,
    -0.008567311,
    0.033482883,
    -0.015583489,
    -0.024054404,
    -0.027342713,
    0.006805884,
    0.001825515,
    0.0031581,
    0.008533827,
    0.029127622,
    0.045398887,
    -0.017803516,
    0.005621039,
    -0.071638398,
    -0.057591908,
    -0.033849645,
    -0.030147502,
    0.016500322,
    -0.020410305,
    -0.023248088,
    -0.029863054,
    -0.011131134,
    0.03552169,
    -0.05098626,
    -0.005105636,
    0.014924007,
    0.031660937,
    -0.018249696,
    -0.014194937,
    -0.076409303,
    -0.037865467,
    0.027497686,
    0.026853781,
    -0.012615032,
    0.034399521,
    -0.019074332,
    0.025056178,
    -0.005846013,
    0.040154811,
    0.022748401,
    -0.006649173,
    0.037039816,
    -0.002391029,
    0.012201795,
    -0.019190477,
    0.023103334,
    -0.045895893,
    0.001012593,
    0.01820641,
    -0.005099137,
    -0.015078989,
    0.030367594,
    0.036544651,
    -0.01001139,
    0.068898939,
    0.010713627,
    0.004975142,
    -0.056239516,
    -0.062236555,
    0.006383104,
    -0.04816715,
    -0.018517878,
    -0.011071648,
    0.023116041,
    0.03661051,
    0.005931812,
    0.00628041,
    0.0191816,
    -0.030565755,
    0.027825508,
    0.003300875,
    0.000651299,
    0.032034859,
    0.037804659,
    0.047569126,
    -0.010460973,
    -0.02023997,
    -0.015347593,
    0.024074806,
    0.012606758,
    0.03225629,
    -5.2205e-05,
    0.007567346,
    0.030962102,
    0.0103156,
    0.041888688,
    0.033773623,
    -0.005074278,
    0.006009728,
    -0.052115861,
    0.006647811,
    0.028202349,
    -0.010350509,
    -0.026233375,
    0.046240523,
    -0.043945137
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/Async/AsyncLockManager.cs",
    "chunk_index": 1,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": " if (_disposed || _disposing)\n                 throw new ObjectDisposedException(nameof(AsyncLockManager));\n                 \n             IncrementLockReference(lockKey);\n             return existingSemaphore;\n         }\n \n         lock (_lockCreationLock)\n         {\n             // Double-check disposal status inside the lock\n-            if (_disposed)\n+            if (_disposed || _disposing)\n                 throw new ObjectDisposedException(nameof(AsyncLockManager));\n                 \n             if (_locks.TryGetValue(lockKey, out existingSemaphore))\n             {\n                 IncrementLockReference(lockKey);\n                 return existingSemaphore;\n             }\n \n             var newSemaphore = new SemaphoreSlim(1, 1); // Binary semaphore (mutex)\n             _locks[lockKey] = newSemaphore;\n-            _lockReferenceCounts[lockKey] = 1;\n+            _lockReferenceCounts[lockKey] = new LockReferenceInfo(1);\n             return newSemaphore;\n         }\n     }\n \n     /// <summary>\n-    /// Increments the reference count for a lock\n+    /// Increments the reference count for a lock using atomic operations\n     /// </summary>\n     private void IncrementLockReference(string lockKey)\n     {\n-        _lockReferenceCounts.AddOrUpdate(lockKey, 1, (key, count) => count + 1);\n+        _lockReferenceCounts.AddOrUpdate(\n+            lockKey, \n+            new LockReferenceInfo(1), \n+            (key, info) => \n+            {\n+                Interlocked.Increment(ref info.Count);\n+                return info;\n+            }\n+        );\n     }\n \n     /// <summary>\n     /// Decrements the reference count for a lock and removes it if no longer referenced\n+    /// Uses atomic operations to prevent race conditions\n     /// </summary>\n     private void DecrementLockReference(string lockKey)\n     {\n-        if (_lockReferenceCounts.TryGetValue(lockKey, out var count))\n+        if (_lockReferenceCounts.TryGetValue(lockKey, out var info))\n         {\n-            var newCount = count - 1;\n+            var newCount = Interlocked.Decrement(ref info.Count);\n             \n             if (newCount <= 0)\n             {\n-                // Remove the lock if no longer referenced\n-                if (_locks.TryRemove(lockKey, out var semaphore))\n+                // Only one thread will successfully remove the lock\n+                if (_lockReferenceCounts.TryRemove(lockKey, out _) && \n+                    _locks.TryRemove(lockKey, out var semaphore))\n                 {\n-                    semaphore.Dispose();\n+                    // CRITICAL FIX: Dispose semaphore safely, handling concurrent access\n+                    try\n+                    {\n+                        semaphore.Dispose();\n+                    }\n+                    catch (ObjectDisposedException)\n+                    {\n+                        // Expected during shutdown - semaphore already disposed\n+                    }\n                 }\n-                _lockReferenceCounts.TryRemove(lockKey, out _);\n-            }\n-            else\n-            {\n-                _lockReferenceCounts[lockKey] = newCount;\n             }\n         }\n     }\n \n     /// <summary>\n@@ -180,39 +209,87 @@ public class AsyncLockManager : IDisposable\n             }\n         }\n     }\n \n     /// <summary>\n-    /// Disposes the lock manager and releases all locks\n+    /// Disposes the lock manager and releases all locks with proper synchronization\n+    /// CRITICAL FIX: Uses proper disposal coordination to prevent race conditions\n     /// </summary>\n     public void Dispose()\n     {\n         if (!_disposed)\n         {\n-            _disposed = true;\n-\n-            // Mark all active lock handles as disposed\n-            foreach (var lockHandle in _activeLockHandles)\n+            // Set disposal flags atomically\n+            lock (_lockCreationLock)\n             {\n-                lockHandle.MarkAsDisposed();\n+                if (_disposed) return;\n+                _disposing = true;\n+                _disposed = true;\n             }\n-\n-            // Dispose all semaphores\n-            forea"
}