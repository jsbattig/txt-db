{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage.Tests/Async/AsyncLockManagerTests.cs:1",
  "vector": [
    0.045953602,
    -0.002285368,
    -0.013931699,
    0.050313719,
    -0.027794441,
    -0.008151351,
    -0.022409961,
    -0.006356846,
    0.034728244,
    0.023731664,
    -0.008505845,
    0.007148047,
    0.076155074,
    -0.04372023,
    -0.027264068,
    -0.03724502,
    0.073024988,
    0.059631269,
    -0.065430291,
    -0.003968994,
    -0.041156258,
    -0.019204985,
    -0.037532099,
    0.070096411,
    -0.043410942,
    -0.000295465,
    0.018355062,
    0.038029172,
    -0.019548152,
    0.078033224,
    0.019502001,
    -0.032991968,
    0.008722611,
    0.022811385,
    0.020820765,
    -0.022322582,
    -0.021944007,
    -0.018044798,
    -0.001618305,
    -0.007975246,
    0.052645225,
    -0.011011836,
    0.076325834,
    -0.04754753,
    0.027881706,
    -0.05889843,
    0.031168383,
    0.034512956,
    0.019663556,
    0.002152731,
    -0.011029419,
    -0.014151873,
    -0.008656233,
    0.028832065,
    -0.011791211,
    -0.02082698,
    0.087063991,
    0.014891269,
    -0.074202999,
    0.004032933,
    -0.020442599,
    -0.001332848,
    0.026000954,
    0.034342837,
    -0.016518489,
    -0.031836234,
    -0.022192692,
    0.055909701,
    -0.014542026,
    -0.058129083,
    0.025611833,
    0.026420161,
    0.007242279,
    0.03284039,
    0.00114744,
    0.082555354,
    0.036426023,
    0.036240313,
    0.006444339,
    -0.001119584,
    -0.035036799,
    -0.021108624,
    0.025279419,
    0.032924265,
    0.068218738,
    -0.044018898,
    0.018518988,
    -0.01887368,
    0.01287965,
    0.029325191,
    -0.044661336,
    -0.013919255,
    0.01589877,
    0.043306287,
    0.004297799,
    0.0001377,
    0.015345098,
    0.037152044,
    0.003246467,
    -0.073153354,
    0.01607307,
    0.009906215,
    -0.051288001,
    0.02968494,
    -0.056598067,
    0.003951021,
    -0.022366431,
    -0.040027935,
    0.015738582,
    0.023589332,
    0.015760122,
    0.053553034,
    -0.000451966,
    0.03221976,
    0.030387359,
    0.011969873,
    0.011576226,
    -0.014762797,
    -0.011420593,
    0.021333881,
    -0.00766049,
    0.04042726,
    -0.022566987,
    0.051358849,
    -0.058099143,
    0.045018211,
    0.026185714,
    0.031797014,
    -0.013705446,
    -0.016199365,
    0.029559376,
    -0.00427001,
    -0.001888191,
    -0.00029563,
    0.021851566,
    0.035124283,
    0.036958482,
    0.033190072,
    0.016958868,
    -0.028895946,
    0.035605848,
    -0.028242787,
    -0.004981886,
    0.018887544,
    -0.004703226,
    -0.003103212,
    0.040089849,
    -0.003233028,
    0.029904651,
    -0.05621513,
    -0.003120482,
    0.046844739,
    -0.026382525,
    0.023406658,
    0.032949287,
    0.022311639,
    -0.033772193,
    -0.037668802,
    -0.017420318,
    -0.015214786,
    -0.034376979,
    0.023390828,
    0.041898336,
    0.011363282,
    -0.049104895,
    0.065136977,
    0.003606039,
    0.006964698,
    0.010230863,
    -0.030807534,
    -0.028451689,
    0.045077957,
    -0.03416523,
    -0.007643207,
    -0.011856419,
    0.034559101,
    0.005548472,
    0.013690962,
    -0.050435651,
    -0.003722917,
    0.01116997,
    -0.028467312,
    -0.021997282,
    -0.023924556,
    -0.015807698,
    -0.023712091,
    0.030340016,
    0.01662459,
    -0.00893599,
    -0.017695021,
    -0.009674439,
    -0.016584592,
    -0.05046149,
    -0.005840778,
    -0.004037451,
    -0.017666355,
    -0.031073069,
    0.00860278,
    0.042703111,
    0.006268459,
    0.009329522,
    0.010023619,
    -0.064741567,
    -0.030330868,
    -0.008350669,
    0.049549606,
    -0.039788119,
    -0.010281588,
    0.009397688,
    -0.05124503,
    0.026472125,
    0.000107071,
    -0.000903576,
    -0.016339703,
    -0.015402825,
    0.024325008,
    -0.022152556,
    -0.014086053,
    0.008512399,
    0.005745747,
    0.009150891,
    0.002565138,
    0.03077073,
    0.035267889,
    -0.014165256,
    -0.055525847,
    -0.056100126,
    -0.027559003,
    0.004046316,
    -0.043440707,
    -0.018146642,
    -0.032702632,
    0.03864878,
    -0.068141595,
    -0.045053773,
    0.00901688,
    0.004390539,
    -0.016834114,
    0.019657155,
    0.03443788,
    -0.02482504,
    0.00833621,
    0.053516943,
    -0.008616002,
    -0.011289459,
    -0.026182471,
    0.03576586,
    -0.020402923,
    0.038014524,
    -0.024967249,
    -0.052743681,
    -0.004256096,
    -0.03688306,
    0.049027011,
    0.028461123,
    0.02461201,
    0.006661388,
    -0.040389407,
    -0.003873299,
    0.009465065,
    0.023121463,
    0.023700532,
    -0.05400515,
    -0.004387307,
    -0.011798672,
    0.038735982,
    -0.033314303,
    0.024666311,
    -0.041471276,
    0.039954714,
    0.001482609,
    0.0196143,
    0.013790979,
    -0.022242906,
    -0.001888841,
    -0.042115599,
    0.015108936,
    0.011064629,
    0.023852644,
    -0.016447967,
    -0.044147085,
    -0.018139234,
    0.010749343,
    -0.033590965,
    -0.038867772,
    -0.01566378,
    0.028192965,
    0.010747158,
    0.015591429,
    0.0199998,
    0.034654483,
    -0.01571599,
    -0.011392523,
    -0.013372957,
    0.04766386,
    0.020554306,
    0.030844679,
    -0.007970126,
    0.025736574,
    -0.050266828,
    0.001113462,
    0.00897738,
    0.054780949,
    0.030932799,
    0.018983157,
    -0.015948266,
    0.028686745,
    -0.02758014,
    0.032997664,
    0.00710311,
    -0.042205755,
    0.019088987,
    -0.013496228,
    0.002842608,
    0.009918614,
    -0.069622293,
    -0.022094181,
    0.003076493,
    -0.0486097,
    0.061518632,
    0.022922577,
    -0.01817729,
    0.027144415,
    -0.032933734,
    0.009857254,
    0.014267953,
    -0.042283848,
    -0.045856752,
    0.06598334,
    -0.061857879,
    -0.021960469,
    0.019759292,
    -0.0252243,
    0.007112612,
    0.009070384,
    -0.018492633,
    -0.018629923,
    0.006084083,
    -0.02028862,
    0.027850965,
    0.031829588,
    -0.004962072,
    0.037346087,
    0.021552287,
    0.071424201,
    0.028602393,
    0.007473005,
    -0.005090327,
    -0.015349799,
    0.051324952,
    0.00034192,
    -0.061621081,
    -0.005071104,
    0.005961404,
    -0.037956424,
    0.01857635,
    -0.03812978,
    -0.026545279,
    -0.011379222,
    0.059150312,
    0.00094251,
    -0.017553536,
    -0.035983305,
    -0.020491535,
    -0.003530531,
    -0.032339029,
    -0.03760929,
    0.083168931,
    -0.0368829,
    0.019083867,
    -0.018475141,
    -0.069755867,
    -0.02622922,
    0.015142768,
    -0.010317791,
    0.019212471,
    0.044477075,
    -0.008565248,
    -0.003610217,
    -0.013278094,
    -0.025159061,
    0.022839541,
    0.008808861,
    0.003369783,
    -0.023671335,
    0.012931998,
    -0.015923107,
    -0.010911362,
    -0.000470579,
    0.048781443,
    0.033084188,
    -0.013089433,
    -0.023746282,
    0.012991999,
    -0.025927536,
    -0.018383252,
    0.016253546,
    0.007845826,
    0.033543073,
    0.012683687,
    0.033579458,
    -0.005718869,
    0.027344564,
    -0.06512899,
    0.024196815,
    0.003816913,
    -0.013030291,
    0.036468986,
    -0.024310144,
    0.005567435,
    -0.007465706,
    0.097489178,
    0.000189807,
    0.04608953,
    -0.037623178,
    0.060309995,
    0.008645723,
    0.010516967,
    -0.025813527,
    -0.007107766,
    0.029948387,
    -0.034353781,
    -0.031338841,
    -0.010021434,
    -0.047123291,
    -0.012965162,
    0.025258541,
    -0.065142117,
    -0.032636177,
    0.002788923,
    0.023201294,
    -0.013955517,
    -0.075409971,
    0.029296737,
    0.029736208,
    -0.028368648,
    0.010316929,
    0.009177277,
    -0.004147619,
    0.000611698,
    -0.021944499,
    -0.009826383,
    0.0879995,
    -0.041183952,
    0.000178816,
    -0.010420367,
    -0.00040154,
    0.030337816,
    -0.008073863,
    -0.023848929,
    -0.045613199,
    0.023631506,
    -0.058276549,
    -0.016466439,
    0.049939528,
    -0.010453342,
    -0.049681582,
    0.026632359,
    -0.012526933,
    -0.019841973,
    -0.015853247,
    -0.007385307,
    0.008049144,
    0.025839575,
    -0.033160914,
    0.012532876,
    0.002317967,
    -0.021776259,
    -0.035463933,
    -0.004699766,
    0.043592151,
    -0.006543033,
    -0.025081642,
    0.019892149,
    0.019602345,
    0.011185376,
    0.002841151,
    0.084646337,
    -0.022910248,
    -0.025205296,
    -0.064177051,
    -0.034585483,
    -0.014937853,
    -0.015195495,
    0.011380356,
    0.047520999,
    -0.009354454,
    0.012991349,
    0.080391087,
    -0.016807068,
    -0.020356547,
    -0.002117116,
    -0.019682776,
    0.006313482,
    0.0088575,
    0.013116424,
    0.022391804,
    -0.034996599,
    -0.00282781,
    0.026578279,
    0.015889315,
    -0.05445531,
    0.009745708,
    0.014050925,
    -0.044135094,
    0.023493284,
    0.021186877,
    -0.039835479,
    -0.067268737,
    0.024488825,
    -0.030273899,
    -0.032193899,
    -0.004612517,
    -0.000448024,
    0.026084362,
    -0.06744425,
    -0.040953595,
    0.034522492,
    0.008540058,
    -0.010533726,
    0.019236365,
    0.018335603,
    -0.023205539,
    -0.036432445,
    0.042963412,
    0.010606643,
    0.019175746,
    -0.006834372,
    5.6559e-05,
    -0.075872317,
    0.007802987,
    0.037202016,
    -0.040638611,
    -0.035089865,
    -0.033103723,
    -0.016267596,
    0.01686772,
    0.007843222,
    -0.000320153,
    0.001928646,
    -0.001500754,
    0.026194885,
    -0.007595676,
    -0.06868989,
    0.03995838,
    0.017558599,
    0.028109629,
    0.03698092,
    0.00724067,
    -0.027280129,
    -0.008873194,
    0.027397402,
    0.074189752,
    0.032025952,
    -0.01527512,
    0.074527867,
    0.05951909,
    0.021955332,
    0.058637146,
    0.008067168,
    -0.012602258,
    0.030115994,
    -0.005572544,
    0.008096881,
    -0.006562426,
    0.051111814,
    0.018795224,
    0.021965092,
    -0.049074486,
    -0.034742042,
    -0.00427608,
    0.003361475,
    0.018259874,
    -0.005291765,
    0.004537186,
    0.034405708,
    0.028618801,
    -0.046423975,
    -0.019671001,
    -0.02814319,
    0.010614931,
    -0.043265279,
    0.045854364,
    -0.001782329,
    -0.021588519,
    -0.046009317,
    0.022087179,
    -0.02154411,
    -0.009222889,
    -0.008657353,
    0.062468383,
    0.011752202,
    0.012079619,
    -0.076708041,
    0.040606868,
    0.011898906,
    0.004471817,
    -0.006088082,
    0.027403338,
    -0.019114919,
    -0.001668079,
    -0.009053228,
    0.057555772,
    -0.011318305,
    0.018886341,
    -0.014212682,
    0.020457815,
    0.005981554,
    0.041970797,
    0.03120908,
    0.005550834,
    0.042935964,
    0.068050183,
    -0.02134292,
    0.007643393,
    0.02193936,
    0.030974813,
    -0.033459548,
    -0.037218377,
    0.048473723,
    0.008569796,
    -0.060570706,
    0.001208274,
    -0.035699483,
    0.018415732,
    -0.03649544,
    0.042589251,
    -0.02137821,
    0.049243096,
    0.004992854,
    -0.014861055,
    0.02051742,
    -0.076779366,
    -0.008635482,
    0.004614543,
    -0.006581714,
    0.030483551,
    -0.019995708,
    -0.008089954,
    0.023172565,
    -0.010345611,
    -0.020896038,
    0.007457935,
    0.00597693,
    0.034240566,
    0.007589729,
    0.030670663,
    -0.025494311,
    -0.032611944,
    0.032818377,
    0.03299522,
    0.037648052,
    0.07901115,
    0.009370976,
    0.065766521,
    -0.00131241,
    0.020051856,
    -0.014121135,
    0.008799598,
    0.00258641,
    0.004210721,
    -0.03231144,
    -0.010894991,
    0.026181361,
    0.0595222,
    -0.009091351,
    -0.04731556,
    0.021160966,
    -0.024839822,
    -0.011975383,
    0.004789124,
    0.024164839,
    0.001911693,
    -0.006758124,
    -0.047993973,
    0.017201908,
    0.016698301,
    0.024579303,
    0.008998041,
    -0.010145596,
    -0.00619975,
    0.058760751,
    0.012844381,
    0.004049814,
    -0.035413921,
    -0.019327667,
    -0.050409079,
    0.008398165,
    -0.001833265,
    0.002931301,
    -0.016410328,
    -0.008033215,
    0.086523004,
    -0.05075676,
    -0.022235591,
    0.005955064,
    0.011258855,
    0.007922578,
    -0.005338636,
    -0.045094244,
    0.020002244,
    0.004433888,
    0.006336929,
    0.006268731,
    0.020504482,
    -0.049527254,
    0.022785142,
    -0.015076884,
    0.061973318,
    0.028690418,
    -0.029726468,
    -0.065899268,
    -0.009804697,
    0.038697626,
    -0.01916527,
    0.008084524,
    -0.041076396,
    -0.033560991,
    -0.009239127,
    -0.001291169,
    -0.02058788,
    -0.000340322,
    -0.04019548,
    0.003471456,
    0.015175123,
    0.004955481,
    -0.01855061,
    -2.8279e-05,
    0.070959471,
    -0.000431646,
    -0.027477263,
    0.020235019,
    0.047292683,
    -0.025161035,
    -0.019993143,
    0.011282017,
    -0.012323797,
    0.007600605,
    -0.008001978,
    0.028735111,
    0.022180412,
    0.017543675,
    -0.00652212,
    0.028370032,
    -0.000828586,
    0.004033415,
    -0.00072957,
    0.000335248,
    -0.012248478,
    -0.055404585,
    -0.008821118,
    -0.035352141,
    0.002668512,
    -0.034740318,
    0.03011979,
    -0.001841566,
    -0.038515825,
    0.045113891,
    0.006931342,
    0.033922601,
    0.008802108,
    0.004548217,
    0.025385184,
    -0.025606172,
    -0.025689121,
    -0.037548445,
    -0.034356233,
    0.020088971,
    -0.090703301,
    0.010916714,
    0.004476656,
    0.004381393,
    -0.035911277,
    0.02374888,
    -0.000352584,
    -0.010551022,
    0.041793637,
    -0.008683473,
    -0.027018715,
    0.010330345,
    0.01015537,
    0.003890793,
    0.000202672,
    -0.047565944,
    -0.060346484,
    0.010311312,
    -0.010942963,
    0.058863394,
    -0.009139691,
    -0.050792418,
    0.023098249,
    0.040773738,
    -0.025969546,
    0.002811415,
    0.017351497,
    0.045423333,
    -0.033090986,
    -0.057590228,
    0.006671502,
    -0.012662262,
    -0.05037865,
    0.015308488,
    0.03374752,
    0.03004192,
    -0.019106211,
    -0.004647974,
    0.077641077,
    -0.014828905,
    0.05972296,
    0.000691311,
    0.021405526,
    0.007933955,
    -0.095645808,
    -0.023235917,
    0.002551168,
    -0.022777576,
    -0.078204349,
    0.040605418,
    -0.001051905,
    0.008594359,
    0.017227298,
    0.001492286,
    0.048425481,
    0.034196649,
    -0.006526959,
    -0.012496051,
    0.008900771,
    -0.028923772,
    -0.001751579,
    -0.021876989,
    -0.014262731,
    0.011244682,
    0.023491556,
    0.005287286,
    0.035819266,
    0.002656727,
    0.000953745,
    0.035332907,
    0.0125914,
    -0.039717026,
    0.018807132,
    0.013759475,
    0.039990153,
    0.037785403,
    -0.028257547,
    -0.012326755,
    0.001733149,
    -0.001333466,
    -0.021631777,
    0.044749696,
    -0.038457911,
    0.001265599,
    0.017420936,
    0.000553289,
    -0.005715828,
    0.033773016,
    -0.013621352,
    0.024419034,
    -0.063284516,
    0.014665017,
    0.058150724,
    0.031607691,
    -0.002857012,
    -0.002913648,
    -0.009994825,
    -0.026135273,
    0.021584587,
    -0.049634561,
    -0.060025919,
    0.003379792,
    -0.034622323,
    0.001605495,
    -0.040669046,
    -0.026950238,
    -0.010809607,
    0.003504077,
    0.046312232,
    -0.004901247,
    -0.01471398,
    0.015498747,
    -0.021870155,
    0.044652551,
    0.009652293,
    0.008739907,
    0.033633552,
    0.010795289,
    -0.036872227,
    -0.061681572,
    -0.011196237,
    0.013025997,
    -0.066441223,
    -0.023390491,
    0.00164078,
    0.031733267,
    0.023938181,
    0.008927102,
    0.019757198,
    -0.009777039,
    -0.002287954,
    0.021577768,
    -0.057433605,
    0.006982092,
    -0.027599951,
    -0.007709153,
    0.029653199,
    -0.003471487,
    0.001809673,
    0.038025308,
    0.008693199,
    0.064303681,
    0.032027081,
    0.005255066,
    -0.008682973,
    -0.066774219,
    -0.021807084,
    0.046200804,
    0.026318723,
    -0.004412225,
    0.009075466,
    -0.062724665,
    -0.025969729,
    -0.032576494,
    0.020137498,
    0.052361611,
    -0.022500621,
    -0.008727336,
    -0.066398695,
    -0.021043785,
    -0.008699052,
    0.011969853,
    0.017877366,
    0.005272553,
    -0.031095203,
    -0.004161717,
    -0.01582898,
    0.012576875,
    -0.01774876,
    0.04980297,
    0.028968111,
    -0.035181202,
    0.018688168,
    -0.044982571,
    -0.025939558,
    -0.01902798,
    -0.021244619,
    0.017694274,
    -0.017459903,
    -0.014508552,
    -0.003552864,
    -0.01207971,
    0.032455374,
    -0.040796369,
    -0.008137812,
    0.010032018,
    0.031148773,
    -0.01236066,
    -0.003865261,
    -0.064799853,
    -0.067019507,
    0.023753356,
    0.049073163,
    -0.012849491,
    0.026984943,
    -0.003658901,
    0.032902166,
    -0.00016299,
    0.052061297,
    0.01915366,
    0.004563642,
    0.054735124,
    0.000116689,
    0.029842978,
    -0.068764813,
    0.051412307,
    -0.039011531,
    -0.001518838,
    -0.004988855,
    0.006959348,
    -0.039112616,
    0.025453681,
    0.010640822,
    0.002986313,
    0.058362506,
    -0.015918542,
    0.008894268,
    -0.05160699,
    -0.013198116,
    0.018132195,
    -0.035157092,
    -0.022750972,
    -0.017926795,
    0.016682245,
    0.052296769,
    0.002080428,
    -0.012629937,
    -0.00835511,
    -0.004302286,
    0.007689485,
    -0.003002285,
    -0.022794979,
    0.037860285,
    0.055995021,
    0.023850081,
    -0.012363084,
    -0.026585476,
    -0.03850311,
    0.014123008,
    -0.011093611,
    0.077404574,
    0.026178559,
    -0.004588949,
    0.02661917,
    -0.00511287,
    -0.000388881,
    0.025066892,
    0.00629957,
    0.003933238,
    -0.06352853,
    0.004978002,
    0.034801468,
    0.001109222,
    -0.022636088,
    0.036944762,
    -0.05067642
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage.Tests/Async/AsyncLockManagerTests.cs",
    "chunk_index": 1,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "oncurrentOperations).Select(i =>\n+            Task.Run(async () =>\n+            {\n+                try\n+                {\n+                    // Add timeout to prevent indefinite blocking\n+                    using var lockHandle = await tempLockManager.AcquireLockAsync(lockKey, TimeSpan.FromMilliseconds(100));\n+                    Interlocked.Increment(ref completedBeforeDisposal);\n+                    await Task.Delay(5);\n+                }\n+                catch (ObjectDisposedException)\n+                {\n+                    // This is expected after disposal, but should be handled gracefully\n+                }\n+                catch (TimeoutException)\n+                {\n+                    // Also acceptable during disposal\n+                }\n+                catch (Exception ex)\n+                {\n+                    exceptions.Add(ex);\n+                }\n+            })\n+        ).ToArray();\n+\n+        // Dispose the lock manager while operations are running\n+        await Task.Delay(2);\n+        tempLockManager.Dispose();\n+\n+        await Task.WhenAll(lockTasks);\n+\n+        // Assert - Should only have ObjectDisposedException and TimeoutException, no other exceptions\n+        var unexpectedExceptions = exceptions.Where(ex => \n+            !(ex is ObjectDisposedException) && \n+            !(ex is TimeoutException)).ToArray();\n+        Assert.Empty(unexpectedExceptions);\n+    }\n+\n+    /// <summary>\n+    /// FAILING TEST: Reproduces collection modification during disposal\n+    /// This test exposes \"Collection was modified after the enumerator was created\" exceptions\n+    /// </summary>\n+    [Fact]\n+    public async Task CollectionModificationException_DisposalDuringIteration_ShouldNotThrow()\n+    {\n+        // Arrange\n+        var tempLockManager = new AsyncLockManager();\n+        var lockKeys = Enumerable.Range(0, 10).Select(i => $\"collection_test_{i}\").ToArray();\n+        var exceptions = new ConcurrentBag<Exception>();\n+\n+        // Act - Create locks and then dispose while collection might be iterated\n+        var lockTasks = lockKeys.Select(async lockKey =>\n+        {\n+            try\n+            {\n+                var lockHandle = await tempLockManager.AcquireLockAsync(lockKey);\n+                // Don't dispose immediately to keep references in collections\n+                _ = Task.Run(async () =>\n+                {\n+                    await Task.Delay(20);\n+                    lockHandle.Dispose();\n+                });\n+            }\n+            catch (Exception ex)\n+            {\n+                exceptions.Add(ex);\n+            }\n+        }).ToArray();\n+\n+        await Task.WhenAll(lockTasks);\n+        await Task.Delay(5); // Let some locks be acquired\n+\n+        // Dispose while locks are still active - this should not cause collection modification exceptions\n+        tempLockManager.Dispose();\n+\n+        await Task.Delay(50); // Wait for background disposals\n+\n+        // Assert - Should not have InvalidOperationException for collection modification\n+        var collectionModificationExceptions = exceptions\n+            .Where(ex => ex is InvalidOperationException && ex.Message.Contains(\"Collection was modified\"))\n+            .ToArray();\n+        Assert.Empty(collectionModificationExceptions);\n+    }\n+\n+    /// <summary>\n+    /// FAILING TEST: Reproduces semaphore disposal race condition\n+    /// This test exposes cases where semaphores are disposed while threads are waiting on them\n+    /// </summary>\n+    [Fact]\n+    public async Task SemaphoreDisposalRaceCondition_DisposeDuringWait_ShouldHandleCleanly()\n+    {\n+        // Arrange\n+        var tempLockManager = new AsyncLockManager();\n+        var lockKey = \"semaphore_disposal_race\";\n+        var exceptions = new ConcurrentBag<Exception>();\n+\n+        // Act - Acquire a lock, then start waiting threads, then dispose\n+        var firstLock = await tempLockManager.AcquireLockAsync(lockKey);\n+\n+        var waitingTasks = Enumerable.Range(0, 5).Select(i =>\n+            Task.Run(async () =>\n+            {\n+                try\n+                {\n+  "
}