{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs:3",
  "vector": [
    0.019261846,
    -0.008351518,
    0.003446237,
    0.02422444,
    0.004294283,
    -0.006828371,
    -0.01471102,
    0.00069235,
    0.033716772,
    0.00932737,
    0.019194618,
    -0.021497477,
    0.077169403,
    -0.003026881,
    -0.068500541,
    -0.039227862,
    0.029051211,
    0.01654432,
    -0.034551892,
    0.002601158,
    -0.014403391,
    -0.064395756,
    -0.075328864,
    0.047882583,
    -0.074481703,
    0.009379179,
    0.03579399,
    0.037862793,
    0.000460723,
    0.046660606,
    -0.006664084,
    -0.050976146,
    0.002564069,
    0.023442958,
    0.043748029,
    0.002337556,
    -0.015184647,
    -0.002147079,
    -0.018135298,
    0.01665787,
    0.029298715,
    -0.022303009,
    0.053817712,
    0.004983304,
    0.021114254,
    -0.067363501,
    -0.002186148,
    0.011565718,
    -0.016278163,
    0.011802237,
    0.002951967,
    0.011614195,
    -0.018664408,
    0.052828342,
    0.011192983,
    -0.05935809,
    0.060441736,
    0.033385664,
    -0.044965796,
    0.074369997,
    -0.03256074,
    -0.012878985,
    0.02385211,
    0.025878817,
    -0.033333432,
    -0.054862078,
    -0.059932575,
    0.040965725,
    0.023533532,
    -0.064686552,
    0.024287682,
    0.038419064,
    0.010593464,
    0.048125077,
    0.015553719,
    0.029063512,
    0.033340599,
    0.021937473,
    0.046601839,
    0.005898554,
    -0.046765018,
    -0.072735243,
    0.004409874,
    -0.02886332,
    0.050752461,
    -0.0276039,
    0.023110785,
    -0.061286163,
    -0.003773751,
    -0.012195171,
    -0.014490803,
    0.056695748,
    0.057820853,
    0.025945928,
    -0.015586697,
    0.024800921,
    0.007287474,
    0.010657437,
    0.021994537,
    -0.038436152,
    0.013618994,
    0.017415531,
    -0.050786961,
    0.056201816,
    -0.046443574,
    -0.011456967,
    0.005225585,
    -0.052492652,
    -0.030296247,
    0.013897853,
    0.047254976,
    0.010535849,
    0.017908834,
    0.021984518,
    0.018596336,
    -0.002558291,
    -0.017091908,
    -0.007697848,
    0.037569612,
    0.036496148,
    -0.03356256,
    0.016596697,
    -0.08635512,
    0.0640769,
    -0.018783176,
    0.053585522,
    0.033972435,
    0.043314293,
    0.01502117,
    -0.030671142,
    0.020754453,
    -0.025655171,
    0.014881595,
    0.003566402,
    -0.015718345,
    0.001139505,
    0.034055222,
    0.021240065,
    -0.005251523,
    -0.038621131,
    0.034284528,
    -0.032876413,
    0.00530935,
    0.026293389,
    -0.015602399,
    0.005206408,
    0.011934422,
    -0.015688393,
    0.042215616,
    -0.07723254,
    -0.014178691,
    0.05974739,
    -0.052426323,
    -0.009124912,
    0.005932258,
    0.030257674,
    -0.031911004,
    -0.016391266,
    0.019292489,
    -0.014787369,
    -0.046114355,
    0.022766808,
    0.025702693,
    0.022184212,
    -0.012844068,
    0.036239907,
    -0.000451699,
    0.010850266,
    0.02430631,
    -0.020074038,
    -0.058959715,
    0.029362651,
    -0.065261312,
    -0.015524407,
    -0.021731684,
    0.019284526,
    0.046983033,
    0.011744288,
    -0.076393679,
    -0.023429772,
    0.007211125,
    -0.002035596,
    0.00587441,
    0.026253562,
    4.4856e-05,
    0.009263761,
    0.049398597,
    0.038410921,
    0.0111098,
    0.007417031,
    -0.047639024,
    -0.018429026,
    -0.044963364,
    -0.011671131,
    0.01325938,
    0.005841214,
    -0.034837831,
    0.006265292,
    0.003163209,
    0.02576622,
    -0.021175819,
    0.019353528,
    -0.077691332,
    -0.007189355,
    0.042484645,
    -0.004715254,
    -0.03467802,
    -0.014795864,
    -0.002669468,
    0.020001227,
    -0.01426483,
    -0.026598513,
    0.00301468,
    0.013988158,
    0.021611309,
    -0.000668289,
    -0.056018841,
    -0.002728601,
    0.042688064,
    -0.004894008,
    -0.012591552,
    -0.005907784,
    0.061814263,
    0.022355756,
    -0.038034726,
    -0.032223508,
    -0.064425051,
    -0.038867112,
    -0.011696427,
    -0.034588721,
    0.029315209,
    -0.039365988,
    0.036198851,
    -0.043311931,
    -0.040693395,
    0.036622427,
    -0.008395573,
    -0.011558132,
    -0.002627685,
    -0.02258095,
    -0.029416965,
    0.05500178,
    0.00795273,
    0.006397577,
    -0.024442064,
    0.013386679,
    0.061350103,
    0.020873724,
    0.010344569,
    0.00242839,
    -0.044516403,
    0.049164832,
    -0.042424109,
    0.083193779,
    0.062586524,
    0.001714766,
    -0.016369611,
    0.023305779,
    0.001998139,
    0.002081906,
    0.009798741,
    -0.000244735,
    -0.003437236,
    0.038467675,
    -0.01625176,
    0.025728168,
    -0.023582263,
    -0.019025607,
    -0.014301268,
    0.027988087,
    0.001401884,
    -0.00461318,
    0.066446789,
    0.02554547,
    0.012982385,
    -0.026787886,
    0.02505664,
    0.026743174,
    0.003334567,
    0.034031082,
    -0.036913369,
    -0.004841771,
    -0.004349553,
    -0.016536415,
    -0.014640395,
    -0.055631753,
    0.018781908,
    -0.022533305,
    0.013412204,
    0.022967258,
    0.009239526,
    -0.015038179,
    -0.008244554,
    -0.028007822,
    0.040445883,
    0.016637865,
    0.010284881,
    -0.038051873,
    0.003944125,
    -0.027556572,
    -0.017896153,
    -0.018081876,
    0.073183656,
    0.016498076,
    -0.009454994,
    0.018132458,
    0.017385514,
    -0.051091325,
    0.010308079,
    -0.021260222,
    -0.056489613,
    -0.019431435,
    0.015839038,
    -0.001830079,
    0.027457561,
    -0.040323343,
    -0.029482573,
    -0.000276078,
    -0.037015144,
    -0.004119995,
    0.001745615,
    -0.02610261,
    0.025960643,
    -0.070158452,
    0.021696635,
    -0.007150036,
    -0.050543029,
    -0.039900154,
    0.017072575,
    -0.02053858,
    -0.008339117,
    0.052853372,
    -0.002810886,
    0.046508826,
    -0.002280593,
    0.044355236,
    -0.030316086,
    0.000284277,
    -0.039472394,
    0.01082841,
    -0.009185543,
    -0.023318311,
    0.034400575,
    -0.036890794,
    0.050573736,
    0.000316896,
    0.029837176,
    -0.007492695,
    -0.022960015,
    0.050005827,
    0.016078293,
    -0.058518626,
    -0.005953067,
    -0.018991617,
    -0.060201563,
    0.033402853,
    -0.019046465,
    0.022968352,
    -0.009511648,
    0.017572157,
    0.01346828,
    0.02543558,
    -0.053114168,
    -0.018965431,
    -0.007858492,
    0.014231475,
    -0.028726131,
    0.072676338,
    -0.03573129,
    0.027232792,
    -0.036832523,
    -0.054431893,
    -0.036908567,
    0.005152295,
    -0.003746682,
    0.031912971,
    0.029549476,
    -0.017415257,
    -0.026527666,
    -0.005712468,
    0.026825372,
    0.001305763,
    0.00451009,
    -0.008799288,
    -0.006725959,
    -0.026431927,
    0.025522178,
    0.028568093,
    -0.030635821,
    0.038298946,
    -0.001488948,
    0.010463911,
    0.024544159,
    0.004560922,
    -0.009906111,
    -0.032689806,
    -0.023263665,
    0.037365153,
    0.009939346,
    -0.046229586,
    0.018169908,
    -0.006805133,
    0.037477575,
    -0.053564899,
    0.0114114,
    -0.00481806,
    0.013579877,
    0.044300862,
    0.001759335,
    0.061236799,
    -0.005299672,
    0.03658241,
    -0.028536996,
    0.032649435,
    -0.032070566,
    0.026518123,
    -0.024831273,
    -0.010563849,
    -0.00501952,
    0.010348842,
    -0.016808107,
    -0.036344152,
    -0.002141166,
    0.005665248,
    -0.03230628,
    0.00816603,
    0.012068118,
    -0.084416732,
    -0.043125849,
    0.010402286,
    -0.031225746,
    0.01561017,
    -0.04548572,
    0.01660029,
    0.034336764,
    -0.05461131,
    0.026675716,
    -0.019850431,
    -0.029135801,
    -0.045072313,
    0.019201977,
    -0.011048658,
    0.030141972,
    -0.03384982,
    -0.007317436,
    -0.032785818,
    0.05032311,
    0.048591565,
    -0.026818773,
    -0.003347988,
    -0.07029102,
    -0.00433594,
    -0.043124028,
    0.003567017,
    0.070065074,
    -0.020322388,
    -0.01241928,
    0.040795937,
    0.010053537,
    -0.046012204,
    -0.011183226,
    -0.017574454,
    -0.004767721,
    0.004816145,
    0.004398775,
    0.032165997,
    0.032243647,
    -0.055751301,
    -0.039200556,
    0.020805564,
    0.050417237,
    -0.01958514,
    -0.028575666,
    0.022318823,
    0.045120701,
    0.0218977,
    -0.005470539,
    0.044236016,
    -0.046057615,
    -0.034401014,
    -0.018766031,
    -0.047236174,
    -0.031620197,
    -0.046572842,
    -0.017564161,
    0.023145825,
    -0.031964485,
    0.033768542,
    0.008647894,
    -0.023397995,
    -0.00342223,
    -0.008748618,
    -0.010894164,
    -0.002926959,
    0.020317744,
    0.006143278,
    0.007420915,
    -0.005054608,
    -0.041197754,
    0.035032306,
    0.048358332,
    -0.076203294,
    0.03813513,
    -0.013252625,
    -0.013974164,
    0.037625592,
    0.000342242,
    -0.042264357,
    -0.087333702,
    0.026445381,
    -0.024310226,
    -0.02228564,
    -0.00725886,
    0.010581308,
    0.019673359,
    -0.038993675,
    -0.059075579,
    0.007220273,
    0.01421073,
    -0.016025117,
    0.002995828,
    0.02076548,
    -0.005897154,
    -0.028843965,
    -0.013396643,
    0.005302908,
    0.030970726,
    0.030933928,
    0.012770355,
    -0.039743576,
    0.015793705,
    0.015589362,
    -0.005423321,
    -0.054315247,
    0.032077678,
    -0.003023907,
    0.023552623,
    0.00616784,
    -0.00854717,
    -0.016407466,
    -0.057895083,
    0.007588738,
    -0.036045097,
    -0.035109796,
    0.026747447,
    -0.01909708,
    0.013361222,
    0.028520709,
    0.008447327,
    0.010329832,
    -0.005252237,
    0.041476611,
    0.013335189,
    0.049135789,
    -0.055569641,
    0.074619643,
    0.041846238,
    -0.00505734,
    0.049079835,
    -0.00840463,
    0.03925566,
    0.024170456,
    0.002984691,
    0.024907131,
    -0.042331506,
    0.006092169,
    0.036229674,
    0.008757955,
    -0.037955288,
    -0.008037212,
    -0.001976898,
    -0.021972731,
    0.010865943,
    0.007695101,
    -0.024236759,
    0.026188815,
    0.072050899,
    -0.056025211,
    -0.017267199,
    -0.015832115,
    -0.008953238,
    0.018451974,
    0.001478217,
    0.027864495,
    -0.0247206,
    -0.060817882,
    0.049834918,
    -0.011003258,
    -0.030812314,
    -0.026799057,
    0.02615802,
    -0.020546183,
    0.007643264,
    -0.032069776,
    0.059143167,
    0.03007016,
    -0.03213064,
    -0.021576811,
    -0.014359839,
    -0.018978089,
    0.001396701,
    0.012326065,
    0.037647352,
    0.025236243,
    -0.013433847,
    -0.02939604,
    0.001171079,
    -0.02985679,
    0.042796206,
    0.037037332,
    0.009755287,
    0.027711386,
    0.075494178,
    -0.019872814,
    0.015444832,
    0.020966522,
    0.030376635,
    -0.089293495,
    0.014336439,
    -0.003806234,
    0.025679803,
    -0.044730626,
    -0.060993876,
    0.002659054,
    0.013135766,
    0.003472196,
    0.022443905,
    0.001357925,
    0.003385887,
    0.020138256,
    -0.012156558,
    0.031041082,
    -0.052368253,
    0.026510714,
    -0.003297047,
    0.011248253,
    0.005416236,
    0.004748013,
    -0.002577427,
    -0.004093968,
    -0.008135888,
    0.005829267,
    0.004078808,
    0.029425427,
    0.054430746,
    0.026595544,
    0.02579418,
    -0.029899864,
    -0.0161949,
    0.042126369,
    0.004334484,
    0.010244269,
    0.081731349,
    0.057821244,
    0.072696127,
    0.037756797,
    0.02110441,
    -0.026243784,
    -0.024010824,
    -0.005078558,
    -0.01861403,
    -0.034902766,
    -0.033028569,
    0.014298767,
    0.02577563,
    -0.036457255,
    -0.006074023,
    0.023095926,
    -0.036465276,
    -0.013272353,
    -0.021161754,
    0.030124504,
    -0.052906506,
    -0.032626159,
    -0.003020501,
    -0.014354851,
    0.001197234,
    -0.004726553,
    -0.012175836,
    0.004423539,
    0.019076776,
    0.08023195,
    0.004994947,
    -0.00426565,
    -0.05015697,
    0.022456033,
    -0.016062578,
    0.044953737,
    -0.027001059,
    0.0001287,
    -0.003877303,
    -0.013391806,
    0.106358446,
    -0.010990606,
    0.016005989,
    -0.014557878,
    0.023849618,
    -0.017733745,
    -0.05555879,
    -0.024559382,
    -0.016664675,
    0.045971982,
    -0.007352849,
    0.039682604,
    -0.010888394,
    -0.025341457,
    -0.024550971,
    -0.04725308,
    0.074089736,
    0.002345766,
    -0.006707388,
    -0.024109202,
    0.023195883,
    0.009991364,
    0.006378995,
    0.000314389,
    -0.046404313,
    -0.063638106,
    -0.021369275,
    0.024774067,
    0.037807215,
    -0.025159454,
    -0.019532397,
    0.001864425,
    -0.005869468,
    0.009200261,
    0.02050972,
    0.002702126,
    0.074631877,
    -0.01944891,
    -0.004656785,
    0.023504468,
    0.014924064,
    0.066930637,
    -0.04202459,
    0.009747933,
    -0.049209788,
    0.027890615,
    -0.029445181,
    0.010185324,
    -0.005220716,
    0.011117409,
    -0.0089835,
    0.002933298,
    0.000732891,
    0.0010135,
    -0.028698362,
    0.013451356,
    0.00487678,
    -0.060780555,
    -0.015262318,
    -0.007351817,
    0.004473065,
    -0.008084966,
    0.041355304,
    -0.01040883,
    -0.036064837,
    0.048545063,
    -0.016589947,
    0.04874523,
    -0.036746223,
    0.024103561,
    0.014423208,
    -0.041699335,
    -0.028886028,
    -0.027035564,
    0.0086761,
    0.015451508,
    -0.067075327,
    -0.009446547,
    -0.051712204,
    -0.004037126,
    -0.02588178,
    0.009347117,
    -0.019607892,
    -0.06649895,
    0.036133729,
    0.00849601,
    -0.027988173,
    0.01016895,
    -0.003102461,
    -0.002340371,
    0.008652767,
    -0.037483983,
    -0.028676705,
    -0.01014764,
    0.028728178,
    0.039029319,
    -0.038130399,
    -0.060477532,
    0.059201047,
    -0.006555194,
    -0.047650579,
    0.01652495,
    0.020014156,
    0.016454367,
    -0.04854792,
    -0.046081904,
    -0.010230126,
    -0.007461694,
    -0.045602694,
    0.051519509,
    0.016256472,
    0.046184823,
    0.008450413,
    -0.024483584,
    0.059778761,
    -0.011423069,
    0.015603174,
    0.019042363,
    0.01034441,
    -0.007696777,
    -0.021908177,
    -0.008034976,
    0.037158918,
    -0.035206959,
    -0.078442581,
    0.016410867,
    -0.003510618,
    0.004756309,
    0.033918135,
    0.032879073,
    0.012947972,
    0.010146235,
    -0.02291449,
    0.005207765,
    -0.007821128,
    0.004297452,
    0.000267996,
    0.027948607,
    -0.062915906,
    0.047770191,
    0.005934398,
    -0.04336014,
    0.016316239,
    0.005889982,
    -0.028758917,
    0.030492499,
    0.008536593,
    -0.021023238,
    0.00844466,
    0.011969659,
    0.023693971,
    0.008092656,
    -0.016112372,
    -0.047143254,
    -0.015349973,
    0.019118141,
    -0.013776407,
    0.031032763,
    0.013236389,
    -0.002092465,
    -0.002744413,
    -0.007700523,
    -0.024156021,
    0.070321374,
    5.63e-05,
    0.023270788,
    -0.055097751,
    -0.016777908,
    0.073394366,
    0.019305492,
    -0.014595277,
    -0.021023758,
    -0.030665077,
    -0.036278062,
    0.004319333,
    0.015375615,
    -0.02818872,
    -0.019045467,
    0.004673211,
    0.023986755,
    -0.050606262,
    -0.010391116,
    0.020129954,
    0.007971273,
    0.025510879,
    -0.003182213,
    -0.043403566,
    0.021320933,
    -0.006485624,
    0.016454754,
    0.020474724,
    0.020479044,
    0.017918991,
    0.006838756,
    -0.006659925,
    0.002015592,
    -0.011192526,
    0.028861394,
    -0.03858389,
    -0.013909116,
    -0.015372293,
    0.047135759,
    0.012726083,
    0.023876838,
    -0.006943736,
    0.003885341,
    -0.000647699,
    0.031161388,
    0.004839845,
    0.030973781,
    -0.035148207,
    0.040895931,
    0.021295186,
    0.008013985,
    -0.018903352,
    -0.004952477,
    -0.003403103,
    0.057893407,
    0.024391059,
    -0.032337721,
    -0.013671611,
    -0.016274581,
    -0.020320978,
    0.003688158,
    0.017021973,
    0.034322172,
    -0.001748055,
    -0.042321313,
    0.013229446,
    -0.043752316,
    -0.008455509,
    0.025045149,
    0.016877417,
    0.00763228,
    -0.071090199,
    0.005426304,
    -0.042024083,
    0.015788782,
    -0.031589396,
    -0.014082396,
    0.004344703,
    0.027401291,
    0.021855764,
    0.000754039,
    -0.004090834,
    0.044969771,
    0.043242831,
    -0.025493242,
    0.007862994,
    -0.034888208,
    -0.057257142,
    -0.008484012,
    -0.057366114,
    -0.001707063,
    0.014123438,
    0.022032814,
    0.00974929,
    -0.016781742,
    -0.02040329,
    -0.017339827,
    0.026139606,
    0.022955531,
    0.053303901,
    0.011628221,
    -0.022011232,
    -0.030334784,
    -0.051994313,
    -0.021476928,
    0.017348101,
    -0.017694017,
    0.031478759,
    0.020617841,
    0.027267907,
    0.018213904,
    0.071710788,
    0.073317759,
    0.004163312,
    0.025948446,
    -0.003888581,
    -0.024429146,
    -0.034923472,
    -0.005314081,
    -0.024485815,
    -0.007934308,
    0.022923483,
    0.008316562,
    -0.043565348,
    0.033460256,
    0.04689882,
    -0.009348801,
    0.045105871,
    -0.019244313,
    0.010684464,
    -0.032713789,
    -0.038688108,
    0.049491748,
    -0.021911316,
    -0.051322754,
    -0.016875884,
    0.019817645,
    -0.000692038,
    0.015819065,
    -0.008604012,
    -0.010433804,
    -0.024965826,
    -0.02897929,
    0.029765835,
    -0.034911517,
    0.034686245,
    -0.021571599,
    0.015331734,
    0.016716104,
    -0.008840952,
    -0.036592517,
    0.003841884,
    0.01156463,
    0.042820826,
    0.052773971,
    0.004323614,
    0.04702102,
    0.021622762,
    0.006311521,
    0.018917069,
    0.037563089,
    0.040354498,
    -0.009826696,
    0.027518909,
    0.018642727,
    0.019793278,
    -0.017961072,
    -7.081e-05,
    -0.04714625
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs",
    "chunk_index": 3,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "ken.ThrowIfCancellationRequested();\n@@ -153,16 +240,19 @@ public class AsyncStorageSubsystem : StorageSubsystem, IAsyncStorageSubsystem\n                         pageInfo.RemoveVersion(version);\n                     }\n                     \n                     // Collect version files for deletion\n                     var namespacePath = GetNamespacePathFromPageId(pageId);\n-                    var versionFile = Path.Combine(namespacePath, $\"{GetPageFileNameFromPageId(pageId)}.v{transactionId}\");\n+                    var versionFile = Path.Combine(namespacePath, $\"{GetPageFileNameFromPageId(pageId)}{_formatAdapter.FileExtension}.v{transactionId}\");\n                     filesToDelete.Add(versionFile);\n+                    \n+                    // CRITICAL SECURITY FIX: Remove from written file paths since we're rolling back\n+                    transaction.WrittenFilePaths.Remove(versionFile);\n                 }\n \n                 transaction.IsRolledBack = true;\n-                _metadata.ActiveTransactions.Remove(transactionId);\n+                _metadata.RemoveActiveTransaction(transactionId);\n                 _activeTransactions.TryRemove(transactionId, out _);\n             }\n             \n             // Delete version files asynchronously\n             var deleteTasks = filesToDelete.Where(File.Exists).Select(async file =>\n@@ -262,66 +352,105 @@ public class AsyncStorageSubsystem : StorageSubsystem, IAsyncStorageSubsystem\n             {\n                 cancellationToken.ThrowIfCancellationRequested();\n                 return Directory.GetFiles(namespacePath, $\"*{_formatAdapter.FileExtension}.v*\");\n             }, cancellationToken).ConfigureAwait(false);\n             \n+            // Check cancellation after file enumeration but before pattern processing\n+            cancellationToken.ThrowIfCancellationRequested();\n+            \n             var regex = CreateRegexFromPattern(pattern);\n-            var pageGroups = files\n-                .Select(f => Path.GetFileName(f))\n-                .Where(f => f.Contains(\".v\"))\n-                .Select(f => {\n-                    var nameWithoutVersion = f.Substring(0, f.LastIndexOf(\".v\"));\n-                    var extensionIndex = nameWithoutVersion.LastIndexOf(_formatAdapter.FileExtension);\n-                    return extensionIndex > 0 ? nameWithoutVersion.Substring(0, extensionIndex) : nameWithoutVersion;\n-                })\n-                .Distinct()\n-                .Where(pageId => regex.IsMatch(pageId));\n-            \n-            // Process pages with proper snapshot isolation\n-            await Task.Run(() =>\n+            \n+            // Process files with frequent cancellation checks for test responsiveness\n+            var pageGroups = await Task.Run(() =>\n             {\n-                lock (_metadataLock)\n+                var processedFiles = new List<string>();\n+                \n+                foreach (var file in files)\n                 {\n-                    foreach (var pageId in pageGroups)\n+                    // Check cancellation during file processing - critical for test cancellation timing\n+                    cancellationToken.ThrowIfCancellationRequested();\n+                    \n+                    var fileName = Path.GetFileName(file);\n+                    if (fileName.Contains(\".v\"))\n                     {\n-                        cancellationToken.ThrowIfCancellationRequested();\n-                        \n-                        var fullPageId = $\"{namespaceName}:{pageId}\";\n+                        var nameWithoutVersion = fileName.Substring(0, fileName.LastIndexOf(\".v\"));\n+                        var extensionIndex = nameWithoutVersion.LastIndexOf(_formatAdapter.FileExtension);\n+                        var pageId = extensionIndex > 0 ? nameWithoutVersion.Substring(0, extensionIndex) : nameWithoutVersion;\n                         \n-                        // Record read version for conflict detection\n-                        if (_metadata.PageVersions.TryGetValue(fullPageId, out var pageInfo))\n+                        // Check pattern matchin"
}