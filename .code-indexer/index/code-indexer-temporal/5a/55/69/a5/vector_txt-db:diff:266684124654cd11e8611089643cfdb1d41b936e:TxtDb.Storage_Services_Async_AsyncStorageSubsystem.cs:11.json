{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs:11",
  "vector": [
    0.009678403,
    0.003330349,
    0.006981548,
    0.019302245,
    -0.00654474,
    -0.011816272,
    -0.007402705,
    -0.043951932,
    0.046928156,
    0.017058704,
    0.025403054,
    -0.00822522,
    0.078194998,
    -0.0119943,
    -0.065598078,
    -0.033085164,
    0.018031433,
    -0.002557969,
    -0.043620348,
    0.025953833,
    -0.023718819,
    -0.067025609,
    -0.067886077,
    0.066615365,
    -0.063635677,
    0.007909382,
    0.021498611,
    0.036012534,
    0.018908858,
    0.039348323,
    -0.009145646,
    -0.069065452,
    -0.012852828,
    0.03967616,
    0.012888967,
    -0.003268499,
    -0.023421491,
    0.011022313,
    -0.005149172,
    0.002997563,
    0.032928038,
    -0.033611294,
    0.052102879,
    -0.021351203,
    -0.00762659,
    -0.032141712,
    0.016105255,
    0.02551448,
    0.000657225,
    -0.011034005,
    -0.014971551,
    -0.016594654,
    -0.005717734,
    0.021760503,
    0.00381617,
    -0.048633039,
    0.098709174,
    0.00982582,
    -0.045718964,
    0.058927231,
    -0.018471044,
    -0.010484654,
    -0.002310158,
    0.032492127,
    -0.037057906,
    -0.029083727,
    -0.070379078,
    0.053620707,
    0.007117366,
    -0.068396941,
    -0.000310311,
    0.010966802,
    -0.00531455,
    0.022427589,
    0.030286897,
    0.028022954,
    0.044217262,
    0.026059454,
    0.03722674,
    0.030495288,
    -0.050019428,
    -0.050729267,
    0.014577919,
    -0.028256165,
    0.037360843,
    -0.033823751,
    0.014661917,
    -0.05702759,
    0.016571829,
    -0.00638434,
    -0.025181914,
    0.044278845,
    0.028808072,
    -0.006863402,
    0.013207157,
    0.038091447,
    0.044168863,
    0.019246878,
    0.017438088,
    -0.025739869,
    -0.001717316,
    0.013265125,
    -0.023219179,
    0.051690742,
    -0.050060108,
    -0.01556801,
    0.015966941,
    -0.042914785,
    0.008927967,
    0.030449813,
    0.028629828,
    0.000702885,
    0.016614422,
    -0.004504423,
    0.015623537,
    -0.016612489,
    -0.016853262,
    0.003390293,
    0.015951222,
    0.03613095,
    -0.042119805,
    0.021826219,
    -0.063236915,
    0.061190832,
    -0.009969747,
    0.022586562,
    0.025724791,
    0.032299999,
    0.007324397,
    -0.031208647,
    -0.002977144,
    -0.02164422,
    -0.001811708,
    0.007545821,
    0.009897063,
    0.034100901,
    0.032618314,
    0.021682225,
    -0.004083329,
    -0.045038365,
    0.021374645,
    0.005898788,
    -0.016318563,
    0.026706174,
    -0.003559773,
    0.012194377,
    0.036032174,
    0.000973239,
    0.015396194,
    -0.077647574,
    0.002674581,
    0.036260787,
    -0.025150113,
    0.005241995,
    0.010770996,
    0.017386546,
    -0.030437039,
    -0.016524594,
    0.005890307,
    -0.024289737,
    -0.040100299,
    0.026372129,
    -0.005608918,
    0.013902243,
    -0.032347485,
    0.031469062,
    0.011356688,
    0.010952581,
    0.031433567,
    -0.027138472,
    -0.074296616,
    0.02523916,
    -0.060812324,
    -0.020273633,
    -0.036560077,
    0.019947462,
    0.031221218,
    0.006982602,
    -0.077741899,
    -0.035462521,
    0.015469896,
    -0.004621966,
    -0.012776055,
    0.016253825,
    0.008075606,
    -0.003229657,
    0.05015726,
    0.004611125,
    0.021598715,
    0.007611083,
    -0.034340661,
    -0.005438398,
    -0.03306181,
    -0.018045468,
    -0.003374495,
    -0.026973572,
    -0.015804591,
    -0.004190953,
    0.003358002,
    0.030362923,
    -0.064244889,
    0.020850236,
    -0.089930706,
    -0.005106918,
    -0.001935506,
    -0.009618082,
    -0.029866707,
    -0.027313223,
    6.9559e-05,
    0.021149719,
    -0.008786571,
    -0.008141913,
    0.006184514,
    -0.019993197,
    0.029832099,
    0.007361119,
    -0.031230437,
    -0.011919035,
    0.048347309,
    -0.006502436,
    -0.005032373,
    -0.027804473,
    0.072656713,
    0.03714617,
    -0.020638902,
    -0.030919097,
    -0.054402854,
    -0.048240606,
    -0.031596098,
    -0.019312233,
    0.027555967,
    -0.05899287,
    0.018669484,
    -0.032949619,
    -0.049140956,
    0.079522401,
    -0.028257713,
    -0.024777496,
    -0.003374942,
    -0.020331284,
    -0.025479628,
    0.06083386,
    -0.017061431,
    0.01746407,
    -0.01912012,
    0.015144087,
    0.072327435,
    0.023148077,
    -0.014087296,
    -0.001760419,
    -0.031255264,
    0.030778671,
    -0.018938597,
    0.126064256,
    0.057691589,
    -0.000933628,
    -0.035902876,
    0.034692924,
    0.007066852,
    0.012838244,
    0.008089704,
    0.009841602,
    -0.001371523,
    0.032838225,
    -0.013729536,
    0.023478677,
    -0.039355222,
    -0.040460493,
    0.012239357,
    0.037644099,
    0.010594903,
    0.022645313,
    0.036176044,
    0.036413055,
    -0.017626835,
    -0.054431938,
    0.022216944,
    0.024099374,
    0.012008326,
    0.025581546,
    -0.035964958,
    -0.011601442,
    0.000300786,
    -0.018710669,
    -0.024858357,
    -0.034520946,
    0.027606048,
    -0.010519822,
    0.043024033,
    0.011636557,
    0.00070304,
    -0.027594972,
    -0.007536844,
    -0.018547399,
    0.050779048,
    0.021937199,
    0.037699606,
    -0.021416247,
    0.031061811,
    -0.031845283,
    -0.023670088,
    0.003702157,
    0.060753476,
    0.025406616,
    0.000947601,
    0.012611494,
    0.019896651,
    -0.017854305,
    0.029293373,
    -0.012106576,
    -0.051977292,
    -0.015002796,
    0.020825177,
    0.003784301,
    0.036355998,
    -0.066943757,
    -0.03504584,
    -0.002086846,
    -0.020733122,
    0.010368068,
    0.001035024,
    -0.015635913,
    0.01158538,
    -0.043405049,
    0.000843219,
    0.023895457,
    -0.051019866,
    -0.047221795,
    0.04596293,
    -0.023124676,
    -0.01227605,
    0.031841334,
    -0.015417525,
    0.063152589,
    0.010379178,
    0.029528821,
    -0.022400321,
    0.007384109,
    -0.039015204,
    -0.000526167,
    -0.007958089,
    -0.04579486,
    0.027692603,
    -0.032592047,
    0.055445265,
    -0.010442291,
    0.004839398,
    -0.024969568,
    -0.010145403,
    0.069456033,
    0.001612677,
    -0.055033844,
    -0.011406485,
    0.00690673,
    -0.050039489,
    0.044180289,
    -0.018412529,
    -0.000456343,
    -0.022191327,
    0.014509169,
    0.04518668,
    0.044488937,
    -0.046102423,
    -0.043918137,
    -0.00286822,
    0.01981979,
    -0.011247427,
    0.064022787,
    -0.041861545,
    0.008072085,
    -0.069699176,
    -0.072615102,
    -0.053334422,
    0.015713409,
    -0.005186202,
    0.014367021,
    0.023514399,
    -0.008105718,
    -0.019978547,
    -0.027658889,
    0.019693334,
    0.024809867,
    0.004017462,
    -0.00228118,
    -0.030630087,
    -0.008084666,
    0.028650664,
    0.033455636,
    -0.01776989,
    0.029918915,
    -0.001683382,
    0.002303875,
    0.013254671,
    0.006276359,
    -0.01835114,
    -0.026382411,
    -0.000538068,
    0.038069975,
    0.022925142,
    -0.052160472,
    0.016935214,
    -0.024336427,
    0.029872583,
    -0.066615865,
    0.028505808,
    0.006338037,
    0.021772375,
    0.030492354,
    -0.027718481,
    0.041729815,
    -0.011834492,
    0.021881791,
    -0.018511903,
    0.026249899,
    -0.025232313,
    0.04892946,
    -0.015941532,
    -0.017277803,
    0.029394474,
    -0.002263184,
    -0.03038561,
    -0.036942281,
    -0.002650979,
    -0.002334064,
    -0.032924518,
    0.015042455,
    0.001868736,
    -0.074721515,
    -0.018866848,
    -0.005470692,
    0.001258504,
    -0.017173097,
    -0.038411874,
    0.004301376,
    0.06010462,
    -0.050719894,
    0.045250725,
    -0.020712933,
    -0.049381435,
    -0.035936125,
    -0.007023382,
    -0.039130587,
    0.04460901,
    -0.021016132,
    -0.006493192,
    -0.039861925,
    0.012718634,
    0.055769786,
    -0.047208574,
    -0.025445536,
    -0.050257359,
    -0.009872416,
    -0.037280094,
    -0.002335483,
    0.067479923,
    -0.043052536,
    -0.025282122,
    0.050521597,
    -0.005986023,
    -0.033494212,
    -0.055408303,
    -0.008323848,
    -0.007165624,
    0.002587206,
    -0.008999351,
    0.026852963,
    0.024223119,
    -0.052841313,
    -0.012659254,
    0.021759031,
    0.04712842,
    -0.039640423,
    0.000609186,
    0.024585012,
    0.037246615,
    0.02774588,
    0.002748595,
    0.054394141,
    -0.026541788,
    -0.022813626,
    -0.028433725,
    -0.040293574,
    -0.016874671,
    -0.041467637,
    0.001214232,
    0.024616618,
    -0.028495835,
    0.044662256,
    0.013691751,
    -0.02401177,
    0.002214585,
    -0.015896924,
    0.000330295,
    -0.015209775,
    0.01266175,
    -0.006998726,
    -0.021358736,
    -0.026093505,
    -0.035283633,
    0.052213658,
    0.022630453,
    -0.093612045,
    0.016007466,
    -0.035341959,
    -0.02219082,
    0.039866332,
    0.014371313,
    -0.023188103,
    -0.075893611,
    0.029575126,
    -0.018944923,
    -0.027555846,
    -0.014418458,
    0.028003359,
    0.009329042,
    -0.029181385,
    -0.023370771,
    0.014867353,
    0.027973492,
    -0.012074267,
    0.022173692,
    0.01193561,
    -0.02932266,
    -0.060234781,
    -0.008087449,
    -0.014514534,
    0.012623646,
    0.009345721,
    0.010810408,
    -0.054283731,
    -0.010961269,
    0.016201882,
    -0.024187939,
    -0.050485101,
    0.041254707,
    0.006226904,
    0.015165784,
    0.008427629,
    0.007102549,
    -0.021727921,
    -0.043302942,
    -0.014672615,
    -0.025383778,
    -0.035687726,
    0.022377452,
    -0.013357121,
    0.007500022,
    0.016561892,
    -0.002231009,
    0.003832434,
    -0.012631574,
    0.036690589,
    0.026779747,
    0.056103949,
    -0.045814522,
    0.049526501,
    0.037753999,
    -0.023546167,
    0.043480001,
    -0.020937288,
    0.060155232,
    0.018360421,
    0.014819425,
    0.026030444,
    -0.047441665,
    0.018097203,
    0.045797296,
    0.000487614,
    -0.029894825,
    -0.026841259,
    0.002564007,
    -0.027510853,
    0.017228233,
    0.010699001,
    -0.034512408,
    0.042229384,
    0.042227946,
    -0.037671197,
    -0.018183466,
    -0.011317484,
    -0.017325396,
    -0.002633271,
    -0.000493076,
    0.026780669,
    -0.001157921,
    -0.069733888,
    0.028569834,
    -0.014287107,
    -0.045289718,
    -0.021469602,
    0.029500902,
    -0.031712044,
    0.017222386,
    -0.048771966,
    0.045534167,
    0.001571206,
    -0.023909582,
    -0.003521384,
    -0.006702834,
    -0.027994251,
    -0.009614808,
    0.011219057,
    0.035141535,
    0.018455284,
    0.012643801,
    -0.02331534,
    0.02537703,
    -0.009102155,
    0.053125992,
    0.035536695,
    0.014026946,
    0.001438878,
    0.082809627,
    0.001561237,
    0.029363697,
    0.034594815,
    0.013414488,
    -0.078901961,
    0.010604137,
    0.022877423,
    0.023171397,
    -0.033910803,
    -0.027153552,
    0.000879026,
    0.009193417,
    -0.017350635,
    0.015972201,
    -0.010116471,
    -0.011555569,
    0.019839788,
    -0.017887525,
    0.048412524,
    -0.063796498,
    0.011095824,
    0.014062921,
    0.010002247,
    0.014211889,
    -0.003756771,
    -0.009108588,
    0.004574472,
    -0.009291671,
    -0.003914408,
    0.032229606,
    0.045867309,
    0.056569565,
    0.037759844,
    0.024299391,
    -0.057783343,
    -0.018370815,
    0.063087463,
    0.021943865,
    0.024737546,
    0.065280989,
    0.05921787,
    0.044098288,
    0.02507069,
    0.007885014,
    -0.0156803,
    -0.026436755,
    0.014380628,
    -0.013246644,
    -0.025281485,
    -0.017065473,
    0.043604877,
    0.025648098,
    -0.028133661,
    -0.014085539,
    0.015498388,
    -0.027872533,
    -0.0139385,
    -0.029970992,
    0.025639592,
    -0.03406553,
    -0.030776117,
    0.004020156,
    -0.038190335,
    -0.008252687,
    -0.001198782,
    -0.015913224,
    -0.007778862,
    0.026178874,
    0.072513781,
    0.00285108,
    -0.014527828,
    -0.060534187,
    0.003038544,
    -0.030328423,
    0.039010063,
    -0.003451341,
    9.9701e-05,
    -0.01281679,
    -0.000416743,
    0.082322568,
    -0.028364776,
    0.008132439,
    -0.010555081,
    0.008900637,
    -0.005806777,
    -0.052048214,
    -0.040644526,
    -0.004679305,
    0.053424913,
    0.003249403,
    0.014219807,
    0.000196941,
    -0.028464958,
    -0.013745925,
    -0.023800449,
    0.07097882,
    0.004901704,
    0.005373396,
    -0.01659127,
    0.015187196,
    0.009492288,
    0.001152452,
    0.00801118,
    -0.034030218,
    -0.033285078,
    -0.021394579,
    0.027998695,
    0.031257845,
    -0.017196003,
    -0.052095469,
    0.000395987,
    -0.012916693,
    -0.006839725,
    -0.004817157,
    0.004719788,
    0.071702711,
    0.005733531,
    -0.028395511,
    0.000946888,
    0.022093648,
    0.042239521,
    -0.066560283,
    0.004418625,
    -0.065889478,
    0.033290051,
    -0.037713241,
    -0.022911543,
    0.035471991,
    0.014795369,
    -0.044612303,
    0.00802467,
    0.014244574,
    -0.009222928,
    -0.015623651,
    0.026625164,
    -0.000677208,
    -0.080921203,
    -0.019408401,
    0.000680361,
    0.005389813,
    -0.003817459,
    0.031386238,
    -0.024147229,
    -0.035075426,
    0.056415152,
    -0.022450566,
    0.042872336,
    -0.040281359,
    0.03559085,
    -0.0059251,
    -0.034603205,
    -0.01343921,
    -0.035351388,
    0.014903572,
    0.021347601,
    -0.075327076,
    0.002577471,
    -0.04279159,
    0.000432732,
    -0.046707317,
    0.014627438,
    -0.018468358,
    -0.05364703,
    0.006147534,
    0.019328607,
    -0.036026459,
    0.010978378,
    -0.00330951,
    0.01435061,
    0.026553659,
    -0.026189394,
    -0.049387235,
    -0.005681701,
    0.02137143,
    0.01224748,
    -0.044210631,
    -0.07353314,
    0.039628226,
    0.007828224,
    -0.032979697,
    0.023024462,
    0.031012941,
    0.003230175,
    -0.052303255,
    -0.021589493,
    0.01597173,
    -0.021962121,
    -0.038333505,
    0.038623199,
    0.029923903,
    0.046054427,
    -0.022656962,
    0.007091885,
    0.038201537,
    -0.007220447,
    0.044865862,
    0.017716127,
    0.010675141,
    -0.025683664,
    -0.052758832,
    0.020074243,
    0.041695364,
    -0.025211629,
    -0.065872058,
    0.026620504,
    0.015829742,
    -0.012315683,
    0.033659164,
    0.017608345,
    0.002939982,
    0.014997957,
    -0.012220724,
    0.003430987,
    -0.001269917,
    0.00744604,
    -0.000715089,
    0.014987607,
    -0.047475372,
    0.042354092,
    0.009249675,
    -0.013808073,
    0.038678981,
    -0.008898816,
    -0.02158278,
    0.052289337,
    2.4942e-05,
    -0.050635375,
    -0.003882115,
    0.008926604,
    0.016887054,
    2.089e-06,
    -0.028075082,
    -0.076821335,
    0.001501551,
    0.011318889,
    -0.03360343,
    0.01824219,
    0.00764654,
    -0.003461187,
    -0.00848379,
    -0.017833406,
    -0.021987706,
    0.061472442,
    -0.005710692,
    0.030173857,
    -0.068922758,
    -0.02490955,
    0.065791212,
    0.001746786,
    -0.028091248,
    -0.001572957,
    -0.028266285,
    -0.035496682,
    0.009560885,
    0.002588493,
    -0.046766769,
    -0.029438606,
    0.00720085,
    0.008554292,
    -0.053597208,
    -0.007236268,
    0.040817574,
    -0.006038729,
    0.026600948,
    0.005732854,
    -0.026271135,
    0.004294267,
    -0.017813766,
    0.007426913,
    0.027838487,
    0.011258196,
    0.020573849,
    -0.027550476,
    -0.021128038,
    -0.037557855,
    -0.024738237,
    0.033263344,
    -0.048482999,
    -0.004069723,
    -0.026146183,
    0.043027066,
    0.03679271,
    0.048691135,
    -0.005557922,
    -0.011400349,
    -0.005575137,
    0.036858596,
    0.003020836,
    0.03927068,
    -0.027603677,
    0.051485386,
    0.046309084,
    0.018462822,
    -0.013174682,
    0.003200356,
    0.018423166,
    0.035168067,
    0.015548472,
    -0.039509851,
    0.00116162,
    -0.028220858,
    -0.006333559,
    -0.007562151,
    0.03188283,
    0.056513567,
    0.020626886,
    -0.029180683,
    0.022666268,
    -0.020085273,
    0.006015651,
    0.013729166,
    0.018227423,
    0.009750549,
    -0.059014231,
    -0.011885657,
    -0.054400951,
    0.02279757,
    -0.039168414,
    -0.004740094,
    -0.01502589,
    0.018002013,
    0.008005446,
    -0.012094531,
    0.000320554,
    0.056737091,
    0.037747554,
    -0.018223515,
    0.00795482,
    -0.021102782,
    -0.050612241,
    0.002294364,
    -0.054637499,
    0.020289974,
    0.008014921,
    0.041291337,
    -0.004032895,
    -0.023124734,
    -0.004325595,
    -0.002519484,
    0.024113866,
    0.024892557,
    0.04318057,
    0.030326752,
    -0.043377195,
    -0.021635676,
    -0.055164572,
    -0.020726014,
    0.0033427,
    -0.001972875,
    0.043864872,
    0.014292005,
    0.021140678,
    0.003972109,
    0.059728831,
    0.043923952,
    0.010457152,
    0.033737499,
    -0.011449254,
    -0.017693831,
    -0.038328584,
    -0.022648297,
    -0.020417668,
    -0.020234449,
    0.014869362,
    0.001067996,
    -0.048997562,
    0.01890832,
    0.044054594,
    0.010104718,
    0.050970271,
    -0.007696964,
    0.000168977,
    -0.034731042,
    -0.028946992,
    0.027137984,
    -0.04162655,
    -0.016749436,
    -0.026593244,
    0.027062433,
    0.008804046,
    0.021531325,
    0.01101209,
    0.002394199,
    -0.027624972,
    -0.030432031,
    -0.006512376,
    -0.027763607,
    0.036052879,
    -0.011195561,
    0.012028485,
    0.015960654,
    0.013644156,
    -0.014433281,
    0.023872403,
    0.003409728,
    0.048895523,
    0.044955119,
    0.004249257,
    0.044226259,
    0.024578046,
    0.024541872,
    -0.01594577,
    0.005103949,
    0.049176607,
    -0.029153088,
    0.022866596,
    -0.019408479,
    0.006328162,
    -0.042286962,
    0.016085105,
    -0.035628263
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs",
    "chunk_index": 11,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "n.ThrowIfCancellationRequested();\n+                    if (!_metadata.PageVersions.TryGetValue(fullPageId, out var pageInfo))\n+                    {\n+                        pageInfo = new PageVersionInfo();\n+                        _metadata.PageVersions[fullPageId] = pageInfo;\n+                    }\n+                    \n+                    pageInfo.AddVersion(transactionId);\n+                    MarkMetadataDirty();\n+                    \n+                    // VERSION TRACKING: Maintain proper version metadata for concurrency control\n+                }\n+            }, cancellationToken).ConfigureAwait(false);\n+        }\n+        catch (TaskCanceledException ex) when (ex.CancellationToken == cancellationToken)\n+        {\n+            // Convert TaskCanceledException to OperationCanceledException for consistent exception handling\n+            throw new OperationCanceledException(\"Operation was cancelled during page version write\", ex, cancellationToken);\n+        }\n     }\n     \n     private async Task FlushToDiskAsync(string filePath, CancellationToken cancellationToken)\n     {\n         await Task.Run(() =>\n         {\n             cancellationToken.ThrowIfCancellationRequested();\n             \n-            // Force immediate write to disk\n-            using var fs = new FileStream(filePath, FileMode.Open, FileAccess.Read, FileShare.Read);\n+            // CRITICAL FIX: Force immediate write to disk using proper file access\n+            // Opening with FileAccess.Read makes Flush() a no-op, compromising durability guarantees\n+            // Must use ReadWrite access to ensure actual flushing occurs\n+            using var fs = new FileStream(filePath, FileMode.Open, FileAccess.ReadWrite, FileShare.Read);\n             fs.Flush(flushToDisk: true);\n             \n             // Track flush operation count\n             lock (_flushCountLock)\n             {\n@@ -726,23 +989,23 @@ public class AsyncStorageSubsystem : StorageSubsystem, IAsyncStorageSubsystem\n     {\n         await Task.Run(async () =>\n         {\n             cancellationToken.ThrowIfCancellationRequested();\n             \n+            // CRITICAL FIX: Create a snapshot to prevent concurrent modification exceptions during serialization\n+            // This prevents \"Collection was modified; enumeration operation may not execute\" errors\n             _metadata.LastUpdated = DateTime.UtcNow;\n+            var snapshot = _metadata.CreateSnapshot();\n+            \n             var metadataFile = Path.Combine(_rootPath, $\".versions{_formatAdapter.FileExtension}\");\n-            var content = _formatAdapter.Serialize(_metadata);\n+            var content = _formatAdapter.Serialize(snapshot);\n             await File.WriteAllTextAsync(metadataFile, content, cancellationToken).ConfigureAwait(false);\n             \n-            if (_config.EnableBatchFlushing && _batchFlushCoordinator != null)\n-            {\n-                await _batchFlushCoordinator.QueueFlushAsync(metadataFile, FlushPriority.Critical).ConfigureAwait(false);\n-            }\n-            else\n-            {\n-                await FlushToDiskAsync(metadataFile, cancellationToken).ConfigureAwait(false);\n-            }\n+            // CRITICAL PRIORITY BYPASS: Metadata persistence is always critical and must bypass batching\n+            // to ensure immediate durability guarantees for transaction state consistency.\n+            // Always use direct synchronous flush for metadata files.\n+            await FlushToDiskAsync(metadataFile, cancellationToken).ConfigureAwait(false);\n         }, cancellationToken).ConfigureAwait(false);\n     }\n     \n     private async Task LoadOrCreateConfigAsync(CancellationToken cancellationToken)\n     {\n@@ -785,15 +1048,27 @@ public class AsyncStorageSubsystem : StorageSubsystem, IAsyncStorageSubsystem\n             var metadataFile = Path.Combine(_rootPath, $\".versions{_formatAdapter.FileExtension}\");\n             \n             if (File.Exists(metadataFile))\n             {\n                 var content = await File.ReadAllTextAsync(metadataFile, cancellationToken).ConfigureAwait(false);\n"
}