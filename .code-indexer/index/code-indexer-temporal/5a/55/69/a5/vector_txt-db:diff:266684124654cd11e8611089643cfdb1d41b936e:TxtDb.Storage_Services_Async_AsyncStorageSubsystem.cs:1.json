{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs:1",
  "vector": [
    0.033587381,
    -0.002752149,
    -0.005924084,
    0.036778934,
    -0.025850913,
    0.003724478,
    -0.005679496,
    -0.037447169,
    0.043164983,
    -0.012163322,
    0.049092587,
    -0.008862801,
    0.085339971,
    -0.009898406,
    -0.058988903,
    -0.032177474,
    0.027040241,
    -0.007303561,
    -0.028027734,
    0.004764266,
    -0.028648891,
    -0.05292454,
    -0.064687312,
    0.080340117,
    -0.038710497,
    0.018016718,
    0.019934848,
    0.04561761,
    0.017661253,
    0.036986999,
    -0.008768874,
    -0.074377365,
    0.007481562,
    0.013573422,
    0.012986206,
    -0.026197484,
    -0.033970695,
    0.010393608,
    0.003967547,
    0.002748769,
    0.041361406,
    -0.00764191,
    0.056235313,
    -0.00566525,
    0.004799732,
    -0.065455303,
    0.027640924,
    0.005452384,
    0.012139094,
    -0.007965874,
    -0.016366966,
    -0.018753901,
    -0.004722304,
    0.04026882,
    0.020634655,
    -0.029295368,
    0.093843065,
    0.011915962,
    -0.04412118,
    0.076135986,
    -0.029002728,
    0.00156781,
    0.01683959,
    0.036156546,
    -0.00688084,
    -0.008784386,
    -0.073025368,
    0.058732811,
    0.009005096,
    -0.08491683,
    0.023634978,
    0.023394873,
    0.012676454,
    0.026740955,
    0.010905406,
    0.021413896,
    0.012185927,
    0.01559261,
    0.029488869,
    0.024169106,
    -0.052762508,
    -0.061333645,
    -0.028511258,
    -0.02753092,
    0.043676272,
    -0.026919652,
    0.04271742,
    -0.053575855,
    0.039500777,
    0.004581408,
    -0.028095106,
    0.028099684,
    0.025394941,
    0.047585167,
    0.031292886,
    0.018056059,
    0.024991004,
    0.019575961,
    0.019950168,
    0.008422262,
    -0.019245991,
    -0.001740916,
    0.003278989,
    0.05267505,
    -0.063924357,
    0.001210888,
    0.012274646,
    -0.031108942,
    0.028859884,
    0.016871216,
    0.032214493,
    0.004185312,
    0.020518104,
    0.011014142,
    0.038524885,
    0.006305629,
    -0.009533117,
    -0.040589899,
    0.01422431,
    0.025319409,
    -0.038822759,
    0.044861834,
    -0.066852912,
    0.049691059,
    -0.024101265,
    0.021765785,
    0.0129926,
    0.028690856,
    0.016174361,
    -0.021745978,
    -0.008635811,
    -0.015968947,
    0.002193096,
    0.017321732,
    -0.007158774,
    0.022425126,
    0.056962173,
    0.021356393,
    -0.019096682,
    -0.041938752,
    0.018635718,
    -0.012902974,
    0.007935427,
    0.005030222,
    0.002999852,
    0.002521613,
    0.039154232,
    0.00486486,
    0.02816253,
    -0.04721966,
    -0.006303715,
    0.047748931,
    -0.034714069,
    0.013711431,
    0.002825003,
    0.022252198,
    -0.011433333,
    -0.059897453,
    0.011311254,
    -0.009935907,
    -0.029314233,
    0.037818126,
    0.005027532,
    0.024632202,
    -0.028879181,
    0.027197646,
    0.006374432,
    0.009907124,
    0.01587313,
    -0.016268456,
    -0.063275248,
    0.011808976,
    -0.043344591,
    -0.024108279,
    -0.021365874,
    0.008810082,
    0.010515749,
    0.016056815,
    -0.080178559,
    -0.037615057,
    0.001721998,
    0.01569937,
    -0.01769026,
    -0.00749842,
    -0.001947342,
    -0.010954147,
    0.038815212,
    0.016587123,
    0.021753632,
    0.012128672,
    -0.017984994,
    -0.010510509,
    -0.029007701,
    -0.026248975,
    -0.005273588,
    -0.018866582,
    -0.010518746,
    0.003430688,
    0.01683294,
    0.034319155,
    -0.053585537,
    0.026162189,
    -0.090752304,
    -0.047850978,
    0.01919494,
    -0.007162767,
    -0.022929154,
    -0.000766925,
    8.851e-05,
    0.018493716,
    0.005137298,
    0.01331608,
    0.021821352,
    -0.024425467,
    0.02418315,
    -0.004880805,
    -0.029185515,
    -0.015754022,
    0.050833553,
    -0.009438672,
    0.009998881,
    -0.019653821,
    0.078201108,
    0.033114552,
    -0.031593341,
    -0.029978167,
    -0.010107353,
    -0.061416157,
    -0.043985125,
    -0.007970207,
    0.011632343,
    -0.08468996,
    0.036848616,
    -0.036522247,
    -0.031719416,
    0.06918893,
    -0.000919555,
    -0.033363361,
    0.003835963,
    -0.017614245,
    -0.022261586,
    0.054829907,
    -0.000884018,
    0.028947391,
    -0.009546293,
    0.007131234,
    0.070717178,
    0.001266905,
    0.017207207,
    0.01646447,
    -0.017442897,
    0.033171047,
    -0.01004817,
    0.109395981,
    0.069609925,
    -0.007032642,
    0.003052617,
    0.02275279,
    0.009692328,
    0.015004134,
    0.01874312,
    -0.011746589,
    -0.010828229,
    0.016221881,
    -0.018578971,
    0.022572139,
    -0.014390774,
    -0.02653946,
    0.001403237,
    0.056172062,
    0.025516871,
    -0.0023631,
    0.058504771,
    0.035344072,
    0.01266179,
    -0.027376005,
    0.018655304,
    0.029769681,
    0.004565332,
    0.030555686,
    -0.044278253,
    -0.01291796,
    0.001597378,
    -0.010485488,
    -0.02212071,
    -0.044793542,
    -0.005434101,
    -0.02417317,
    0.046624497,
    0.014651993,
    0.011544626,
    -0.026562871,
    -0.009082353,
    -0.046385583,
    0.02643921,
    0.032763209,
    0.021894461,
    -0.013517041,
    0.008734552,
    -0.03198541,
    -0.013620042,
    0.011998734,
    0.040890377,
    0.027511649,
    -0.003851609,
    -0.015535433,
    0.017263981,
    0.007673713,
    0.038304582,
    -0.008623439,
    -0.057846159,
    0.014499848,
    0.012664208,
    0.009635574,
    0.032700226,
    -0.052098166,
    -0.029733483,
    0.007902343,
    -0.016377576,
    0.010692848,
    0.008628557,
    -0.011949735,
    0.02309208,
    -0.030220876,
    0.026987758,
    0.022529673,
    -0.054976463,
    -0.035395432,
    0.03788105,
    -0.019970853,
    -0.015031435,
    0.024108578,
    -0.002408501,
    0.056091022,
    0.008272222,
    0.040606447,
    -0.030124541,
    0.023791905,
    -0.064057261,
    0.015080761,
    -0.021278158,
    -0.030362088,
    0.039459042,
    -0.032306802,
    0.063823044,
    -0.022744203,
    -0.020636978,
    -0.014931703,
    0.004569911,
    0.040349059,
    -0.00220859,
    -0.048412714,
    0.01443665,
    -0.003486459,
    -0.0299969,
    0.054556068,
    -0.031616502,
    0.005918941,
    -0.042288352,
    0.031478122,
    0.03653178,
    0.020898452,
    -0.049035728,
    -0.026878523,
    -0.014467875,
    -0.002912738,
    -0.03266637,
    0.086605906,
    -0.032712828,
    0.023674835,
    -0.060559928,
    -0.040974054,
    -0.039525248,
    0.012466071,
    0.010251404,
    0.016952366,
    0.031124158,
    -0.016928915,
    -0.032092918,
    -0.03748418,
    0.012349748,
    0.007798599,
    0.006259894,
    -0.00209005,
    -0.029298319,
    0.000437621,
    0.023313923,
    0.031633347,
    -0.034787729,
    0.056110989,
    0.012629352,
    0.033875186,
    0.019528514,
    -0.014866171,
    -0.031386048,
    -0.033742454,
    -0.01017614,
    0.052910756,
    0.038818695,
    -0.039808027,
    0.01141075,
    -0.0103515,
    0.022468541,
    -0.05707803,
    0.050746657,
    0.01313627,
    0.010940773,
    0.013919548,
    -0.010808225,
    0.023963427,
    -0.00708105,
    0.015865585,
    -0.002278594,
    0.029202348,
    -0.034831349,
    0.045715414,
    -0.008918531,
    -0.017721346,
    0.026521107,
    -0.010899031,
    -0.028303763,
    -0.0236858,
    0.000355058,
    -0.027040768,
    -0.011778111,
    0.029842239,
    0.002044305,
    -0.085533872,
    -0.024343893,
    -0.000514933,
    0.018459721,
    -0.02207144,
    -0.044368692,
    8.2528e-05,
    0.032874804,
    -0.060620792,
    0.029532462,
    -0.046884436,
    -0.047661029,
    -0.017700259,
    -0.012436526,
    -0.040415231,
    0.042514332,
    -0.025482025,
    0.005887831,
    -0.036640238,
    0.014476464,
    0.066781007,
    -0.042467181,
    -0.024841568,
    -0.025525102,
    -0.007923408,
    -0.014736646,
    -0.007912633,
    0.044527814,
    -0.049981806,
    -0.013209089,
    0.038490959,
    -0.017284045,
    -0.039778199,
    -0.038079996,
    -0.017305598,
    -0.008914421,
    0.029023198,
    -0.012508584,
    0.033148129,
    0.017553693,
    -0.048681013,
    -0.030034067,
    7.7164e-05,
    0.04310568,
    -0.033362295,
    -0.01385513,
    0.011236069,
    0.044786718,
    0.028421922,
    -0.037932288,
    0.062151078,
    -0.040502861,
    -0.038316976,
    -0.021807346,
    -0.046258215,
    -0.02302875,
    -0.035106365,
    -0.011223371,
    0.028603023,
    -0.028038168,
    0.026752155,
    0.02571575,
    -0.03068142,
    0.010398705,
    -0.001223362,
    0.014322678,
    -0.024936775,
    0.023018276,
    0.017927203,
    -0.025129089,
    -0.010927878,
    -0.022398783,
    0.027100058,
    0.044783432,
    -0.097539023,
    0.022692347,
    -0.027437288,
    0.004171106,
    0.029571915,
    0.008420085,
    -0.008773879,
    -0.087056197,
    0.023929024,
    -0.010708509,
    -0.026960816,
    0.000367108,
    0.037122313,
    0.030363953,
    -0.037051369,
    -0.003102741,
    0.022812055,
    0.007134934,
    0.009588758,
    0.013845455,
    0.019937623,
    -0.024964469,
    -0.063040048,
    -0.004911217,
    -0.002860462,
    0.005365047,
    0.015974503,
    0.022547394,
    -0.033782735,
    -0.010086933,
    0.028424509,
    -0.011283114,
    -0.055774719,
    0.00050176,
    -0.007245908,
    0.048699405,
    0.001974687,
    0.004925367,
    -0.023858793,
    -0.041757789,
    0.002536062,
    -0.022689812,
    -0.044360925,
    0.03684793,
    0.016729491,
    0.00109656,
    0.000630143,
    -0.018251756,
    -0.007264266,
    -0.024145922,
    0.038037568,
    0.038260333,
    0.065014847,
    -0.010798286,
    0.034126189,
    0.028681831,
    -0.030571153,
    0.049164832,
    -0.004875891,
    0.036092363,
    0.032910682,
    0.00845582,
    0.04885494,
    -0.006306337,
    0.027133314,
    0.042336628,
    0.00295018,
    -0.028480414,
    -0.027008194,
    -0.032514535,
    -0.01808724,
    0.009193267,
    0.009129257,
    -0.015985895,
    0.039559964,
    0.053591255,
    -0.045116477,
    -0.048878487,
    0.00962772,
    -0.008177806,
    -0.012194169,
    0.002222162,
    0.014909804,
    -0.027082406,
    -0.048902798,
    -0.002224046,
    -0.010772911,
    -0.047299799,
    -0.017462751,
    0.005153907,
    -0.019529996,
    0.020682964,
    -0.050113559,
    0.041391212,
    -0.013124415,
    -0.01557604,
    -0.006323617,
    -0.029798385,
    -0.01709597,
    -0.000191073,
    0.006695228,
    0.02454767,
    0.012220548,
    0.007432512,
    -0.027188309,
    0.018158546,
    0.004874622,
    0.060530603,
    0.056889787,
    -0.023272414,
    -0.004397619,
    0.074522428,
    -0.006672349,
    0.027072201,
    0.043225706,
    0.037080824,
    -0.070499063,
    -0.008099224,
    0.03976164,
    0.014440446,
    -0.026713122,
    -0.020153375,
    0.009308398,
    0.009220378,
    -0.028323516,
    0.020033639,
    -0.02795415,
    -0.000674874,
    0.011380182,
    0.010510496,
    0.032922622,
    -0.073670663,
    0.041770551,
    0.035222072,
    0.031353839,
    0.026722658,
    -0.022007788,
    0.004053077,
    0.01692367,
    -0.002671191,
    -0.01484858,
    0.025645254,
    0.051778287,
    0.015609968,
    0.038396802,
    0.015594245,
    -0.056478608,
    -0.054521989,
    0.044734649,
    0.011143454,
    0.031563029,
    0.079565652,
    0.056047838,
    0.061215047,
    0.0361146,
    0.024287993,
    -0.01156833,
    -0.026659848,
    0.006874131,
    -0.016671911,
    -0.012582405,
    -0.033979487,
    0.044534583,
    0.043044779,
    -0.029140765,
    -0.015734009,
    0.038432527,
    -0.028019769,
    -0.018917441,
    -0.011359264,
    0.016717417,
    -0.009648295,
    -0.02213309,
    -0.009983059,
    -0.022647096,
    -0.010376372,
    0.010188344,
    0.001396131,
    -0.003109469,
    0.034131479,
    0.085213803,
    -0.017159939,
    0.00017083,
    -0.0624885,
    0.004852962,
    -0.01446305,
    0.032047786,
    -0.021684468,
    0.014964751,
    0.0073609,
    -0.020107338,
    0.091418624,
    -0.028845575,
    -0.011053715,
    0.019252408,
    0.00415925,
    -0.011474122,
    -0.04955259,
    -0.048059054,
    0.002141163,
    0.044403497,
    -0.005744622,
    0.014855869,
    0.011282412,
    -0.038580149,
    -0.002914283,
    -0.010291439,
    0.046040736,
    0.020967985,
    -0.007145348,
    -0.026390141,
    0.012811666,
    0.010252886,
    -0.008255258,
    0.001063721,
    -0.02632897,
    -0.023168134,
    -0.003893526,
    0.015133991,
    0.029777827,
    -0.023538394,
    -0.068294212,
    -0.014609678,
    -0.012401813,
    -0.00826805,
    -0.011901451,
    0.002634553,
    0.065820225,
    -0.031412564,
    -0.036866155,
    0.014491499,
    0.017010242,
    0.034758672,
    -0.055127189,
    -0.008734909,
    -0.061234601,
    0.051897626,
    -0.021665102,
    -0.009523665,
    0.025555851,
    0.00279004,
    -0.042265709,
    -0.001758283,
    0.00427812,
    -0.017074216,
    -0.012660496,
    0.048315357,
    -0.002067605,
    -0.064070642,
    -0.010221241,
    0.005562432,
    -0.014705435,
    0.006872024,
    0.021005871,
    -0.024211125,
    -0.045300122,
    0.045939792,
    -0.018808905,
    0.021481004,
    -0.02738091,
    0.021644417,
    0.000833963,
    -0.044167798,
    -0.027283447,
    -0.032055743,
    -0.008839963,
    0.021523308,
    -0.080788754,
    -0.013103428,
    -0.047035728,
    0.011431753,
    -0.028870555,
    0.037703324,
    -0.060528524,
    -0.035800114,
    0.038189288,
    0.017029379,
    -0.020153185,
    0.01824341,
    -0.002630035,
    0.003646778,
    0.008990278,
    -0.017097462,
    -0.039790351,
    -0.015334654,
    0.016560713,
    0.026483925,
    -0.03421456,
    -0.045533117,
    0.05718321,
    -0.001034916,
    -0.029288102,
    0.038956523,
    0.033298761,
    -0.00917978,
    -0.037395086,
    -0.013320726,
    0.013375127,
    -0.019741684,
    -0.048020784,
    0.064059563,
    0.031763002,
    0.033392191,
    -0.030789196,
    -0.005163768,
    0.039634142,
    0.003667681,
    0.01676178,
    0.030904254,
    0.004004952,
    -0.012973499,
    -0.025802011,
    -0.005023188,
    0.050989863,
    -0.020061117,
    -0.084788546,
    0.034760974,
    0.002242622,
    -0.008003648,
    0.025797183,
    0.013309879,
    0.011719767,
    0.015937131,
    -0.017557405,
    -0.007461685,
    -0.005423114,
    0.020140482,
    -0.009679881,
    0.011133082,
    -0.039006997,
    0.032240622,
    -0.006720311,
    -0.019728562,
    0.007359894,
    0.00848756,
    -0.024050973,
    0.042589016,
    -0.013494138,
    -0.035535172,
    0.028470337,
    0.021541877,
    0.016261127,
    0.009864518,
    -0.039672922,
    -0.065230787,
    -0.011801617,
    0.012155384,
    -0.014241441,
    0.008553021,
    0.007746077,
    -0.011322808,
    0.011351781,
    -0.016833708,
    -0.021873487,
    0.0741634,
    -0.00509684,
    0.025380608,
    -0.068198211,
    -0.047606956,
    0.059402056,
    0.021964051,
    -0.005343617,
    -0.001908861,
    -0.019901194,
    -0.029906482,
    0.002056436,
    -0.011478525,
    -0.062874965,
    -0.034235835,
    -0.012700558,
    0.016047584,
    -0.045100354,
    -0.025690598,
    0.042989086,
    -0.001520578,
    0.021037653,
    -0.021677742,
    -0.030581186,
    -0.00618461,
    -0.005285148,
    -0.009738987,
    0.023810944,
    0.018653035,
    0.010881171,
    -0.032953203,
    -0.026189407,
    -0.046684869,
    -0.015472925,
    0.019741174,
    -0.03657572,
    4.0272e-05,
    -0.00511583,
    0.035590827,
    0.024034997,
    0.029813336,
    -0.005232032,
    -0.041306112,
    0.014016298,
    0.008916542,
    0.010549039,
    0.041382495,
    -0.043871984,
    0.055716228,
    0.040443845,
    0.003984387,
    -0.026094321,
    0.01875053,
    0.021649042,
    0.044320084,
    0.003952308,
    -0.024861034,
    -0.000795074,
    -0.035418361,
    -0.028486455,
    0.005204575,
    0.038964555,
    0.060580783,
    0.022829108,
    -0.027522627,
    0.002879597,
    -0.032243803,
    -0.022522591,
    0.031930268,
    0.027255861,
    0.004353548,
    -0.055402104,
    -0.002681322,
    -0.038335305,
    0.024744347,
    -0.037348311,
    -0.003330192,
    -0.018911058,
    0.0116953,
    0.015559548,
    -0.002240905,
    0.000194699,
    0.05532562,
    0.021863576,
    -0.02406485,
    0.011350372,
    -0.024589129,
    -0.060406074,
    -0.007782951,
    -0.053543627,
    0.012946914,
    0.011509583,
    0.036102749,
    -0.020606142,
    -0.021015575,
    0.008988904,
    -0.010444753,
    0.033602368,
    0.012227489,
    0.026565576,
    0.028575346,
    -0.052090582,
    -0.014695215,
    -0.053843427,
    -0.041910816,
    -0.008431738,
    0.014808541,
    0.032399092,
    0.012051887,
    0.023120321,
    0.011207667,
    0.046573784,
    0.038302634,
    0.012015838,
    0.040007558,
    0.008883633,
    -0.039582621,
    -0.037762836,
    -0.002467497,
    -0.030241325,
    -0.023277294,
    0.026260423,
    0.006334824,
    -0.054387815,
    0.02280107,
    0.027589787,
    0.004421937,
    0.027853006,
    -0.028159304,
    0.000468049,
    -0.059057377,
    -0.022348829,
    0.023126276,
    -0.060357478,
    -0.017218741,
    -0.018895531,
    -0.001991167,
    0.012692838,
    0.028912663,
    -0.008968409,
    -0.005337216,
    -0.022101963,
    -0.027714917,
    -0.001506754,
    -0.021240411,
    0.020784577,
    -0.035357255,
    0.036107861,
    0.007174602,
    0.002929932,
    -0.018704789,
    0.020546164,
    0.004831763,
    0.0571419,
    0.019709945,
    -0.002115973,
    0.034689914,
    -0.000714279,
    0.04692388,
    -0.025103549,
    0.026945947,
    0.056735933,
    -0.022465197,
    0.020979507,
    -0.019199228,
    0.02548868,
    -0.059906684,
    0.033530835,
    -0.027143152
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs",
    "chunk_index": 1,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "ns see this transaction as active immediately\n+            _activeTransactions.TryAdd(transactionId, transaction);\n+            _metadata.AddActiveTransaction(transactionId);\n+            \n+            result = transactionId;\n+        }\n+        \n+        return Task.FromResult(result);\n     }\n \n     public async Task CommitTransactionAsync(long transactionId, CancellationToken cancellationToken = default)\n     {\n         await CommitTransactionAsync(transactionId, FlushPriority.Normal, cancellationToken).ConfigureAwait(false);\n@@ -72,13 +86,15 @@ public class AsyncStorageSubsystem : StorageSubsystem, IAsyncStorageSubsystem\n         cancellationToken.ThrowIfCancellationRequested();\n         \n         if (!_activeTransactions.TryGetValue(transactionId, out var transaction))\n             throw new ArgumentException($\"Transaction {transactionId} not found or already completed\");\n \n-        // Perform commit logic in thread pool to avoid blocking calling thread\n-        await Task.Run(async () =>\n+        // CRITICAL PERFORMANCE OPTIMIZATION: For critical operations, skip Task.Run entirely\n+        // and execute synchronously to avoid thread pool overhead and context switching delays\n+        if (flushPriority == FlushPriority.Critical)\n         {\n+            // Execute critical path synchronously for maximum performance\n             cancellationToken.ThrowIfCancellationRequested();\n             \n             lock (_metadataLock)\n             {\n                 cancellationToken.ThrowIfCancellationRequested();\n@@ -107,26 +123,97 @@ public class AsyncStorageSubsystem : StorageSubsystem, IAsyncStorageSubsystem\n                     {\n                         pageInfo.CurrentVersion = version;\n                     }\n                 }\n \n+                // CRITICAL MVCC FIX: Advance CurrentTSN to this transaction's ID upon commit\n+                // This makes the committed data visible to future transactions\n+                _metadata.CurrentTSN = Math.Max(_metadata.CurrentTSN, transactionId);\n+\n                 transaction.IsCommitted = true;\n-                _metadata.ActiveTransactions.Remove(transactionId);\n+                _metadata.RemoveActiveTransaction(transactionId);\n                 _activeTransactions.TryRemove(transactionId, out _);\n             }\n             \n-            // Async metadata persistence with appropriate flush priority\n-            if (_config.EnableBatchFlushing && _batchFlushCoordinator != null)\n+            // CRITICAL BYPASS: Completely bypass BatchFlushCoordinator for critical operations\n+            // Use direct synchronous flush for both transaction files and metadata\n+            // This prevents any batching delays and ensures immediate durability\n+            \n+            // First, flush all files written by this transaction directly to disk\n+            if (transaction.WrittenFilePaths.Count > 0)\n             {\n-                var metadataFile = Path.Combine(_rootPath, $\".versions{_formatAdapter.FileExtension}\");\n-                await _batchFlushCoordinator.QueueFlushAsync(metadataFile, flushPriority).ConfigureAwait(false);\n+                await FlushFilesDirectlyAsync(transaction.WrittenFilePaths, cancellationToken).ConfigureAwait(false);\n             }\n-            else\n+            \n+            // Then, flush metadata directly without using BatchFlushCoordinator\n+            await PersistMetadataAsync(cancellationToken).ConfigureAwait(false);\n+            \n+            // Increment direct flush counter to track critical bypass usage\n+            lock (_flushCountLock)\n             {\n-                await PersistMetadataAsync(cancellationToken).ConfigureAwait(false);\n+                _flushOperationCount++;\n             }\n-        }, cancellationToken).ConfigureAwait(false);\n+        }\n+        else\n+        {\n+            // For normal operations, use Task.Run to avoid blocking calling thread\n+            await Task.Run(async () =>\n+            {\n+                cancellationToken.ThrowIfCancellationRequested();\n+                \n+                lock (_metadataLock)\n+        "
}