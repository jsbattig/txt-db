{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs:0",
  "vector": [
    0.035273921,
    0.016993782,
    -0.005151123,
    0.025348004,
    -0.025962854,
    -0.012164093,
    -0.007650794,
    -0.040920984,
    0.031000547,
    0.010337071,
    0.05529752,
    0.011725861,
    0.096180938,
    0.004440274,
    -0.068913147,
    -0.042320337,
    0.037907418,
    0.010859231,
    -0.031928945,
    0.022513259,
    -0.045902018,
    -0.045607142,
    -0.047143485,
    0.07584583,
    -0.047814962,
    0.001108846,
    0.016253553,
    0.061178368,
    0.019162633,
    0.054806959,
    -0.011672382,
    -0.043912243,
    0.007787965,
    0.024354903,
    0.004721843,
    0.005577955,
    -0.017115839,
    0.012137615,
    -0.011254055,
    0.007944132,
    0.057536215,
    -0.008070605,
    0.048312683,
    7.0355e-05,
    -0.003515822,
    -0.072295986,
    0.043311939,
    0.01249426,
    0.013178922,
    0.004058251,
    -0.012251681,
    -0.011217894,
    -0.004742513,
    0.03117949,
    0.025270941,
    -0.026941421,
    0.093994975,
    0.019637581,
    -0.060565159,
    0.058184702,
    -0.02321534,
    -0.01015928,
    0.004046428,
    0.034553237,
    -0.011462595,
    -0.022818971,
    -0.064204089,
    0.055839423,
    0.024171857,
    -0.075108379,
    0.003929009,
    0.014253575,
    0.024281753,
    0.020722628,
    0.0218882,
    0.027292056,
    0.028417885,
    0.001484572,
    0.02399038,
    -0.006237241,
    -0.072550505,
    -0.075930312,
    -0.019303322,
    -0.027646547,
    0.040392153,
    -0.035340667,
    0.03640252,
    -0.056512747,
    0.031539995,
    0.009213626,
    -0.025963735,
    0.044196293,
    0.02863563,
    0.045220945,
    0.046266608,
    0.018127372,
    0.01759393,
    0.00234747,
    0.049499951,
    -0.002437779,
    -0.013527377,
    0.012910489,
    -0.020251108,
    0.040177457,
    -0.052264623,
    0.022489969,
    0.018645104,
    -0.014274734,
    0.029158603,
    0.022370461,
    0.047686864,
    -0.001558429,
    0.006264443,
    -0.002378798,
    0.034188926,
    0.006668717,
    -0.021106295,
    -0.027264632,
    0.021446312,
    0.029326038,
    -0.025789989,
    0.040774655,
    -0.048450358,
    0.046771921,
    -0.034338713,
    0.027060302,
    0.016011767,
    0.015606265,
    0.003306834,
    -0.040631551,
    0.007793732,
    0.017758029,
    -0.00692231,
    -0.000488705,
    0.005709653,
    0.044954002,
    0.055099372,
    0.026581645,
    -0.009398322,
    -0.036256518,
    0.023105817,
    -0.024506418,
    0.005541248,
    0.005207934,
    -0.005864616,
    -0.000989515,
    0.041063964,
    -0.020881921,
    0.034044627,
    -0.057339814,
    0.019167474,
    0.050172336,
    -0.020007454,
    0.015980368,
    -0.005195585,
    0.030136399,
    0.012014192,
    -0.045125768,
    0.006464325,
    -0.004644841,
    -0.041559026,
    0.045902982,
    0.025468905,
    0.025040749,
    -0.021279978,
    0.034504082,
    -0.000465318,
    0.007576218,
    0.004371869,
    -0.021213228,
    -0.065508418,
    0.010310479,
    -0.02188761,
    -0.024211193,
    -0.013925695,
    0.010529034,
    0.005138637,
    -0.003044407,
    -0.082057036,
    -0.025338704,
    -0.010207822,
    0.025416454,
    -0.003170431,
    0.004710007,
    -0.001470429,
    -0.009895989,
    0.034995999,
    -0.002268926,
    0.000599413,
    0.018767811,
    -0.023190549,
    -0.018650236,
    -0.03285687,
    -0.018207513,
    -0.004764392,
    -0.022073504,
    -0.009150427,
    0.001491187,
    0.026976623,
    0.012358405,
    -0.048334919,
    0.025023807,
    -0.075928897,
    -0.044172358,
    0.012000203,
    0.021862492,
    -0.016598905,
    -0.027482213,
    0.002365316,
    0.023979159,
    -0.001530983,
    0.001428775,
    0.033725623,
    -0.025907066,
    0.004883719,
    0.01115983,
    -0.049214814,
    -0.0006547,
    0.054407615,
    0.000944651,
    0.013365623,
    -0.001616772,
    0.076683395,
    0.031722728,
    -0.050706699,
    -0.032626569,
    -0.03606708,
    -0.054130986,
    -0.034767035,
    -0.019897316,
    0.003363123,
    -0.05386024,
    0.034868024,
    -0.048992399,
    -0.034419391,
    0.0602322,
    -0.010326874,
    -0.034794107,
    -0.007110644,
    -0.013306508,
    -0.031414799,
    0.041520596,
    -0.003514519,
    0.028447403,
    -0.038909048,
    0.013067312,
    0.065298542,
    0.01971579,
    0.039320637,
    0.023474602,
    -0.017728096,
    0.054060102,
    -0.002358762,
    0.09250991,
    0.05270027,
    0.003153231,
    0.012600618,
    0.011643433,
    0.019596994,
    0.026658164,
    0.004127171,
    -0.010799364,
    -0.030804429,
    0.023476964,
    -0.010969196,
    0.032307047,
    -0.021518791,
    -0.019657128,
    -0.010111311,
    0.064204514,
    0.056676183,
    0.001042262,
    0.047000501,
    0.045978144,
    0.009156129,
    -0.009408767,
    0.033030197,
    0.0266042,
    0.016783325,
    0.027497852,
    -0.052127238,
    -0.03659188,
    0.011893687,
    -0.019815046,
    -0.024773106,
    -0.032964543,
    0.005056713,
    -0.015895495,
    0.029747387,
    0.025550585,
    0.016799692,
    -0.018633302,
    -0.018786926,
    -0.041754931,
    0.02866541,
    0.027502494,
    0.029234828,
    -0.012213038,
    -0.003580701,
    -0.037357386,
    0.001001249,
    0.003407807,
    0.061290633,
    0.020699712,
    0.001347666,
    -0.022833953,
    0.026054528,
    -0.005259848,
    0.030290475,
    -0.003096816,
    -0.048403934,
    0.016331967,
    0.017806228,
    0.011558713,
    0.03642131,
    -0.05402017,
    -0.017198684,
    -0.001076978,
    -0.006165824,
    0.016699063,
    0.001026534,
    -0.014167667,
    0.018225092,
    -0.034896918,
    0.027227787,
    0.006842567,
    -0.043244846,
    -0.045323074,
    0.043751933,
    -0.02171791,
    -0.02566619,
    0.009334004,
    0.0140012,
    0.049367245,
    0.009664311,
    0.051645845,
    -0.035391077,
    0.040002987,
    -0.04906065,
    0.032033212,
    -0.008839888,
    -0.039609879,
    0.033526633,
    -0.037584677,
    0.049921013,
    -0.034919102,
    -0.01697588,
    -0.008023856,
    8.9671e-05,
    0.038615953,
    -0.025732538,
    -0.058118831,
    -0.008735031,
    -0.002269024,
    -0.016801853,
    0.050841928,
    -0.015045972,
    0.009088914,
    -0.020627948,
    0.039499465,
    0.029371481,
    0.019826688,
    -0.04070894,
    -0.022033179,
    -0.019633578,
    -0.01451474,
    -0.030362954,
    0.090238467,
    -0.019764291,
    0.012833209,
    -0.065491028,
    -0.054839712,
    -0.053792126,
    -0.001495198,
    0.002611073,
    0.020542746,
    0.014094977,
    -0.018483561,
    -0.029670032,
    -0.023252225,
    0.005115468,
    0.007807148,
    0.01590604,
    -0.010493386,
    -0.008130506,
    -0.003515229,
    0.008287366,
    0.020881645,
    -0.04831297,
    0.069995284,
    0.006364027,
    0.039915454,
    0.006330363,
    -0.007173618,
    -0.022903629,
    -0.039830815,
    -0.004846463,
    0.042410545,
    0.027585614,
    -0.040998377,
    0.014253246,
    0.000263266,
    0.041510411,
    -0.075297028,
    0.033130519,
    0.027022595,
    0.00317861,
    0.006262077,
    -0.017803781,
    0.010223939,
    -0.011616183,
    0.030139539,
    0.007501666,
    0.023287356,
    -0.040223699,
    0.035608135,
    -0.001948862,
    -0.006845143,
    0.020750012,
    -0.018903136,
    -0.001569824,
    -0.022579873,
    0.002581612,
    -0.015452136,
    -0.015841292,
    0.026229458,
    0.013202057,
    -0.071963117,
    -0.033934958,
    0.007637616,
    0.009650461,
    -0.013692122,
    -0.045673799,
    -0.00700101,
    0.043090116,
    -0.05269048,
    0.0313081,
    -0.017107083,
    -0.041291866,
    -0.007808098,
    -0.011605743,
    -0.048898093,
    0.038323399,
    -0.042906463,
    -0.012965836,
    -0.023720702,
    0.045667864,
    0.035506532,
    -0.046601839,
    -0.027982241,
    -0.028388126,
    0.000592019,
    -0.012778671,
    -0.001639268,
    0.057618447,
    -0.027838748,
    -0.005198109,
    0.040337425,
    -0.006710644,
    -0.035310023,
    -0.043956067,
    -0.024018705,
    0.01014264,
    0.024937619,
    -0.013588122,
    0.031766519,
    0.022694744,
    -0.030679042,
    -0.031324357,
    -0.008398217,
    0.062875189,
    -0.017873792,
    -0.027135111,
    0.016085247,
    0.047490504,
    0.012597303,
    -0.013913278,
    0.052591998,
    -0.033349376,
    -0.042838436,
    -0.008553002,
    -0.041925117,
    -0.032908309,
    -0.053716637,
    0.001026331,
    0.027252441,
    -0.013424951,
    0.021265045,
    0.014228729,
    -0.024175894,
    -0.01366015,
    -0.009820772,
    0.007325981,
    -0.020064941,
    0.014545217,
    0.028077748,
    -0.00862323,
    -0.014977668,
    -0.009545623,
    0.036647692,
    0.063308008,
    -0.092385553,
    0.032254517,
    -0.033689626,
    0.001575896,
    0.033134889,
    0.009086902,
    -0.006741042,
    -0.107753105,
    0.042998843,
    -0.021176752,
    -0.023104193,
    -0.000111062,
    0.024751332,
    0.016914077,
    -0.040807597,
    -0.008762929,
    0.023707708,
    -0.015000099,
    0.02291888,
    -0.017880397,
    0.012404576,
    -0.022483001,
    -0.071730927,
    0.021661531,
    0.002982433,
    -0.001599234,
    0.023226216,
    0.004344248,
    -0.034331392,
    0.006657761,
    0.035004862,
    -0.028091637,
    -0.0506691,
    -0.011274015,
    -0.02123639,
    0.033365175,
    0.00877868,
    0.008089059,
    -0.00758284,
    -0.026704488,
    0.00054338,
    -0.022880765,
    -0.048393916,
    0.043062229,
    0.04628592,
    0.007147689,
    -0.004745842,
    0.003851792,
    -0.015371483,
    -0.011729376,
    0.04534803,
    0.038103707,
    0.059786104,
    -0.032878123,
    0.052086424,
    0.037707847,
    -0.018672952,
    0.048100322,
    -0.021961208,
    0.020107444,
    0.029323148,
    0.008584067,
    0.026807571,
    0.003073386,
    0.028705569,
    0.047017492,
    0.035089679,
    -0.022173954,
    0.003662026,
    -0.032046597,
    -0.023923354,
    0.022757035,
    0.012437386,
    -0.024765518,
    0.036534406,
    0.031635594,
    -0.026640588,
    -0.032967854,
    0.000468178,
    0.00666069,
    -0.018831084,
    0.01827234,
    0.002001504,
    -0.020115545,
    -0.02645671,
    -0.008896403,
    -0.018154951,
    -0.046788253,
    -0.028712526,
    0.024744071,
    -0.033988349,
    0.003482897,
    -0.042245921,
    0.044164233,
    -0.007654692,
    -0.005379469,
    -0.01309009,
    -0.012272144,
    -0.016871408,
    -0.01516698,
    0.031122981,
    0.047383334,
    0.014136496,
    0.011744689,
    -0.031926546,
    0.013513399,
    -0.020093068,
    0.061437424,
    0.041872185,
    -0.003764232,
    0.02000718,
    0.07906802,
    0.007799058,
    0.024981577,
    0.025965389,
    0.014791396,
    -0.061236039,
    -0.00032317,
    0.049901888,
    0.008114694,
    -0.041452318,
    -0.035151608,
    0.005338009,
    0.003040944,
    -0.011256314,
    0.026058804,
    -0.035288945,
    0.014089355,
    0.029539105,
    -0.02493115,
    0.018840116,
    -0.072753146,
    0.027936146,
    0.02517123,
    0.039004352,
    0.025904279,
    -0.003813689,
    0.012119876,
    0.00486498,
    0.000548411,
    -0.01755785,
    0.014452011,
    0.056111407,
    0.008389516,
    0.03224482,
    0.031702772,
    -0.058955465,
    -0.028987272,
    0.030847374,
    0.007991118,
    0.021839248,
    0.100190572,
    0.065614983,
    0.057056207,
    0.021577463,
    0.016207445,
    -0.011281907,
    -0.017258,
    -0.004424958,
    -0.017148249,
    -0.012981659,
    -0.054340832,
    0.009674619,
    0.037026752,
    -0.015494256,
    -0.004462405,
    0.053011261,
    -0.024732053,
    -0.024909096,
    -0.018005267,
    0.002239805,
    -0.023747483,
    -0.027449587,
    -0.011995258,
    -0.003718823,
    -0.012375338,
    0.007538921,
    0.003598794,
    0.004501369,
    0.0374148,
    0.081015542,
    -0.023897152,
    0.022056008,
    -0.051497046,
    -0.009971871,
    -0.027827609,
    0.019571932,
    -0.019751741,
    0.043288868,
    0.012436324,
    -0.015262503,
    0.086693041,
    -0.015312633,
    -0.021627776,
    0.011225292,
    0.001217377,
    -0.004622352,
    -0.052493278,
    -0.048571471,
    0.006774195,
    0.059407219,
    -0.013574959,
    0.016933467,
    0.013593316,
    -0.019801283,
    0.002598535,
    -0.023622036,
    0.052696262,
    0.020062307,
    -0.024820751,
    -0.011928728,
    0.006425803,
    -0.00421549,
    -0.00836581,
    -0.015023725,
    -0.043379098,
    -0.051959064,
    -0.001732832,
    0.0134299,
    0.002745997,
    -0.038164403,
    -0.066308372,
    -0.017446415,
    -0.003443635,
    0.006135648,
    0.008289131,
    0.012022139,
    0.060530514,
    -0.025491467,
    -0.028572975,
    0.007595948,
    0.012777867,
    0.037781868,
    -0.059312195,
    0.005572756,
    -0.051408205,
    0.012412943,
    -0.029697366,
    -0.011197564,
    0.008152892,
    0.016016623,
    -0.027654314,
    -0.0026523,
    -0.001571684,
    -0.005850368,
    -0.020691324,
    0.03170592,
    -0.011175769,
    -0.064471446,
    -0.005731382,
    -0.001561801,
    -0.015598278,
    -0.016053045,
    0.012336744,
    -0.029306695,
    -0.043098614,
    0.04063496,
    -0.00850666,
    0.031382278,
    -0.029829105,
    -0.00153262,
    -0.004514181,
    -0.046970014,
    -0.034943949,
    -0.03723529,
    -0.007466207,
    0.030926617,
    -0.074425414,
    -0.016638886,
    -0.040879037,
    -0.009771323,
    -0.008007669,
    0.053364392,
    -0.056438733,
    -0.029230347,
    0.053183511,
    0.009932197,
    -0.00985192,
    -0.000111933,
    -0.011349038,
    0.00731595,
    0.006101959,
    -0.021139657,
    -0.038150564,
    -0.021986762,
    0.005300459,
    0.035612658,
    -0.02160689,
    -0.066619374,
    0.055682279,
    -0.002685448,
    -0.041612465,
    0.018828457,
    0.034993,
    -0.01189765,
    -0.034486596,
    -0.009242685,
    0.00997255,
    -0.000695926,
    -0.052030753,
    0.061393298,
    0.014306813,
    0.063070022,
    -0.0117016,
    -0.000446805,
    0.039152876,
    -0.014595979,
    0.030402863,
    0.03281847,
    0.002609404,
    -0.011116139,
    -0.050091244,
    -0.002788072,
    0.052146826,
    -0.033397019,
    -0.088262945,
    0.000488313,
    -0.003880682,
    0.0052499,
    0.028933683,
    0.010456719,
    0.023545552,
    0.023798617,
    -0.034162268,
    0.010810902,
    -0.022084661,
    0.022793366,
    -0.005409793,
    0.029756086,
    -0.03684653,
    0.047135819,
    -0.009840175,
    -0.017398437,
    0.015479384,
    7.5018e-05,
    -0.035896726,
    0.043822777,
    0.009008772,
    -0.042373136,
    0.021163635,
    0.013045618,
    0.009160267,
    0.009965881,
    -0.029120034,
    -0.060163464,
    -0.014348747,
    0.015382451,
    -0.010928625,
    0.026373897,
    0.006009053,
    -0.028231792,
    0.004317135,
    -0.001849186,
    -0.016444426,
    0.07884182,
    0.014090046,
    0.043083377,
    -0.064641319,
    -0.041846313,
    0.069660693,
    0.020232854,
    0.001788589,
    -0.004316414,
    -0.024342585,
    -0.036558613,
    -0.015691418,
    -0.023381198,
    -0.05977625,
    -0.026786039,
    -0.014571938,
    0.009187482,
    -0.052640259,
    -0.030330265,
    0.019459272,
    0.010017492,
    0.029265594,
    -0.034286238,
    -0.040785301,
    0.005641168,
    -0.009066823,
    0.001106692,
    0.023895653,
    0.010148314,
    0.002875214,
    -0.045166712,
    -0.013825589,
    -0.025651345,
    -0.000514647,
    0.015712794,
    -0.032033559,
    -0.007267385,
    0.001837337,
    0.050201863,
    0.038405403,
    0.017249946,
    0.002469483,
    -0.038541801,
    -0.006487645,
    0.0068159,
    -0.002803253,
    0.038708527,
    -0.066127315,
    0.035556044,
    0.03446316,
    0.022155426,
    -0.020287706,
    0.017460857,
    0.033848472,
    0.042668018,
    0.000807012,
    -0.006650092,
    0.014311821,
    -0.029118018,
    -0.008580206,
    0.017589035,
    0.050486464,
    0.048565838,
    0.014290611,
    -0.014974375,
    0.007542212,
    -0.016294027,
    -0.018057598,
    0.023654243,
    0.049142517,
    0.005103716,
    -0.053489242,
    -0.003538065,
    -0.034744505,
    0.023207963,
    -0.029038092,
    -0.017307064,
    -0.019121783,
    0.027812233,
    0.019256974,
    -0.018491998,
    0.003828148,
    0.037835207,
    0.010562197,
    -0.031229975,
    0.001092282,
    -0.040647011,
    -0.0642557,
    -0.024975684,
    -0.062928565,
    0.013196628,
    0.01566012,
    0.032700952,
    -0.023593077,
    -0.030019494,
    0.011519094,
    -0.024381991,
    0.02202861,
    0.00242613,
    0.03102869,
    0.012052004,
    -0.044305597,
    -0.019864976,
    -0.029224221,
    -0.018678801,
    -0.00876165,
    -0.009410392,
    0.02942976,
    0.009267573,
    0.03611115,
    0.007040996,
    0.03507559,
    0.033026103,
    0.005055917,
    0.030284112,
    0.003844857,
    -0.031992305,
    -0.033951931,
    -0.014750742,
    -0.025651414,
    -0.023265848,
    0.033955991,
    0.00789181,
    -0.046516906,
    0.023090867,
    0.040410522,
    0.01042725,
    0.026210668,
    -0.020359093,
    0.014883804,
    -0.050353199,
    -0.04423438,
    0.019553736,
    -0.052358121,
    -0.030696843,
    -0.007038878,
    0.006801831,
    0.024104755,
    0.023184473,
    -0.007900385,
    -0.016439091,
    -0.006519366,
    -0.03048102,
    0.017935775,
    -0.029358441,
    0.021377569,
    -0.011821166,
    0.034404259,
    -0.013919945,
    -0.017275108,
    -0.028604157,
    0.023457294,
    0.000166312,
    0.061540585,
    0.015411709,
    0.015210923,
    0.04221293,
    0.00177912,
    0.050077744,
    -0.023234224,
    0.013307054,
    0.044731114,
    -0.032634169,
    0.010866931,
    0.002087886,
    0.027797973,
    -0.036291722,
    0.025431,
    -0.017193288
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/Async/AsyncStorageSubsystem.cs",
    "chunk_index": 0,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "@@ -26,42 +26,56 @@ public class AsyncStorageSubsystem : StorageSubsystem, IAsyncStorageSubsystem\n                 return _flushOperationCount;\n             }\n         }\n     }\n \n-    public async Task<long> BeginTransactionAsync(CancellationToken cancellationToken = default)\n+    public Task<long> BeginTransactionAsync(CancellationToken cancellationToken = default)\n     {\n         // CRITICAL: Check cancellation before any CPU-bound work\n         cancellationToken.ThrowIfCancellationRequested();\n \n-        // Use Task.Run to offload CPU-bound lock acquisition to thread pool\n-        // This allows the calling thread to continue processing other requests\n-        return await Task.Run(() =>\n+        // CRITICAL PERFORMANCE FIX: Execute synchronously for immediate response\n+        // Transaction creation is fast and doesn't benefit from thread pool offloading\n+        // Removing Task.FromResult eliminates unnecessary async overhead\n+        long result;\n+        \n+        // Check cancellation again before acquiring lock\n+        cancellationToken.ThrowIfCancellationRequested();\n+        \n+        lock (_metadataLock)\n         {\n-            // Check cancellation again before acquiring lock\n+            // Check cancellation while holding lock (keep lock time minimal)\n             cancellationToken.ThrowIfCancellationRequested();\n             \n-            lock (_metadataLock)\n+            var transactionId = _nextTransactionId++;\n+            \n+            // CRITICAL CONCURRENCY FIX: Atomic TSN management for proper snapshot isolation\n+            // The snapshot TSN represents the highest COMMITTED transaction visible to this transaction\n+            // This transaction should see all data committed up to this point, but not from concurrent transactions\n+            var snapshotTSN = _metadata.CurrentTSN;\n+            \n+            // CRITICAL: Advance CurrentTSN atomically to this transaction ID \n+            // This reserves this TSN for when this transaction commits and makes its changes visible\n+            // The Math.Max ensures TSNs always advance monotonically even under high concurrency\n+            _metadata.CurrentTSN = Math.Max(_metadata.CurrentTSN, transactionId);\n+            \n+            var transaction = new MVCCTransaction\n             {\n-                // Check cancellation while holding lock (keep lock time minimal)\n-                cancellationToken.ThrowIfCancellationRequested();\n-                \n-                var transactionId = _nextTransactionId++;\n-                var transaction = new MVCCTransaction\n-                {\n-                    TransactionId = transactionId,\n-                    SnapshotTSN = _metadata.CurrentTSN,\n-                    StartTime = DateTime.UtcNow\n-                };\n+                TransactionId = transactionId,\n+                SnapshotTSN = snapshotTSN, // Capture the consistent snapshot TSN atomically\n+                StartTime = DateTime.UtcNow\n+            };\n \n-                _activeTransactions.TryAdd(transactionId, transaction);\n-                _metadata.ActiveTransactions.Add(transactionId);\n-                _metadata.CurrentTSN = Math.Max(_metadata.CurrentTSN, transactionId);\n-                \n-                return transactionId;\n-            }\n-        }, cancellationToken).ConfigureAwait(false);\n+            // CRITICAL: Add to active transactions BEFORE releasing lock to prevent races\n+            // This ensures other concurrent operations see this transaction as active immediately\n+            _activeTransactions.TryAdd(transactionId, transaction);\n+            _metadata.AddActiveTransaction(transactionId);\n+            \n+            result = transactionId;\n+        }\n+        \n+        return Task.FromResult(result);\n     }\n \n     public async Task CommitTransactionAsync(long transactionId, CancellationToken cancellationToken = default)\n     {\n         await CommitTransactionAsync(transactionId, FlushPriority.Normal, cancellationToken).ConfigureAwait(false);\n@@ -72,13 +86,15 @@ public class AsyncStorageSubsystem : StorageSubsystem, IAsyn"
}