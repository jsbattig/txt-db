{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/StorageSubsystem.cs:3",
  "vector": [
    0.002420271,
    -0.014623181,
    0.002297587,
    0.036752719,
    0.003703615,
    -0.015721463,
    -0.027039286,
    -0.020224176,
    0.01141492,
    0.016014412,
    0.018069346,
    0.029143866,
    0.053679649,
    0.003253917,
    -0.044727989,
    -0.028787503,
    0.013886156,
    0.01692629,
    -0.027107919,
    0.015813064,
    -0.065739773,
    -0.072154276,
    -0.046533767,
    0.051756442,
    -0.069618627,
    0.009349181,
    0.026787136,
    0.049674481,
    -0.015089913,
    0.037492175,
    -0.016360585,
    -0.052340619,
    0.005016801,
    0.037285652,
    0.029693343,
    -0.011405449,
    -0.029347153,
    -0.009568652,
    -0.019915963,
    0.016942222,
    0.049469456,
    -0.036826167,
    0.035496589,
    0.000144874,
    0.012859975,
    -0.036068331,
    0.021907916,
    0.02417942,
    0.00289124,
    -0.023320304,
    -0.010538703,
    0.01480864,
    -0.006747926,
    0.053626034,
    0.02025746,
    -0.040224742,
    0.095034733,
    0.021913726,
    -0.027542556,
    0.036831416,
    -0.039333124,
    0.001977563,
    -0.015997633,
    0.017448872,
    -0.034975193,
    -0.057713147,
    -0.101916298,
    0.075394124,
    0.012687315,
    -0.07659594,
    0.006547187,
    0.056853835,
    0.029294163,
    0.028841736,
    0.000295908,
    0.027876135,
    0.02766804,
    0.007253542,
    0.051985137,
    0.027184324,
    -0.050118767,
    -0.063730605,
    0.002877828,
    -0.023404593,
    0.037996031,
    -0.026538542,
    0.042582743,
    -0.051400069,
    0.002951631,
    0.024157066,
    -0.033590607,
    0.047747843,
    0.020868933,
    0.016620485,
    0.024202205,
    0.035359751,
    0.01872771,
    0.014448703,
    0.033062089,
    -0.012164099,
    0.017529393,
    0.018532522,
    -0.013999871,
    0.055022698,
    -0.052350916,
    -0.008644917,
    0.014250871,
    -0.005294792,
    0.000391144,
    0.008524654,
    0.034652364,
    -0.004990416,
    0.018612279,
    0.003991236,
    0.027252523,
    -0.008247776,
    0.001124129,
    0.00398952,
    0.01004103,
    0.047532879,
    -0.044866405,
    -0.011081965,
    -0.056837648,
    0.058331285,
    -0.0023951,
    0.019978138,
    0.013595222,
    0.043588139,
    0.008042219,
    -0.024454052,
    -0.022804674,
    -0.017462434,
    0.02017442,
    -0.002237048,
    -0.012551308,
    0.021974344,
    0.008444603,
    0.027022244,
    -0.004252979,
    -0.054450218,
    0.038641304,
    -0.015364158,
    -0.023876188,
    -0.001348841,
    -0.022379309,
    0.039717361,
    0.005673407,
    -0.028149985,
    -0.001872411,
    -0.05373162,
    -0.018766778,
    0.061054785,
    -0.036038324,
    -0.0015462,
    -0.014579782,
    0.014548851,
    -0.008392273,
    -0.004993726,
    0.006978988,
    -0.040260013,
    -0.03090746,
    0.048992161,
    0.04290767,
    0.034839656,
    -0.032589678,
    0.048571445,
    0.004611362,
    0.021817401,
    0.034960765,
    -0.021612305,
    -0.062470008,
    0.028660724,
    -0.06464681,
    -0.025431922,
    -0.047151439,
    0.000522974,
    0.042749789,
    0.000679419,
    -0.046329532,
    -0.030101838,
    0.013190394,
    -0.031875622,
    -0.02026221,
    -0.017232703,
    0.02005467,
    -0.018027855,
    0.074321523,
    0.017104926,
    0.01689397,
    -0.017953273,
    -0.024622902,
    -0.021226333,
    -0.031651318,
    -0.026657062,
    0.003863855,
    -0.023023518,
    -0.025196487,
    0.002658816,
    0.009266347,
    0.032565061,
    -0.059761174,
    0.004686242,
    -0.093297407,
    0.000365663,
    0.014804566,
    0.023288008,
    -0.026518505,
    -0.016893737,
    0.002724472,
    0.039117381,
    -0.002313063,
    -0.019362453,
    0.009468543,
    -0.017563488,
    0.015175707,
    -0.031079153,
    -0.029009715,
    0.022299822,
    0.030971522,
    0.012573218,
    0.014679846,
    -0.006165801,
    0.041160494,
    0.021855749,
    -0.022072654,
    -0.00048427,
    -0.053745251,
    -0.064371601,
    -0.01126598,
    -0.029808963,
    0.00373982,
    -0.060363881,
    0.062621579,
    -0.055412639,
    -0.068079218,
    0.045359898,
    -0.012724848,
    -0.02180131,
    0.024273606,
    -0.022462541,
    -0.010769006,
    0.027303088,
    -0.003141933,
    0.013483623,
    -0.040528338,
    0.028903019,
    0.052161697,
    0.017133243,
    -0.010950338,
    0.024864295,
    -0.033137407,
    0.041236527,
    -0.033161342,
    0.107639313,
    0.04559904,
    -0.006177201,
    0.007446061,
    0.027532104,
    0.025151463,
    -0.005323609,
    0.019982694,
    0.009248017,
    0.008062241,
    0.040418703,
    -0.027829722,
    0.017919119,
    -0.036436167,
    -0.02725794,
    0.006442322,
    0.022331106,
    0.027915135,
    0.005546389,
    0.053149331,
    0.038249183,
    0.024546545,
    -0.029880021,
    0.01198676,
    0.05448617,
    0.00756035,
    0.022598321,
    -0.033157248,
    -0.013411875,
    -0.002016542,
    -0.025155248,
    -0.035207514,
    -0.050198749,
    0.016267186,
    -0.021270754,
    0.040009405,
    0.032588452,
    0.036571462,
    -0.000535801,
    0.00061307,
    -0.039798651,
    0.037248872,
    0.014878422,
    0.023938723,
    -0.022483271,
    0.005162742,
    -0.042036317,
    -0.004575644,
    -0.024482233,
    0.070213087,
    0.014190096,
    -0.001050967,
    0.027851615,
    0.035614118,
    -0.019041114,
    -0.00093193,
    -0.006282148,
    -0.039156869,
    -0.014632747,
    0.029453048,
    -0.039921403,
    0.016868776,
    -0.058274444,
    -0.031313971,
    -0.02484278,
    -0.033196844,
    -0.011180237,
    0.005679564,
    -0.024329187,
    0.020485764,
    -0.046229426,
    0.00616532,
    0.027179027,
    -0.040455528,
    -0.03473958,
    0.053798385,
    -0.022966672,
    -0.00358993,
    0.017844042,
    -0.015884293,
    0.041884411,
    -0.020463917,
    0.008439045,
    -0.028254438,
    0.003081588,
    -0.059420273,
    0.013005232,
    -0.008336716,
    -0.023830235,
    0.050767176,
    -0.028146714,
    0.054351129,
    -0.003715433,
    0.007084113,
    -0.018323861,
    -0.036033772,
    0.039178614,
    -0.014791643,
    -0.059627116,
    -0.011567957,
    -0.000537446,
    -0.055084884,
    0.05067084,
    -0.012988794,
    0.016473247,
    0.017226316,
    0.023364667,
    0.040876891,
    0.022153532,
    -0.055987503,
    -0.035465851,
    -0.034571763,
    0.00091351,
    -0.060306814,
    0.051439073,
    -0.015787808,
    0.027087959,
    -0.052376647,
    -0.040619146,
    -0.060558312,
    -0.010897815,
    -0.01047238,
    0.053850159,
    0.050261829,
    0.002876232,
    -0.041290391,
    -0.028480943,
    0.00815375,
    0.011590845,
    0.01696175,
    0.004060938,
    -0.025536222,
    -0.011002313,
    0.006830256,
    0.014553102,
    0.021832963,
    0.047003075,
    0.004051325,
    0.018139973,
    -0.006871154,
    0.02678154,
    -0.037939101,
    -0.048282482,
    0.01409464,
    0.043018598,
    0.003124713,
    -0.047500711,
    0.016621985,
    -0.019165609,
    0.058809847,
    -0.064143017,
    0.016179431,
    -0.010618456,
    0.019270746,
    0.041182693,
    -0.036575466,
    0.030790444,
    -0.028281193,
    0.034542229,
    -0.019960348,
    0.001331127,
    -0.054149523,
    0.019721754,
    -0.014574984,
    -0.03385897,
    0.029094001,
    0.01879237,
    0.003650828,
    -0.015606719,
    -0.005393988,
    0.006349967,
    -0.028158955,
    0.023986865,
    0.00070494,
    -0.087738872,
    -0.030205555,
    0.019424194,
    0.009178941,
    -0.002177891,
    -0.046856299,
    0.00467696,
    0.037883092,
    -0.060186613,
    0.016808931,
    0.018318914,
    -0.031449568,
    -0.042000219,
    -0.001871722,
    -0.017293297,
    0.014294803,
    -0.02079119,
    -0.000304091,
    -0.016419634,
    0.041321516,
    0.04684338,
    -0.009468235,
    -0.033359341,
    -0.052293394,
    -0.022529377,
    -0.051942367,
    -0.007755741,
    0.0806171,
    -0.022875743,
    -0.016838985,
    0.030873511,
    0.019382736,
    -0.005811646,
    -0.031898923,
    -0.015961397,
    -0.020040158,
    -0.014353913,
    0.002954595,
    0.024822982,
    0.019502737,
    -0.048818003,
    -0.020975208,
    -0.010841348,
    0.056122094,
    -0.036302332,
    -0.012382396,
    -0.001437762,
    0.018775012,
    0.037021495,
    0.011070236,
    0.039408542,
    -0.050528776,
    -0.01042564,
    -0.00975841,
    -0.049873926,
    -0.032087483,
    -0.014076119,
    -0.01040301,
    0.028022449,
    -0.028502215,
    0.013617632,
    0.013896424,
    -0.032019898,
    -0.018655024,
    -0.002003871,
    0.00606497,
    -0.001343025,
    0.022012759,
    0.002201872,
    -0.003173267,
    -0.003797106,
    -0.051064577,
    0.034160111,
    0.053670611,
    -0.073384896,
    0.010149061,
    -0.003016131,
    0.003131332,
    0.010696485,
    0.0084961,
    -0.020454884,
    -0.095007285,
    0.03617968,
    0.001591404,
    -0.025907347,
    -0.036128007,
    0.028392108,
    0.010736555,
    -0.070496187,
    -0.037344117,
    0.027491301,
    0.011895193,
    -0.02332514,
    -0.002019594,
    0.001718167,
    -0.021903956,
    -0.072998241,
    0.009990478,
    0.00129166,
    0.023533404,
    0.003677914,
    0.006657691,
    -0.045965031,
    -0.001331706,
    0.0204676,
    -0.01563767,
    -0.056572475,
    0.035373457,
    -0.044605546,
    0.038143214,
    0.00160493,
    0.007059436,
    -0.00349858,
    -0.050791591,
    0.00760815,
    0.012343314,
    -0.051415067,
    0.018504512,
    -0.012686717,
    -0.002274039,
    0.017951652,
    0.01479787,
    -0.001836867,
    -0.004193757,
    0.062055312,
    0.025852855,
    0.047906883,
    -0.032481808,
    0.067370757,
    0.022309436,
    -0.030306375,
    0.022799369,
    -0.037940245,
    0.058364213,
    0.037541676,
    0.040516715,
    0.031104529,
    -0.032338936,
    -0.006417498,
    0.048812117,
    0.010836101,
    -0.030359546,
    -0.000685402,
    0.006701531,
    -0.024344144,
    0.031758137,
    0.004818399,
    -0.014455071,
    0.015743181,
    0.0430861,
    -0.058129605,
    -0.020484185,
    -0.024513645,
    -0.00478433,
    0.019048277,
    0.013263771,
    -0.00286662,
    0.010843135,
    -0.062255289,
    0.045327075,
    -0.008054961,
    -0.032761056,
    -0.019360075,
    0.012101292,
    -0.000951368,
    0.030412333,
    -0.052053489,
    0.048974868,
    0.000984232,
    -0.008716584,
    -0.006989052,
    -0.001279116,
    -0.041561857,
    0.009362776,
    0.008034243,
    0.010292013,
    0.030805277,
    0.017577566,
    -0.012390204,
    0.036521502,
    -0.01008453,
    0.046640176,
    0.03720843,
    -0.006897491,
    0.001572601,
    0.078795791,
    -0.021347398,
    0.003446562,
    0.016409298,
    0.01292195,
    -0.091337919,
    0.007495983,
    0.023166478,
    0.043279961,
    -0.051790711,
    -0.041421883,
    0.012041017,
    -0.016685219,
    -0.005831323,
    -0.003401728,
    0.005285889,
    0.001066462,
    0.008520029,
    -0.012637165,
    0.008003468,
    -0.034097221,
    0.012147017,
    -0.016131835,
    -0.0103197,
    0.022551799,
    0.003063652,
    0.023432059,
    0.018980499,
    0.01746507,
    -0.023575859,
    -0.006730941,
    0.02347404,
    0.063854277,
    0.01178507,
    0.020004543,
    -0.058714811,
    -0.006445484,
    0.026640434,
    0.013454829,
    -0.017924748,
    0.080797799,
    0.050884113,
    0.050501995,
    0.015864374,
    0.028319515,
    -0.004586788,
    -0.027873406,
    -0.00696316,
    -0.02879742,
    -0.058091689,
    -0.028032657,
    0.025858618,
    0.030381691,
    -0.023716612,
    -0.018605402,
    0.025068922,
    -0.020556388,
    -0.047364879,
    -0.028194794,
    0.012838079,
    -0.039015356,
    -0.033236284,
    -0.00068747,
    -0.015500935,
    0.010914931,
    0.013075066,
    -0.009506811,
    -0.006528087,
    0.031279787,
    0.088380203,
    -0.020485446,
    0.003798106,
    -0.066730648,
    0.012628422,
    -0.017970091,
    0.028911216,
    -0.014051545,
    0.014169863,
    -0.003490814,
    -0.011148442,
    0.071248628,
    -0.023254864,
    0.010726474,
    -0.002730453,
    0.017073788,
    -0.020015646,
    -0.042422276,
    -0.032997392,
    -0.018690685,
    0.054399282,
    -0.011130361,
    0.021786619,
    -0.001996351,
    0.002451228,
    -0.005501131,
    -0.028735479,
    0.058159303,
    0.000735228,
    0.005747566,
    0.000528518,
    0.019759748,
    0.0145167,
    -0.016590852,
    0.002082512,
    -0.048571669,
    -0.047836687,
    -0.009830805,
    0.022944916,
    0.036014915,
    0.007607722,
    -0.022610912,
    -0.000728469,
    -0.013706475,
    0.020551179,
    -0.001562662,
    0.004114691,
    0.044759948,
    -0.00862371,
    -0.024497474,
    0.030542977,
    -0.00447367,
    0.043198332,
    -0.078337662,
    0.021626795,
    -0.048088852,
    0.015894461,
    -0.042765558,
    0.006744383,
    -0.021371556,
    0.019391762,
    -0.024096144,
    -0.001221161,
    -0.01671619,
    0.000740777,
    -0.03056908,
    0.005215616,
    -0.004903953,
    -0.07855203,
    -0.007762556,
    0.016382709,
    0.001576787,
    -0.015665645,
    0.03936163,
    0.005344959,
    -0.042781558,
    0.04732579,
    -0.013010899,
    0.034726992,
    -0.027230812,
    0.019854266,
    -0.003920029,
    -0.04349548,
    -0.037769821,
    -0.039804187,
    0.017242771,
    -0.005076464,
    -0.059257936,
    0.019418512,
    -0.05056604,
    -0.011288863,
    -0.030318251,
    0.021653026,
    -0.0391449,
    -0.04211003,
    0.031606719,
    0.00464051,
    -0.039280001,
    0.004153674,
    -0.014368767,
    0.014205582,
    0.013337956,
    -0.011812819,
    -0.038118161,
    0.014810805,
    0.0383683,
    0.048901394,
    -0.018963315,
    -0.057607375,
    0.032678768,
    0.013133266,
    -0.037884805,
    0.03431952,
    0.049384285,
    -0.007344005,
    -0.038653161,
    -0.004796107,
    0.019274101,
    9.4504e-05,
    -0.050068643,
    0.040885184,
    0.019268816,
    0.031047473,
    -0.002863571,
    -0.008910699,
    0.05311738,
    0.003662535,
    0.007329519,
    0.025605721,
    0.030649802,
    0.005487059,
    -0.034209613,
    -0.007984531,
    0.008673495,
    -0.008033033,
    -0.07948079,
    0.026568267,
    -0.005837281,
    -0.007344088,
    -0.001494103,
    0.002721056,
    0.017265797,
    0.007874155,
    -0.02672145,
    0.014060853,
    0.017636327,
    0.000664557,
    0.007531878,
    0.002824729,
    -0.038291845,
    0.041360594,
    -0.008781914,
    -0.023477592,
    0.002681756,
    -0.011384088,
    -0.020853549,
    0.036727749,
    0.023769619,
    -0.017182954,
    -0.021589579,
    -0.021003827,
    0.017211955,
    0.018307483,
    -0.03019923,
    -0.045070708,
    -0.002487527,
    0.017474744,
    -0.011447762,
    0.020929838,
    0.001343595,
    -0.019203067,
    -0.015538555,
    -0.010287892,
    -0.02152716,
    0.06413009,
    0.001367738,
    0.007949377,
    -0.067526601,
    -0.043258548,
    0.076497674,
    0.009894776,
    -0.040531922,
    -0.008759808,
    -0.045919795,
    -0.040841244,
    -0.009629574,
    0.017914891,
    -0.032591853,
    0.002542062,
    0.026874945,
    0.001147846,
    -0.045248576,
    0.002245854,
    0.027825762,
    0.010616458,
    0.015456353,
    -0.034152348,
    -0.051274881,
    -0.011061792,
    -0.021519268,
    0.025440589,
    0.021170221,
    0.017262766,
    0.019913189,
    0.005901106,
    -0.020376349,
    -0.010838605,
    -0.038799815,
    0.010986499,
    -0.039018355,
    -0.013472469,
    -0.021762464,
    0.037506528,
    0.033075023,
    0.034411944,
    0.000903698,
    -0.006489212,
    -0.018248513,
    0.033181373,
    -0.00976139,
    0.024552129,
    -0.047135457,
    0.028934257,
    0.03797809,
    0.008037631,
    -0.027405871,
    0.016034193,
    0.001793098,
    0.053597324,
    0.002326328,
    -0.030699914,
    -0.001851227,
    0.003647406,
    -0.009362617,
    -0.005860561,
    0.045512624,
    0.056805152,
    0.018716231,
    -0.031102212,
    0.011695351,
    -0.047091126,
    -0.009637785,
    0.027205434,
    0.029348815,
    0.018617196,
    -0.06786336,
    0.010586498,
    -0.065086707,
    0.020181509,
    -0.007207293,
    -0.029919745,
    -0.008330259,
    0.014929018,
    0.013492531,
    0.029878989,
    0.013420888,
    0.071786761,
    0.058976829,
    -0.038080312,
    0.020536151,
    -0.059560329,
    -0.067919284,
    -0.026161101,
    -0.044328015,
    0.01033056,
    0.004620811,
    0.029051697,
    0.018370533,
    -0.026801975,
    -0.020577665,
    -0.015623112,
    0.014723225,
    0.021319577,
    0.015119308,
    0.021477686,
    -0.060414474,
    -0.029295854,
    -0.04165893,
    0.005464091,
    -0.008252904,
    -0.016131628,
    0.064754084,
    -0.01403169,
    0.019274969,
    -0.000847779,
    0.063160457,
    0.029287498,
    -0.011067365,
    0.041672535,
    0.016042808,
    -0.028365672,
    -0.021305259,
    0.008237501,
    -0.005720214,
    -0.016709603,
    0.032516148,
    0.000721797,
    -0.046797626,
    0.022461129,
    0.03517016,
    -0.012800504,
    0.029456526,
    -0.001694994,
    -0.0055335,
    -0.028998775,
    -0.05316551,
    0.03173735,
    -0.04043277,
    -0.019818816,
    0.003940077,
    0.006955914,
    0.018164717,
    0.020205181,
    -0.01557293,
    -0.027444866,
    -0.045019671,
    -0.005854724,
    0.02233332,
    -0.025562346,
    0.021571875,
    -0.004973716,
    0.026182866,
    0.023762578,
    0.027176933,
    -0.027978763,
    0.000328581,
    0.011080791,
    0.052036636,
    0.039602086,
    0.030989274,
    0.026369752,
    0.007103194,
    0.028021861,
    -0.004417454,
    0.043250285,
    0.050881818,
    -0.010636787,
    0.027344957,
    0.009348547,
    -0.003963092,
    -0.008431819,
    -0.001561653,
    -0.024130929
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/StorageSubsystem.cs",
    "chunk_index": 3,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "sWith(\"page\") && f.Contains(\".v\"))\n                     .Select(f => {\n                         var nameWithoutVersion = f.Substring(0, f.LastIndexOf(\".v\"));\n@@ -675,25 +718,29 @@ public class StorageSubsystem : IStorageSubsystem, IDisposable\n                     })\n                     .Distinct()\n                     .OrderBy(p => p)\n                     .ToList();\n                 \n+                // ATOMIC: Page size checking and selection within the same critical section\n                 foreach (var pageId in existingPages)\n                 {\n                     var currentSize = GetCurrentPageSize(@namespace, pageId);\n                     if (currentSize + serializedSize <= maxSizeBytes)\n                     {\n+                        // ATOMIC: Page selection decision made within lock scope\n                         return pageId;\n                     }\n                 }\n             }\n             \n-            // CRITICAL FIX: Create new page with atomic page number allocation\n-            // This ensures each concurrent transaction gets a unique page number\n+            // CRITICAL ATOMIC FIX: Create new page with atomic page number allocation\n+            // This ensures each concurrent transaction gets a unique page number within the metadata lock.\n+            // The increment operation is atomic because it's protected by the same metadata lock.\n             var nextPageNumber = _nextPageNumbers[@namespace];\n             _nextPageNumbers[@namespace] = nextPageNumber + 1;\n             \n+            // ATOMIC: Page number allocation completed atomically within metadata lock scope\n             return $\"page{nextPageNumber:D3}\";\n         }\n     }\n \n     protected long GetCurrentPageSize(string @namespace, string pageId)\n@@ -728,11 +775,11 @@ public class StorageSubsystem : IStorageSubsystem, IDisposable\n             {\n                 _metadata.NamespaceOperations[@namespace] = currentCount - 1;\n             }\n             else\n             {\n-                _metadata.NamespaceOperations.Remove(@namespace);\n+                _metadata.NamespaceOperations.TryRemove(@namespace, out _);\n             }\n             MarkMetadataDirty();\n         }\n     }\n \n@@ -815,11 +862,11 @@ public class StorageSubsystem : IStorageSubsystem, IDisposable\n             Dictionary<string, PageVersionInfo> pageVersions;\n             \n             // Get snapshot of current state\n             lock (_metadataLock)\n             {\n-                activeTransactionIds = new HashSet<long>(_metadata.ActiveTransactions);\n+                activeTransactionIds = new HashSet<long>(_metadata.ActiveTransactions.Keys);\n                 pageVersions = new Dictionary<string, PageVersionInfo>(_metadata.PageVersions);\n             }\n             \n             if (activeTransactionIds.Count == 0)\n                 return; // No cleanup needed"
}