{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/StorageSubsystem.cs:2",
  "vector": [
    0.010568033,
    -0.002471601,
    0.019185128,
    0.034189373,
    0.018577026,
    -0.012974292,
    -0.008471404,
    -0.028944656,
    0.030221736,
    0.02197662,
    0.02746132,
    0.044188127,
    0.063916601,
    -0.005693337,
    -0.055028059,
    -0.049331844,
    0.024239564,
    0.010920524,
    -0.040555671,
    0.031520046,
    -0.034851927,
    -0.059679713,
    -0.047094069,
    0.050380718,
    -0.074939452,
    0.022375518,
    0.035961132,
    0.041210365,
    -0.010276154,
    0.049634237,
    -0.025990827,
    -0.058070287,
    -0.001862473,
    0.045453403,
    0.015409117,
    -0.014557025,
    -0.031279325,
    -0.00035905,
    -0.013258187,
    0.014633711,
    0.04847762,
    -0.045396216,
    0.038234815,
    -0.020255685,
    0.006850166,
    -0.043068077,
    0.024111211,
    0.011947487,
    -0.008166916,
    -0.012222067,
    -0.012696347,
    0.002658088,
    -0.003946911,
    0.03570338,
    0.006134003,
    -0.03014181,
    0.081372835,
    0.015077367,
    -0.030691644,
    0.044670768,
    -0.042581514,
    0.011776214,
    -0.006515716,
    0.017267471,
    -0.018972451,
    -0.044775981,
    -0.08390715,
    0.055633906,
    0.021675372,
    -0.070883229,
    0.005217838,
    0.043547966,
    0.008627769,
    0.019907696,
    0.011541538,
    0.028979819,
    0.021819435,
    0.012966624,
    0.040015608,
    0.013550253,
    -0.047222957,
    -0.055747189,
    0.002573093,
    -0.019550059,
    0.035809435,
    -0.013630266,
    0.029788323,
    -0.058267806,
    0.004332545,
    0.001605375,
    -0.02812203,
    0.050603457,
    0.029746749,
    0.017703541,
    0.03285639,
    0.038341172,
    0.034081791,
    0.002874389,
    0.035349764,
    -0.018452864,
    0.018810134,
    0.024484741,
    -0.013446614,
    0.051596139,
    -0.05263425,
    -0.016356211,
    0.00070514,
    0.006218485,
    0.013098153,
    0.023965171,
    0.028406104,
    0.004038494,
    0.032596264,
    -0.015293646,
    0.029154651,
    -0.008223736,
    -0.00755582,
    -0.006531728,
    -0.00076882,
    0.047311455,
    -0.039553039,
    0.001321622,
    -0.068957902,
    0.060623463,
    -0.002078008,
    0.021265769,
    0.015276163,
    0.021544339,
    0.011911556,
    -0.014405162,
    -0.021829572,
    -0.013822112,
    0.013037025,
    -0.003179798,
    0.008922701,
    0.031435467,
    0.023685275,
    0.019455275,
    0.000186481,
    -0.053580571,
    0.036607239,
    -0.001913354,
    -0.021037649,
    0.008369958,
    -0.02303897,
    0.006937832,
    0.033660762,
    0.00222779,
    0.010678691,
    -0.066867538,
    0.005672547,
    0.056743227,
    -0.035086837,
    0.016017877,
    0.004408849,
    0.019741567,
    -0.024423636,
    -0.011740646,
    3.4856e-05,
    -0.018738728,
    -0.038930085,
    0.030872047,
    0.026667379,
    0.034813095,
    -0.039905451,
    0.033687986,
    -0.004052276,
    0.018752465,
    0.019542178,
    -0.013300079,
    -0.068309419,
    0.01316901,
    -0.075849622,
    -0.033206232,
    -0.051285058,
    -0.002048274,
    0.040731344,
    0.003628582,
    -0.055118095,
    -0.040373631,
    0.01671366,
    -0.035477463,
    -0.004864435,
    -0.026027866,
    0.014328306,
    -0.022430817,
    0.070006415,
    0.009040732,
    0.023524841,
    -0.007190816,
    -0.032009441,
    -0.001449963,
    -0.00809836,
    -0.025134161,
    -0.001305196,
    -0.016555458,
    -0.030716103,
    0.007565076,
    0.030735955,
    0.03227149,
    -0.046278961,
    -0.001519146,
    -0.086206965,
    0.008004055,
    0.011691254,
    0.005241838,
    -0.02739355,
    -0.012581458,
    0.005738634,
    0.0403804,
    0.00691953,
    -0.006178019,
    0.013114801,
    -0.004825434,
    0.022177411,
    -0.01022289,
    -0.035355844,
    0.004137021,
    0.036379952,
    0.015429855,
    0.017635098,
    -0.009866171,
    0.058958754,
    0.035305146,
    -0.020610619,
    -0.008193123,
    -0.051960375,
    -0.046868775,
    -0.047708496,
    -0.028607769,
    0.00373327,
    -0.061690144,
    0.035293169,
    -0.044293035,
    -0.058848552,
    0.057327844,
    -0.001729097,
    -0.027078426,
    0.021794295,
    -0.01708822,
    -0.02866981,
    0.036924388,
    -0.02174315,
    0.004094929,
    -0.035401143,
    0.036578532,
    0.054598935,
    0.0264937,
    -0.008782418,
    0.019244703,
    -0.028041113,
    0.044211835,
    -0.010945875,
    0.117636912,
    0.046210308,
    0.003476262,
    -0.004088773,
    0.028136592,
    0.00626577,
    0.008300852,
    0.015894948,
    -0.005193952,
    -0.009192133,
    0.04210604,
    -0.028305765,
    0.019798618,
    -0.035243019,
    -0.034383912,
    -0.005528148,
    0.033357814,
    0.015644522,
    0.014189745,
    0.053063478,
    0.047614958,
    0.002484424,
    -0.040484242,
    0.02329592,
    0.040487349,
    0.022755543,
    0.023201188,
    -0.036274429,
    -0.004343526,
    0.016164938,
    -0.019277614,
    -0.035923257,
    -0.059491638,
    0.01168206,
    -0.031906269,
    0.062432248,
    0.022507209,
    0.021684799,
    -0.013778025,
    0.009717395,
    -0.044474304,
    0.039826848,
    0.012711465,
    0.028673379,
    -0.025665296,
    0.022579709,
    -0.034879163,
    -0.001827533,
    -0.007226656,
    0.073389813,
    0.007873106,
    -0.013059655,
    0.020680752,
    0.038676213,
    -0.02161824,
    0.013263454,
    -0.005949064,
    -0.026788441,
    -0.019159501,
    0.016559046,
    -0.007326422,
    0.016741199,
    -0.076720141,
    -0.029202275,
    0.000633564,
    -0.031674061,
    -0.014772226,
    0.01266299,
    -0.019941578,
    0.016276145,
    -0.05657715,
    -0.005365247,
    0.036041774,
    -0.047210656,
    -0.028436404,
    0.059820537,
    -0.015397557,
    -0.014548751,
    0.020976348,
    -0.01245656,
    0.058706298,
    -0.023717003,
    0.014102146,
    -0.033830028,
    0.000639397,
    -0.05584269,
    0.003092194,
    -0.001008839,
    -0.036472287,
    0.046075724,
    -0.028041389,
    0.053835079,
    0.000200217,
    0.002434363,
    -0.001938918,
    -0.030805435,
    0.050067391,
    0.012018103,
    -0.069222152,
    -0.011583108,
    0.003918815,
    -0.073349133,
    0.045073591,
    -0.007163721,
    0.002639534,
    0.005371275,
    0.018375052,
    0.04384188,
    0.02004263,
    -0.074078262,
    -0.027819572,
    -0.018328438,
    0.000270868,
    -0.046713389,
    0.056419984,
    -0.026012382,
    0.04173924,
    -0.062085256,
    -0.043272804,
    -0.05249048,
    0.006176315,
    -0.01347336,
    0.039403297,
    0.029906886,
    -0.002843484,
    -0.047338091,
    -0.024287825,
    0.013062322,
    0.027694052,
    0.035927687,
    -0.01278678,
    -0.026173472,
    -0.013394624,
    0.015236222,
    0.018141538,
    -0.005211304,
    0.037008736,
    -0.004409405,
    0.00197069,
    0.004991652,
    0.012682352,
    -0.040050361,
    -0.038441472,
    0.013161391,
    0.048157357,
    0.023051847,
    -0.067333788,
    0.001548882,
    -0.022304066,
    0.04514889,
    -0.055677291,
    0.027590679,
    0.001522778,
    0.021492476,
    0.044903591,
    -0.044582948,
    0.031833302,
    -0.018265121,
    0.015908411,
    -0.029354179,
    0.026819259,
    -0.043231811,
    0.023971971,
    -0.017785545,
    -0.018683821,
    0.018265421,
    0.013753355,
    -0.004779136,
    -0.015034929,
    -0.010050742,
    0.00774792,
    -0.036620457,
    0.027449882,
    0.005485505,
    -0.063148841,
    -0.016531482,
    0.016936393,
    0.008601055,
    -0.014967496,
    -0.070383281,
    -0.00353449,
    0.050489895,
    -0.053708471,
    0.033318605,
    0.003064845,
    -0.036859877,
    -0.033586979,
    -0.005033654,
    -0.033319071,
    0.021402994,
    -0.041952122,
    -0.006970655,
    -0.027537161,
    0.023220358,
    0.059687681,
    -0.019024311,
    -0.049711097,
    -0.042684902,
    -0.024795258,
    -0.038814709,
    -0.021863056,
    0.070432685,
    -0.026332853,
    -0.017890366,
    0.030386085,
    0.011962035,
    -0.030070737,
    -0.040841918,
    -0.030178878,
    -0.004403101,
    0.002460953,
    -0.015804026,
    0.03197084,
    0.011465987,
    -0.05726761,
    -0.033385836,
    -0.006362628,
    0.051767472,
    -0.030094741,
    -0.001939457,
    0.007240535,
    0.028308919,
    0.021926107,
    0.011520373,
    0.044768926,
    -0.040148254,
    -0.007647652,
    -0.00650254,
    -0.040335916,
    -0.030097438,
    -0.033540286,
    -0.003641335,
    0.03120264,
    -0.024998454,
    0.033778418,
    0.026491283,
    -0.041260414,
    -0.00701889,
    -0.006581431,
    -0.004643963,
    -0.023479529,
    0.023534035,
    -0.007940559,
    -0.003442517,
    -0.0460563,
    -0.04273963,
    0.035999198,
    0.041056488,
    -0.079252951,
    0.019303584,
    -0.0260641,
    -0.007182598,
    0.025286732,
    0.005295899,
    -0.024796626,
    -0.086956285,
    0.050017659,
    0.000954783,
    -0.027304478,
    -0.008163971,
    0.035851218,
    0.0209215,
    -0.063806698,
    -0.020893669,
    0.025002802,
    0.009914168,
    -0.029301433,
    -0.001452159,
    0.012512106,
    -0.023259094,
    -0.055284381,
    -0.000247435,
    0.010357984,
    0.014450761,
    -0.004572696,
    0.006287981,
    -0.050250843,
    -0.004704043,
    0.013878791,
    -0.022989143,
    -0.052753989,
    0.035977639,
    -0.025140665,
    0.036713917,
    0.01518485,
    0.000547092,
    -0.014658668,
    -0.038364258,
    0.001689305,
    0.006096313,
    -0.046809554,
    0.03466076,
    -0.010651592,
    0.005316031,
    0.015201474,
    0.006313024,
    0.017268723,
    -0.005272749,
    0.061608508,
    0.037899207,
    0.045853544,
    -0.037477046,
    0.058768563,
    0.038526561,
    -0.0230581,
    0.023713486,
    -0.031291418,
    0.057206064,
    0.030055368,
    0.034366276,
    0.031121504,
    -0.025585175,
    0.000350505,
    0.03991431,
    0.00915332,
    -0.029782515,
    -0.003955887,
    0.009392311,
    -0.025460264,
    0.026662681,
    -0.002118236,
    -0.021057243,
    0.045295909,
    0.037824191,
    -0.042298555,
    -0.01641066,
    -0.015635407,
    -0.022775894,
    0.004648487,
    0.00723586,
    0.008649083,
    0.013748085,
    -0.065022521,
    0.038088314,
    -0.021624109,
    -0.042239662,
    -0.025233945,
    0.02422625,
    -0.008606412,
    0.018138327,
    -0.04434609,
    0.035236478,
    0.000140067,
    -0.009977228,
    -0.032465179,
    -0.014081231,
    -0.036039397,
    0.000715629,
    0.030077608,
    -0.002203899,
    0.005928478,
    0.011626324,
    -0.012514131,
    0.036867999,
    -0.011541478,
    0.039721794,
    0.031226205,
    0.005964481,
    0.013877124,
    0.090561442,
    -0.021006424,
    0.009445125,
    0.026247881,
    0.007075733,
    -0.072376169,
    -0.001460317,
    0.020756936,
    0.035101451,
    -0.05376317,
    -0.035657547,
    0.002494034,
    -0.005048351,
    -0.007149786,
    0.004791192,
    -0.003385388,
    0.02156055,
    0.018491013,
    -0.028992929,
    0.034809079,
    -0.049404919,
    0.020057637,
    -0.006765747,
    -0.000181761,
    0.007441852,
    0.001430804,
    -0.001974668,
    0.014023087,
    0.020106265,
    -0.023791105,
    -0.001352469,
    0.028630208,
    0.04886733,
    0.018517863,
    0.0178908,
    -0.057205863,
    -0.024031525,
    0.040049922,
    0.019793747,
    0.015964247,
    0.077268459,
    0.040965762,
    0.054540019,
    0.031842388,
    0.033480298,
    -0.015071525,
    -0.011461009,
    0.003977429,
    -0.012963681,
    -0.061563641,
    -0.039339729,
    0.034428649,
    0.029308196,
    -0.03755638,
    -0.004235754,
    0.037937205,
    -0.023205109,
    -0.038384534,
    -0.045184903,
    0.025795698,
    -0.02501796,
    -0.025131727,
    -0.010483564,
    -0.006728239,
    -0.011142475,
    0.034764364,
    -0.024243636,
    -0.020946002,
    0.035862379,
    0.085977107,
    -0.017314928,
    -0.000442185,
    -0.077029668,
    0.007307616,
    -0.021204554,
    0.011652384,
    -0.016264522,
    0.007763249,
    -0.022676768,
    -0.014680625,
    0.067508303,
    -0.03734991,
    0.006372076,
    -0.005668792,
    0.019684685,
    -0.009702154,
    -0.048990261,
    -0.035942644,
    -0.020894477,
    0.052876014,
    0.000180302,
    0.032658603,
    -0.009882286,
    -0.014765022,
    -0.005537346,
    -0.033523228,
    0.044512928,
    0.004279261,
    0.002917556,
    0.002837452,
    0.015052477,
    0.027064854,
    -0.005111482,
    0.000907569,
    -0.033790294,
    -0.033650205,
    -0.014219793,
    0.028531132,
    0.037750717,
    -0.014067552,
    -0.032619584,
    0.007702995,
    -0.021645743,
    0.023892818,
    0.003916058,
    0.013706555,
    0.0413053,
    -0.011285676,
    -0.035671659,
    0.009313532,
    0.005216612,
    0.036596101,
    -0.081931509,
    0.010392965,
    -0.038560756,
    0.017820358,
    -0.032857098,
    -0.007823805,
    -0.0080017,
    0.021786176,
    -0.037307598,
    0.002007404,
    0.001892138,
    -0.021391029,
    -0.018754598,
    0.01733198,
    0.003458925,
    -0.072269686,
    0.001012872,
    0.006101224,
    0.010177886,
    -0.01197868,
    0.036022767,
    -0.011875344,
    -0.034289021,
    0.039807625,
    -0.002304567,
    0.031892478,
    -0.026966885,
    0.017008534,
    -0.007705064,
    -0.027852071,
    -0.019080102,
    -0.023193011,
    0.008630857,
    0.009345439,
    -0.07990098,
    0.010031939,
    -0.040268153,
    -0.014940371,
    -0.031463426,
    0.021773653,
    -0.018673912,
    -0.041949946,
    0.020853853,
    0.012456495,
    -0.053097222,
    -0.001747435,
    -0.015033158,
    0.011245152,
    0.001932496,
    -0.012491351,
    -0.044488974,
    -0.004772672,
    0.026499435,
    0.040358659,
    -0.029184667,
    -0.075641975,
    0.021529742,
    0.010563881,
    -0.03878336,
    0.005419852,
    0.048767891,
    -0.004349335,
    -0.045360602,
    -0.011689615,
    0.012270647,
    -0.02034083,
    -0.041441899,
    0.03965928,
    0.026925011,
    0.031310633,
    -0.000425034,
    -0.004925453,
    0.044082757,
    0.001306124,
    0.031574842,
    0.035784069,
    0.013830689,
    -0.008345319,
    -0.038999643,
    -0.013441176,
    0.031163173,
    -0.018631563,
    -0.081583835,
    0.030115172,
    -0.001895644,
    -0.006281067,
    0.008204624,
    0.012669323,
    -0.000861835,
    0.016863065,
    -0.008896234,
    0.001687339,
    -0.000330393,
    -0.004760499,
    -0.000266025,
    0.00739847,
    -0.040704716,
    0.028946534,
    -0.00568208,
    -0.009470648,
    0.016103271,
    -0.002463907,
    -0.028037829,
    0.057438064,
    0.020395245,
    -0.017335042,
    -0.017385524,
    -0.03330718,
    0.01073696,
    0.005700144,
    -0.038935903,
    -0.069833241,
    -0.011561782,
    0.016254248,
    -0.036302172,
    0.032949191,
    -0.000309927,
    -0.015465274,
    -0.019246705,
    -0.016925069,
    -0.031393543,
    0.062463701,
    0.023038795,
    0.026889969,
    -0.068010844,
    -0.050356634,
    0.068616375,
    -0.004502151,
    -0.033755828,
    -0.015708564,
    -0.046722822,
    -0.042997643,
    0.001785054,
    0.016516488,
    -0.040009372,
    0.011351997,
    0.013299258,
    0.004864372,
    -0.053640045,
    -0.009680377,
    0.040637538,
    0.002339791,
    0.012564518,
    -0.017839765,
    -0.049304906,
    -0.008545635,
    -0.023541765,
    0.024540277,
    0.023870438,
    0.026571052,
    0.025028501,
    -0.027603619,
    -0.020225573,
    -0.026347695,
    -0.028708605,
    0.029526234,
    -0.033055026,
    0.002507886,
    -0.017518319,
    0.053698547,
    0.033100192,
    0.04460384,
    0.005751845,
    -0.010979571,
    -0.012679725,
    0.035427477,
    0.004050364,
    0.045337055,
    -0.041095745,
    0.041752476,
    0.043175019,
    0.015669135,
    -0.016088922,
    0.012200749,
    0.006448383,
    0.044112071,
    0.008380481,
    -0.045186609,
    -0.013842753,
    -0.008176248,
    -0.002107138,
    3.9689e-05,
    0.055115972,
    0.040693216,
    0.022566406,
    -0.021495478,
    0.016808081,
    -0.037625469,
    -0.016510231,
    0.018146273,
    0.032052219,
    0.025597652,
    -0.076935373,
    -0.009207379,
    -0.05315173,
    0.021706128,
    -0.018104197,
    -0.011203058,
    -0.011017748,
    0.015202803,
    0.006306075,
    0.005514241,
    0.000550882,
    0.064543068,
    0.054079544,
    -0.032407805,
    0.020054026,
    -0.04385924,
    -0.065559901,
    -0.010931238,
    -0.045346692,
    0.012269859,
    0.008860759,
    0.04101298,
    0.00832598,
    -0.037347361,
    0.000910507,
    -0.006163433,
    0.019403953,
    0.037415076,
    0.020056896,
    0.023714026,
    -0.05262702,
    -0.031838574,
    -0.061730079,
    -0.005647501,
    -0.019547153,
    -0.012271047,
    0.040044572,
    -0.000125358,
    0.017261,
    0.01167493,
    0.055924829,
    0.035868466,
    0.003569998,
    0.068727911,
    0.009852816,
    -0.011963658,
    -0.030304911,
    -0.002836474,
    -0.012119107,
    -0.027967639,
    0.043994877,
    0.005710355,
    -0.048790708,
    0.025383288,
    0.039827611,
    -0.007609495,
    0.041489381,
    0.000784174,
    0.009560518,
    -0.035439398,
    -0.031397272,
    0.01686524,
    -0.012738476,
    -0.011916191,
    -0.012351016,
    -0.010221574,
    0.027462784,
    0.014547853,
    -0.009949566,
    -0.011561522,
    -0.030054517,
    -0.024791623,
    0.017730804,
    -0.024826042,
    0.020570783,
    -0.00598375,
    0.018987881,
    0.0089252,
    0.005153016,
    -0.019444786,
    0.006347843,
    0.011891392,
    0.061824482,
    0.045407295,
    0.032515034,
    0.025960114,
    0.02156264,
    0.029153081,
    -0.026203074,
    0.03118529,
    0.042450249,
    -0.011208813,
    0.017454894,
    -0.016496107,
    0.002054311,
    -0.021366272,
    -0.0159733,
    -0.0420851
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/StorageSubsystem.cs",
    "chunk_index": 2,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "data.ClearActiveTransactions();\n         }\n         else\n         {\n             _metadata = new VersionMetadata { CurrentTSN = 0 };\n             PersistMetadata();\n         }\n     }\n \n     protected void PersistMetadata()\n     {\n+        // CRITICAL FIX: Create a snapshot to prevent concurrent modification exceptions during serialization\n+        // This prevents \"Collection was modified; enumeration operation may not execute\" errors\n         _metadata.LastUpdated = DateTime.UtcNow;\n+        var snapshot = _metadata.CreateSnapshot();\n+        \n         var metadataFile = Path.Combine(_rootPath, $\".versions{_formatAdapter.FileExtension}\");\n-        var content = _formatAdapter.Serialize(_metadata);\n+        var content = _formatAdapter.Serialize(snapshot);\n         File.WriteAllText(metadataFile, content);\n         FlushToDisk(metadataFile);\n     }\n \n     protected object[] ReadPageInternal(long transactionId, string @namespace, string pageId)\n@@ -572,12 +602,13 @@ public class StorageSubsystem : IStorageSubsystem, IDisposable\n                 .OrderByDescending(v => v)\n                 .ToList();\n             \n             foreach (var version in allVersions)\n             {\n-                // Skip versions from transactions that are still active (uncommitted)\n-                if (_metadata.ActiveTransactions.Contains(version))\n+                // CRITICAL FIX: Allow current transaction to see its own writes\n+                // Skip versions from OTHER active transactions, but allow current transaction's writes\n+                if (_metadata.ContainsActiveTransaction(version) && version != transactionId)\n                     continue;\n                     \n                 // Skip rolled back versions\n                 if (IsVersionRolledBack(version))\n                     continue;\n@@ -659,14 +690,26 @@ public class StorageSubsystem : IStorageSubsystem, IDisposable\n                 }\n                 \n                 _nextPageNumbers[@namespace] = highestPageNumber + 1;\n             }\n             \n-            // Try to find a page with space (only if not forcing one object per page)\n-            if (!_config.ForceOneObjectPerPage)\n+            // CRITICAL ATOMIC CONCURRENCY FIX: Ensure transaction count check and page allocation\n+            // are performed atomically within the same metadata lock scope.\n+            //\n+            // This eliminates the TOCTOU (Time-of-Check-Time-of-Use) race condition where:\n+            // 1. Multiple threads check ActiveTransactions.Count <= 1 simultaneously\n+            // 2. All threads pass the check and proceed to page space checking\n+            // 3. Multiple threads select the same page, causing MVCC conflicts\n+            //\n+            // ATOMIC SOLUTION: Perform both the decision and page selection within the same lock,\n+            // making the entire operation atomic and preventing race condition windows.\n+            \n+            bool shouldReusePages = !_config.ForceOneObjectPerPage && _metadata.ActiveTransactions.Count <= 1;\n+            \n+            if (shouldReusePages)\n             {\n-                // Check existing pages for available space\n+                // ATOMIC: Page space checking is now within the same lock as the transaction count check\n                 var existingPages = Directory.GetFiles(namespacePath, $\"page*{_formatAdapter.FileExtension}.v*\")\n                     .Select(f => Path.GetFileName(f))\n                     .Where(f => f.StartsWith(\"page\") && f.Contains(\".v\"))\n                     .Select(f => {\n                         var nameWithoutVersion = f.Substring(0, f.LastIndexOf(\".v\"));\n@@ -675,25 +718,29 @@ public class StorageSubsystem : IStorageSubsystem, IDisposable\n                     })\n                     .Distinct()\n                     .OrderBy(p => p)\n                     .ToList();\n                 \n+                // ATOMIC: Page size checking and selection within the same critical section\n                 foreach (var pageId in existingPages)\n                 {\n                     var currentSize = GetCurrentPageSize("
}