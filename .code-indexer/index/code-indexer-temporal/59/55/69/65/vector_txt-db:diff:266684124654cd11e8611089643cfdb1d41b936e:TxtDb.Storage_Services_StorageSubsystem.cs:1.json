{
  "id": "txt-db:diff:266684124654cd11e8611089643cfdb1d41b936e:TxtDb.Storage/Services/StorageSubsystem.cs:1",
  "vector": [
    0.007206981,
    -0.003484598,
    0.026672129,
    0.04252952,
    0.023561344,
    -0.002437859,
    -0.013492757,
    -0.028404973,
    0.046011064,
    0.024310894,
    0.032466974,
    0.028389737,
    0.067354053,
    -0.003148408,
    -0.078096226,
    -0.065561183,
    -0.006548964,
    0.017804898,
    -0.031452548,
    0.024881175,
    -0.037106574,
    -0.05918429,
    -0.045170795,
    0.048699763,
    -0.078824505,
    0.016753679,
    0.036271255,
    0.026814803,
    -0.006853312,
    0.037775889,
    -0.025077377,
    -0.069159448,
    0.017251955,
    0.058750022,
    0.013645156,
    -0.020757373,
    -0.02923874,
    0.004357412,
    -0.006678398,
    0.008907462,
    0.056877371,
    -0.036199689,
    0.058511823,
    -0.017775888,
    -0.001266252,
    -0.038251266,
    0.003949878,
    0.003814474,
    -0.022950513,
    0.016325725,
    0.000411041,
    -0.001717584,
    -0.007087218,
    0.053242706,
    0.012000689,
    -0.031809591,
    0.082002111,
    0.034027308,
    -0.02718381,
    0.036327727,
    -0.030700121,
    0.016964698,
    -0.024676645,
    0.017193653,
    -0.032128688,
    -0.05355832,
    -0.070981324,
    0.069903307,
    0.006385619,
    -0.058220938,
    0.015165234,
    0.02158834,
    -0.001632672,
    0.03407241,
    0.010737963,
    0.042920228,
    0.025166756,
    0.013162793,
    0.052254807,
    0.000455013,
    -0.046247885,
    -0.080097862,
    0.009113732,
    -0.025584817,
    0.028403508,
    -0.009413348,
    0.006845733,
    -0.045862563,
    -0.002055082,
    0.000298443,
    -0.017314155,
    0.046330351,
    0.040871199,
    0.023674747,
    0.016031876,
    0.043897156,
    0.026731635,
    -0.004259598,
    0.048659336,
    -0.012274694,
    -0.000681335,
    0.002107495,
    -0.01879485,
    0.047009878,
    -0.04726306,
    -0.030764295,
    0.001585326,
    0.003969867,
    -0.001221602,
    0.016078716,
    0.032864787,
    0.016125198,
    0.031767923,
    -0.007471326,
    0.017933272,
    -0.004589258,
    -0.004458588,
    -0.013209166,
    0.026378041,
    0.053251479,
    -0.044908501,
    0.02527843,
    -0.05972787,
    0.058268502,
    -0.007542106,
    0.014078732,
    0.001621643,
    0.014037969,
    0.0142613,
    -0.030811995,
    -0.021836096,
    -0.041143123,
    -0.003145023,
    -0.002965719,
    -0.00179972,
    0.017676242,
    0.004354007,
    0.024412336,
    0.005133062,
    -0.037283182,
    0.057008218,
    0.00453256,
    -0.026437022,
    0.014041242,
    -0.00797697,
    -0.005810876,
    0.028940383,
    0.009471159,
    -0.010781862,
    -0.089814715,
    0.014934384,
    0.044586159,
    -0.024344111,
    0.016595528,
    0.002214815,
    0.016089462,
    -0.016791912,
    -0.003869796,
    -0.004045458,
    -0.033187378,
    -0.049221981,
    0.02500562,
    0.01952032,
    0.017175443,
    -0.022019558,
    0.032206509,
    -0.00637845,
    0.006207141,
    0.011427218,
    -0.011170633,
    -0.060478661,
    0.020801118,
    -0.075424738,
    -0.027852209,
    -0.044534519,
    -0.004543809,
    0.040849961,
    -0.002061828,
    -0.067181438,
    -0.06700068,
    0.017457245,
    -0.026226019,
    -0.00571731,
    -0.019093392,
    -0.003348234,
    -0.013662328,
    0.06522119,
    0.008089334,
    0.027828045,
    0.011346974,
    -0.032616939,
    0.009905228,
    -0.024933556,
    -0.024173513,
    0.002144869,
    -0.040283632,
    -0.031630423,
    0.000212318,
    0.035927702,
    0.021773815,
    -0.060016856,
    0.025169818,
    -0.089307316,
    0.017793201,
    0.000246046,
    -0.003427397,
    -0.017750297,
    -0.017863359,
    -0.00786312,
    0.031787716,
    0.005719357,
    -0.015475817,
    0.015132599,
    -0.008107201,
    0.038698621,
    -0.017105408,
    -0.040406559,
    0.012838596,
    0.058068097,
    0.022409486,
    0.022313723,
    -0.003317072,
    0.057162978,
    0.014260929,
    -0.019113956,
    -0.026014943,
    -0.049999788,
    -0.045003835,
    -0.016236911,
    -0.022255536,
    0.01602868,
    -0.062421519,
    0.015321331,
    -0.040978372,
    -0.06539768,
    0.045379397,
    -0.012161337,
    -0.022588667,
    -0.001685233,
    0.012620968,
    -0.015003137,
    0.056863535,
    -0.016555823,
    0.008237711,
    -0.005238852,
    0.029712822,
    0.043732047,
    0.026018586,
    -0.019168016,
    0.01264458,
    -0.045521017,
    0.032265056,
    -0.013838534,
    0.127562597,
    0.041210942,
    0.004413966,
    -0.02469497,
    0.008051301,
    -0.001416042,
    0.003416938,
    0.01126444,
    0.004263384,
    -0.024725124,
    0.037713196,
    -0.005851712,
    0.022129331,
    -0.015559983,
    -0.035349376,
    -0.011092287,
    0.035727393,
    0.000413423,
    0.008776105,
    0.049454901,
    0.025162298,
    0.001596734,
    -0.031985443,
    0.008159133,
    0.039037418,
    0.020499701,
    0.029919391,
    -0.038823698,
    0.002323589,
    0.023986043,
    -0.039379645,
    -0.022160992,
    -0.055443551,
    0.027773982,
    -0.044124912,
    0.046126474,
    0.022590157,
    0.030811774,
    -0.022363359,
    -0.00313928,
    -0.046199083,
    0.029478308,
    0.012947812,
    0.029851837,
    -0.015856463,
    0.046769414,
    -0.020203128,
    -0.003261318,
    -0.018627107,
    0.073215783,
    0.015073918,
    0.000842026,
    0.032307733,
    0.037451971,
    -0.037370287,
    0.008939928,
    -0.014608908,
    -0.041070275,
    -0.021886686,
    0.023058806,
    -0.004905005,
    0.02760946,
    -0.057132363,
    -0.020323226,
    -0.011863366,
    -0.032082397,
    0.00630866,
    -0.003839392,
    -0.024547623,
    0.019183913,
    -0.060314611,
    0.001929376,
    0.025476994,
    -0.075996533,
    -0.017123882,
    0.072380729,
    -0.024072086,
    -0.013890135,
    0.01192179,
    -0.012423732,
    0.058611225,
    -0.016819045,
    0.015512752,
    -0.031970963,
    0.004028314,
    -0.060935508,
    0.005400402,
    0.00921206,
    -0.039712593,
    0.027696019,
    -0.038252436,
    0.041626066,
    0.00045905,
    -0.008477561,
    -0.004253124,
    -0.036127742,
    0.050693676,
    0.012740348,
    -0.073403358,
    -0.026681416,
    0.008349235,
    -0.07250867,
    0.051605985,
    -0.007231506,
    0.010061083,
    0.015826449,
    0.019698245,
    0.023564741,
    0.031308398,
    -0.079275958,
    -0.024940906,
    -0.02435267,
    0.003658471,
    -0.052925512,
    0.054826796,
    -0.024177229,
    0.0289577,
    -0.078655429,
    -0.038938917,
    -0.036798932,
    0.000728821,
    -0.020769672,
    0.027148737,
    0.030886516,
    -0.014190413,
    -0.045414586,
    -0.017726617,
    0.012200302,
    0.024228232,
    0.035144359,
    0.001978252,
    -0.01958143,
    -0.015391536,
    0.006308098,
    0.00867717,
    0.009376878,
    0.017506724,
    -0.000401442,
    0.015747897,
    0.013090149,
    0.040728346,
    -0.025280625,
    -0.034494404,
    0.004889492,
    0.043732584,
    0.034526039,
    -0.052822828,
    0.009131265,
    -0.029036624,
    0.049618758,
    -0.072394669,
    0.035214026,
    0.00070306,
    0.028791165,
    0.0417048,
    -0.032446317,
    0.047870275,
    -0.005918372,
    0.015192921,
    -0.017258804,
    0.00156418,
    -0.033000059,
    0.024258107,
    -0.029255543,
    -0.020984147,
    0.000817883,
    0.001958788,
    0.002542115,
    -6.7094e-05,
    0.010690783,
    0.016558386,
    -0.027232362,
    0.023607012,
    0.021370726,
    -0.074374713,
    -0.032524619,
    0.000755831,
    -0.000754221,
    -0.013926157,
    -0.076833129,
    0.009903188,
    0.042545538,
    -0.06050764,
    0.021495372,
    0.010848017,
    -0.029548306,
    -0.015833776,
    0.021184752,
    -0.035714418,
    0.018446531,
    -0.043575447,
    -0.004740658,
    -0.018521585,
    0.013786711,
    0.040002123,
    -0.034827683,
    -0.055422205,
    -0.057544939,
    -0.01508552,
    -0.050950065,
    -0.006127917,
    0.062221382,
    -0.016648529,
    -0.014435722,
    0.024458319,
    0.01010971,
    -0.005858183,
    -0.021685638,
    -0.032549933,
    0.002332224,
    0.004918567,
    -0.003314159,
    0.02030658,
    0.026573107,
    -0.063426912,
    -0.013002347,
    0.005196607,
    0.044785958,
    -0.040697739,
    0.021158244,
    0.003195448,
    0.031242002,
    0.027341442,
    0.021875339,
    0.037097044,
    -0.035354208,
    -0.00789591,
    -0.020301923,
    -0.045481924,
    -0.021359064,
    -0.026658604,
    -0.01267965,
    0.016965806,
    -0.046033259,
    0.041482065,
    0.020149702,
    -0.030116903,
    0.000944022,
    -0.008809759,
    -0.009368998,
    -0.013456729,
    0.018767348,
    -0.010005249,
    -0.004747881,
    -0.051553812,
    -0.037832141,
    0.030934444,
    0.038762286,
    -0.077797592,
    0.007833363,
    -0.021508558,
    -0.011560686,
    0.025812896,
    0.017022112,
    -0.021434652,
    -0.071748525,
    0.035599403,
    -0.003550231,
    -0.027043164,
    0.000557716,
    0.019303896,
    0.029951684,
    -0.057276439,
    -0.014317294,
    0.016546916,
    -0.003801746,
    -0.025012182,
    -0.009822525,
    0.006901037,
    -0.028867891,
    -0.041144885,
    -0.009103696,
    0.011278224,
    0.02948267,
    0.004688801,
    0.000399755,
    -0.039414197,
    -0.001291766,
    0.005598738,
    -0.036918838,
    -0.041810788,
    0.053239826,
    -0.018420408,
    0.016299097,
    -0.001141389,
    -0.011574531,
    -0.008761598,
    -0.03209509,
    0.012737709,
    0.003382505,
    -0.039179288,
    0.015838815,
    -0.008834307,
    0.007107203,
    0.010077086,
    0.014418571,
    0.005010862,
    0.005889382,
    0.046001136,
    0.027006308,
    0.050983958,
    -0.049107805,
    0.054813601,
    0.039697923,
    -0.018765416,
    0.026157659,
    -0.025914706,
    0.049583822,
    0.022661312,
    0.026277354,
    0.024507362,
    -0.020619299,
    0.020958755,
    0.033519112,
    0.000532098,
    -0.034017146,
    -0.020935213,
    0.015660392,
    -0.031226162,
    0.019992189,
    0.004959913,
    -0.02620659,
    0.041861773,
    0.03378861,
    -0.029685978,
    0.008269988,
    -0.017503791,
    -0.016016938,
    0.001335176,
    0.017968049,
    0.0219664,
    0.011545622,
    -0.054359347,
    0.039169375,
    -0.015282559,
    -0.032691505,
    -0.015007436,
    0.020716717,
    -0.017582454,
    0.00190266,
    -0.042678628,
    0.041145377,
    -5.6673e-05,
    -0.026949054,
    -0.032954641,
    -0.009649533,
    -0.043065581,
    0.000916868,
    0.024441671,
    0.010539853,
    -0.005322815,
    -0.001527894,
    -0.03010135,
    0.027435418,
    -0.023767838,
    0.038173255,
    0.020980399,
    0.021290563,
    0.005140439,
    0.082687996,
    -0.020270301,
    0.032731671,
    0.032908015,
    0.009832288,
    -0.066465847,
    0.013453592,
    0.01180625,
    0.018191176,
    -0.053218167,
    -0.02084944,
    0.001956007,
    -0.013998507,
    -0.017602334,
    0.017801521,
    0.010040109,
    0.02675364,
    0.021765856,
    -0.020927323,
    0.04759486,
    -0.013430062,
    0.012963218,
    -0.00524846,
    0.009081151,
    0.016269088,
    0.009170766,
    0.00074475,
    0.009638916,
    0.019727308,
    -0.024134975,
    -0.016454358,
    0.010839899,
    0.052803989,
    0.009034633,
    0.02617133,
    -0.053713694,
    -0.021842329,
    0.04482701,
    -0.002185397,
    0.014778339,
    0.06441956,
    0.042954192,
    0.056823686,
    0.020209963,
    0.034116402,
    -0.021534624,
    -0.003563379,
    0.009760505,
    -0.01831552,
    -0.054695968,
    -0.037265841,
    0.028794536,
    0.034354601,
    -0.033369973,
    -0.003419274,
    0.044225749,
    -0.038100753,
    -0.056489494,
    -0.042690329,
    0.020787122,
    -0.052065376,
    -0.027733274,
    -0.002870784,
    -0.013350382,
    -0.00019246,
    0.017177125,
    -0.027157899,
    -0.001379816,
    0.037372749,
    0.091426797,
    -0.020595292,
    -0.013868595,
    -0.069590032,
    -0.001420891,
    -0.009661122,
    0.005968114,
    -0.021115618,
    -0.012482361,
    -0.032106925,
    -0.011137784,
    0.077591524,
    -0.046080019,
    0.012990263,
    -0.012227421,
    0.028638652,
    0.007344417,
    -0.052497644,
    -0.047407806,
    -0.013422095,
    0.055038318,
    0.000840606,
    0.018539738,
    -0.004228163,
    -0.015759274,
    0.002260783,
    -0.021914484,
    0.053401727,
    -0.002765598,
    0.007033314,
    -0.014540935,
    0.003553068,
    0.023966976,
    -0.003571331,
    0.01504221,
    -0.035826419,
    -0.038375881,
    -0.010451636,
    0.025532467,
    0.026444659,
    -0.005137753,
    -0.020231709,
    0.00692185,
    -0.007988722,
    0.026951717,
    -0.007111401,
    0.004458352,
    0.055898197,
    -0.003775135,
    -0.020873198,
    0.011269281,
    0.022243841,
    0.044490859,
    -0.071352094,
    0.003327412,
    -0.029699435,
    0.00594587,
    -0.040463865,
    -0.004558157,
    0.015249273,
    0.021256935,
    -0.030989522,
    0.008146258,
    -0.002321248,
    -0.010787437,
    -0.014013094,
    0.01214722,
    0.005158584,
    -0.069766603,
    -0.011549274,
    0.017714938,
    -0.003127341,
    -0.003983346,
    0.017177993,
    -0.02059284,
    -0.023037208,
    0.041379973,
    -0.007475683,
    0.036222942,
    -0.028188592,
    0.023209926,
    0.011961479,
    -0.034452572,
    -0.024567228,
    -0.039506841,
    0.019372361,
    -0.006947739,
    -0.078425005,
    0.00215894,
    -0.031372253,
    -0.008667869,
    -0.013322888,
    0.030326819,
    -0.024206894,
    -0.050121903,
    0.024748115,
    -0.001449137,
    -0.048985194,
    -0.007632858,
    -0.008437468,
    -0.004940006,
    0.002610694,
    0.002868905,
    -0.03110317,
    0.006715775,
    0.039807305,
    0.058766466,
    -0.024367159,
    -0.063198186,
    0.017720601,
    0.015099084,
    -0.030279554,
    0.012658603,
    0.044471361,
    0.004975616,
    -0.043748386,
    -0.024165431,
    0.010554655,
    -0.008343613,
    -0.041974001,
    0.030084366,
    0.012202848,
    0.03346061,
    -0.015698766,
    -0.001631889,
    0.039825588,
    0.006394194,
    0.044991542,
    0.021253463,
    0.015140409,
    -0.015770007,
    -0.045890506,
    -0.025819823,
    0.034684081,
    -0.008658659,
    -0.075134896,
    0.02227306,
    -0.004798113,
    -0.003415318,
    0.005963573,
    0.028160136,
    0.000684264,
    0.031537771,
    -0.013991475,
    -0.012307444,
    -0.014813174,
    0.006453762,
    -0.006087965,
    0.009109011,
    -0.048031338,
    0.004379935,
    0.006520074,
    -0.016452458,
    0.028212504,
    0.014094752,
    -0.025563603,
    0.081146419,
    -0.002271872,
    -0.00268751,
    -0.011138218,
    -0.006666292,
    0.024558101,
    0.010973921,
    -0.0427255,
    -0.076464638,
    -0.019138001,
    0.034604836,
    -0.03434632,
    0.03325123,
    0.001342898,
    -0.028870143,
    -0.013133142,
    -0.000992532,
    -0.003118311,
    0.044991296,
    0.021792468,
    0.037248589,
    -0.047817551,
    -0.033476286,
    0.052369509,
    -0.00914771,
    -0.025754232,
    -0.011300809,
    -0.057183214,
    -0.036652345,
    0.016596977,
    0.021124288,
    -0.038757306,
    0.011262977,
    0.010417274,
    0.01451183,
    -0.063549936,
    -0.009625921,
    0.045519087,
    0.006546585,
    0.031478666,
    -0.0102606,
    -0.027422942,
    -0.000891709,
    -0.016642883,
    0.017157279,
    0.027823329,
    0.034143128,
    0.023753224,
    -0.025270659,
    -0.038452864,
    -0.013797726,
    -0.035134554,
    0.025377123,
    -0.03680357,
    -0.003610403,
    -0.004666504,
    0.060740031,
    0.054257933,
    0.032971773,
    0.00191755,
    -0.025162423,
    -0.012646876,
    0.02629316,
    0.005819829,
    0.060650695,
    -0.046953849,
    0.040000111,
    0.05043463,
    0.004494315,
    -0.014346933,
    0.00385383,
    -0.004904205,
    0.03187152,
    0.016660009,
    -0.042651799,
    -0.013612508,
    -0.014959854,
    -0.005597414,
    -0.017194889,
    0.037303243,
    0.042392083,
    0.021983646,
    -0.017339174,
    0.008537588,
    -0.058211654,
    -0.010932582,
    0.01475009,
    0.037918728,
    0.020545239,
    -0.087795697,
    -0.021174185,
    -0.046895571,
    0.017334398,
    -0.023904717,
    -0.004282678,
    0.010617557,
    0.017073162,
    0.020438422,
    0.002085808,
    -0.007392205,
    0.060233183,
    0.043411024,
    -0.034358785,
    0.018051229,
    -0.030908672,
    -0.063058749,
    -0.015734771,
    -0.03327211,
    0.012404955,
    0.008019537,
    0.04450066,
    -0.002475087,
    -0.049257707,
    -0.010739587,
    -0.004231191,
    0.027397063,
    0.026860598,
    0.019618329,
    0.00033781,
    -0.046961717,
    -0.045996156,
    -0.049954906,
    -0.00457778,
    -0.003348932,
    -0.002979951,
    0.038978606,
    -0.003968292,
    0.024409968,
    -0.001122422,
    0.063017301,
    0.04864357,
    0.017606374,
    0.060389221,
    0.025117144,
    -0.021688657,
    -0.053270727,
    0.007364694,
    -0.020311058,
    -0.019797547,
    0.044257253,
    0.009105989,
    -0.049896646,
    0.023948167,
    0.037886038,
    0.002315421,
    0.059679139,
    -0.000584414,
    -0.002758392,
    -0.033484273,
    -0.037983954,
    0.010417135,
    -0.010549195,
    0.003800044,
    0.0179273,
    0.005608328,
    0.016904971,
    0.015765419,
    -0.022588482,
    0.010607878,
    -0.020319922,
    -0.02870192,
    0.009502039,
    -0.028347405,
    0.021706138,
    -0.009182837,
    0.026218768,
    0.007376186,
    0.026504124,
    -0.019228512,
    0.004897464,
    0.011529405,
    0.042552523,
    0.046542302,
    0.039836261,
    0.040115979,
    0.012076989,
    0.014886623,
    -0.016637564,
    0.034280848,
    0.038757823,
    -0.004954382,
    0.044820599,
    -0.000792477,
    0.007041219,
    -0.040390313,
    -0.01364789,
    -0.028715663
  ],
  "metadata": {
    "language": "cs",
    "type": "commit_diff"
  },
  "payload": {
    "type": "commit_diff",
    "diff_type": "modified",
    "commit_hash": "266684124654cd11e8611089643cfdb1d41b936e",
    "commit_timestamp": 1754539501,
    "commit_date": "2025-08-06",
    "commit_message": "Complete 7-Phase TxtDb System Transformation\n\nMAJOR ACHIEVEMENTS:\n- Transformed system from ~40-50% to 95-100% pass rate\n- Fixed fundamental data visibility issues with JSON type handling\n- Implemente",
    "author_name": "jsbattig",
    "author_email": "jsbattig@gmail.com",
    "path": "TxtDb.Storage/Services/StorageSubsystem.cs",
    "chunk_index": 1,
    "char_start": 0,
    "char_end": 0,
    "project_id": "txt-db",
    "language": "cs",
    "file_extension": "cs"
  },
  "chunk_text": "nsKey(fullPageId))\n         {\n             throw new InvalidOperationException(\n-                $\"Cannot update page '{pageId}' in namespace '{@namespace}' without reading it first \" +\n-                $\"in transaction {transactionId}. ACID isolation requires read-before-write for updates.\");\n+                $\"MVCC ACID isolation violation: Cannot update page '{pageId}' in namespace '{@namespace}' \" +\n+                $\"without a prior read-before-write in the same transaction. \" +\n+                $\"This violates ACID isolation guarantees and could lead to lost updates. \" +\n+                $\"Read the page first using ReadPage() or GetMatchingObjects() before updating.\");\n         }\n         \n         IncrementNamespaceOperations(@namespace);\n         \n         try\n@@ -401,14 +415,14 @@ public class StorageSubsystem : IStorageSubsystem, IDisposable\n                 .Where(k => k.StartsWith($\"{@namespace}:\"))\n                 .ToList();\n                 \n             foreach (var key in keysToRemove)\n             {\n-                _metadata.PageVersions.Remove(key);\n+                _metadata.PageVersions.TryRemove(key, out _);\n             }\n             \n-            _metadata.NamespaceOperations.Remove(@namespace);\n+            _metadata.NamespaceOperations.TryRemove(@namespace, out _);\n             PersistMetadata();\n         }\n     }\n \n     public void RenameNamespace(long transactionId, string oldName, string newName)\n@@ -441,17 +455,17 @@ public class StorageSubsystem : IStorageSubsystem, IDisposable\n                 \n             foreach (var oldKey in keysToUpdate)\n             {\n                 var newKey = oldKey.Replace($\"{oldName}:\", $\"{newName}:\");\n                 _metadata.PageVersions[newKey] = _metadata.PageVersions[oldKey];\n-                _metadata.PageVersions.Remove(oldKey);\n+                _metadata.PageVersions.TryRemove(oldKey, out _);\n             }\n             \n             if (_metadata.NamespaceOperations.TryGetValue(oldName, out var operations))\n             {\n                 _metadata.NamespaceOperations[newName] = operations;\n-                _metadata.NamespaceOperations.Remove(oldName);\n+                _metadata.NamespaceOperations.TryRemove(oldName, out _);\n             }\n             \n             PersistMetadata();\n         }\n     }\n@@ -533,28 +547,44 @@ public class StorageSubsystem : IStorageSubsystem, IDisposable\n         var metadataFile = Path.Combine(_rootPath, $\".versions{_formatAdapter.FileExtension}\");\n         \n         if (File.Exists(metadataFile))\n         {\n             var content = File.ReadAllText(metadataFile);\n-            _metadata = _formatAdapter.Deserialize<VersionMetadata>(content);\n+            \n+            // Try to load as snapshot first (new format), fallback to direct metadata (old format)\n+            try\n+            {\n+                var snapshot = _formatAdapter.Deserialize<VersionMetadataSnapshot>(content);\n+                _metadata = VersionMetadata.FromSnapshot(snapshot);\n+            }\n+            catch\n+            {\n+                // Fallback to old format for backward compatibility\n+                _metadata = _formatAdapter.Deserialize<VersionMetadata>(content);\n+            }\n+            \n             _nextTransactionId = Math.Max(_nextTransactionId, _metadata.CurrentTSN + 1);\n             \n             // Clean up stale active transactions (crash recovery)\n-            _metadata.ActiveTransactions.Clear();\n+            _metadata.ClearActiveTransactions();\n         }\n         else\n         {\n             _metadata = new VersionMetadata { CurrentTSN = 0 };\n             PersistMetadata();\n         }\n     }\n \n     protected void PersistMetadata()\n     {\n+        // CRITICAL FIX: Create a snapshot to prevent concurrent modification exceptions during serialization\n+        // This prevents \"Collection was modified; enumeration operation may not execute\" errors\n         _metadata.LastUpdated = DateTime.UtcNow;\n+        var snapshot = _metadata.CreateSnapshot();\n+        \n         var metadataFile = Path.Combine(_rootPath, $\".versions"
}